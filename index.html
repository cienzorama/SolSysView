<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

    <head>

		<link rel="icon" type="image/vnd.microsoft.icon" href="favicon.ico">
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
        <title>SolSys View v0.403 21d 04/07/2023</title>

        <style>
            html, body {
                width: 100%;
                height: 100%;
                margin: 0;
                padding: 0;
					 overflow: hidden
            }

            #renderCanvas {
                width: 100%;
                height: 100%;
                touch-action: none;
            }
        </style>

		  <!--- Stable --->
		  <!---
        <script src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.6.2/dat.gui.min.js"></script>
        <script src="https://cdn.babylonjs.com/ammo.js"></script>
        <script src="https://cdn.babylonjs.com/cannon.js"></script>
        <script src="https://cdn.babylonjs.com/Oimo.js"></script>
        <script src="https://cdn.babylonjs.com/earcut.min.js"></script>
        <script src="https://cdn.babylonjs.com/babylon.js"></script>
        <script src="https://cdn.babylonjs.com/materialsLibrary/babylonjs.materials.min.js"></script>
        <script src="https://cdn.babylonjs.com/proceduralTexturesLibrary/babylonjs.proceduralTextures.min.js"></script>
        <script src="https://cdn.babylonjs.com/postProcessesLibrary/babylonjs.postProcess.min.js"></script>
        <script src="https://cdn.babylonjs.com/loaders/babylonjs.loaders.js"></script>
        <script src="https://cdn.babylonjs.com/serializers/babylonjs.serializers.min.js"></script>
        <script src="https://cdn.babylonjs.com/gui/babylon.gui.min.js"></script>
        <script src="https://cdn.babylonjs.com/inspector/babylon.inspector.bundle.js"></script>
		  --->

		  <!--- Latest alpha --->
		  
		<script src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.6.2/dat.gui.min.js"></script>
        <script src="https://preview.babylonjs.com/ammo.js"></script>
        <script src="https://preview.babylonjs.com/cannon.js"></script>
        <script src="https://preview.babylonjs.com/Oimo.js"></script>
        <script src="https://preview.babylonjs.com/earcut.min.js"></script>
        <script src="https://preview.babylonjs.com/babylon.js"></script>
        <script src="https://preview.babylonjs.com/materialsLibrary/babylonjs.materials.min.js"></script>
        <script src="https://preview.babylonjs.com/proceduralTexturesLibrary/babylonjs.proceduralTextures.min.js"></script>
        <script src="https://preview.babylonjs.com/postProcessesLibrary/babylonjs.postProcess.min.js"></script>
        <script src="https://preview.babylonjs.com/loaders/babylonjs.loaders.js"></script>
        <script src="https://preview.babylonjs.com/serializers/babylonjs.serializers.min.js"></script>
        <script src="https://preview.babylonjs.com/gui/babylon.gui.min.js"></script>
        <script src="https://preview.babylonjs.com/inspector/babylon.inspector.bundle.js"></script>
		  

		  <!--- Base de datos de figura de las constelaciones --->
		  <script src="js/stars_db.js"></script>
		

    </head>

   <body>

    <canvas id="renderCanvas" touch-action="none"></canvas> <!-- touch-action="none" for best results from PEP -->

	<p id="demo"></p>
   

    <script>
		//console.log("hola");
        const canvas = document.getElementById("renderCanvas"); // Get the canvas element
        const engine = new BABYLON.Engine(canvas, true); // Generate the BABYLON 3D engine
		//const engine = new BABYLON.WebGPUEngine(canvas);		  

		//Constantes de transformacion
		//entre grados horas y radianes		
		dtor=Math.PI/180.0;
		rtod=180.0/Math.PI;
		htor=Math.PI/12.0;
		rtoh=12.0/Math.PI;

		star_data();
		constellations_alpha=0.07;

		//Zona horaria
		utc_zone=1;
		//Automatica
		fake_date=new Date();
		utc_1=fake_date.getTimezoneOffset();
		utc_zone=parseInt(utc_1/60.0);


		//Comprobacion de si la visualizacion
		//es desde el planeta
		over_planet=0;

		//Correccion de la velocidad de la luz
		//de la posicion de cualquier objeto
		//Respecto a la tierra
		speed_light_correction=0;

		//Opcion del cambio de comportamiento
		//del Z buffer en la camara 2
		cam2_fov_limit=0.002;

		//Obtiene la fecha y la hora UTC actual
		var fecha=obtiene_fecha_actual();

		/*
		//Fechas de prueba
		//Eclipse Solar 2/7/2019		
		fecha[2]=2019;
		fecha[0]=2;
		fecha[1]=7;
		fecha[3]=19;
		fecha[4]=45;
			

		//Eclipse Solar 10/6/2021
		fecha[2]=2021;
		fecha[0]=10;
		fecha[1]=6;
		fecha[3]=11;
		fecha[4]=16;
		//
		*/


		/*		  
		fecha[0]=8;
		fecha[1]=11;
		fecha[2]=2022;
		fecha[3]=8;
		fecha[4]=03;
		*/


		alt_az_lock=1;
		
		control0=0;
	
		//Opcion del modo interactivo
		modo_interactivo=0;

		//Verificador de modificacion de controles
        //cuando la camara 2 esta activada y el
        //punto de vista es desde el planeta
		sobre_control=0;

		//Opcion de calculos precisos para La Luna	
		better_moon=0;
	
		//Calcula el dia juliano de la fecha actual	
		jd=calc_jd(fecha);
        //Corrige la fecha local en funcion de la zona horaria
		fecha_local=calc_fecha(jd+utc_zone/24.0);

		//Numero total de objetos
		n_objetos=10+1+2+4+10+5+3+1;
		//Numero de divisiones de la orbita
		n_seg_orbs=30;
		//Variables de segmentos de orbita
		seg_orbs=[];
		s_o_1=[];
		fill2DimensionsArray(seg_orbs, n_objetos, n_seg_orbs);
		fill2DimensionsArray(s_o_1, n_objetos, n_seg_orbs*3);

		grs_offset_angle=72;


		//Orientaciones de todos los objetos
		planet_w=[];
		planet_ori1=[];
		planet_ori2=[];
		planet_rotation();
	
		//Identificador de dependencia de cada objeto
		planet_parent=[-1,0,0,0,3,0,0,0,0,0,0,5,5,6,6,6,6,7,7,7,7,7,7,7,7,7,7,8,8,8,8,8,9,9,9,10];

		//Unidad astronimca en kilometros
		//Y su inversa
		ua_km=149597870.691;
		i_ua_km=1.0/ua_km;

		//Radios promedios de los objetos y su achatamiento polar
		planet_rad=[696342,2439.7,6051.8,6371,1737.4,3396.2,71492.0,60268.0,25559.0,24764.0,1188.3,11,7.5,1821,1560,2634,2410,531,252,531,561,763,2574,135,734,106,89,578.9,589.7,788.4,761.4,235.8,2707,340,418,606];
		planet_flat=[0,0,0,3.35e-3,0.0012,0.00589,0.06487,0.09796,0.0229,0.0171,0.005,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
		planet_pos=new Array(n_objetos);
		calc_all_planets(jd);

        calc_orbits();
		corrige_baricentro();

		//Estados iniciales del bucle
        //principal 
		actualiza=0;
		animacion=0;
		animacion_paso=0;
		cont=0;
		time_control=0;

		//Oblicuidad de la ecliptica para 2000.0
		tilt=23.4393/180.0*Math.PI;
		cos_tilt=Math.cos(tilt);
		sin_tilt=Math.sin(tilt);

		//Valores iniciales de los parametros
		//de la camara
		cam_radius=0;
		cam_alpha=0;
		cam_beta=0;
		cam_fov=0.8;

		//Variables de los calculos de sombras
		lines_umbra=[];
		lines_umbra_pos=[];
		lines_penunmbra=[];
		lines_penunmbra_pos=[];
		calculame_las_sombras=0;

		//Variable general de lineas
		lines=[];
		sph1=[];
		sph1_mat=[];

		//Texturas de los objetos
        //Imagen, bump y desplazamiento
		planet_text=[];
		planet_text_bump=[];
		planet_text_height=[];
		texture_list();
		
		//Intervalo de tiempo de animacion
		//[dias,horas,minutos,segundos]
		dtv=[0,0,2,0];
		dt_multiplier=dtv[0]+dtv[1]/24.0+dtv[2]/1440.0+dtv[3]/86400.0;
		cambia_dt=0;


		//Objeto inicial
		planet_id=3;
		//Nombre de cada objeto
		planet_names=["Sun","Mercury","Venus","Earth","Moon","Mars","Jupiter","Saturn","Uranus","Neptune","Pluto","Phobos","Deimos","Io","Europe","Ganymede","Calixto","Mimas","Enceladus","Thetys","Dione","Rhea","Titan","Hyperion","Japetus","Phoebe","Janus","Ariel","Umbriel","Titania","Oberon","Miranda","Triton","Nereid","Proteus","Charon"];
		planet_id_max=planet_names.length;
		
		//Otros estados relativos 
		//al buble principal
		change_date=0;
		change_date_mw=0;	
		change_focus=0;

		//Numero de satelites de cada cuerpo principal
		planet_sat_n=[0,0,0,1,0,2,4,10,5,3,1];

		//Objetos de cada cuerpo principal incluido el mismo
		planet_sat=[[0],[1],[2],[3,4],[4],[5,11,12],[6,13,14,15,16],[7,17,18,19,20,21,22,23,24,25,26],[8,27,28,29,30,31],[9,32,33,34],[10,35]];
		
		//Indicador seleccion del satelite
		planet_sat_id=0;
		
		//Transparencia de las orbitas
	     orbits_alpha=0.15;

		//Objetos de luces y generadores de sombras
        //declarados como globales para acceder a
		//ellos desde otras funciones
		light0=[];
		light=[];
		shadowGenerator=[];

		//Principales anillos de los cuerpos
        //planetarios
		saturn_ring=[];
		uranus_ring=[];
		neptune_ring=[];

		//Variable de posiciones de los
        //soles virtuales usados por el
        //generador de sombra
		fake_sun=[];

		  
		//Head
		head_coordinates=0;


		//Variables de posicionamiento local
        //orientacion y horizonte artificial

		//Ubicacion inicial
		lat=90*Math.PI/180;
		lon=0;
		lat_lon_alt=0;

		//Vector de orientacion
		upv=[];

		//Posicion del lugar de observacion
		lat_lon_pos=[];

		//Tamaño del marcador
		lat_lon_rad=0;

		//Vectores de orientacion local
		ouz=new BABYLON.Vector3(0,0,0);
		oue=new BABYLON.Vector3(0,0,0);
		oun=new BABYLON.Vector3(0,0,0);

		//Posicion de los segmentos del
        //horizonte local
		local_horizon_n=25;
		local_horizon=[];
		lines_local_horizon=[];
	
		//Proyeccion de los vectores locales
        //orientacion
		pro_z=0;
		pro_e=0;
		pro_n=0;


		c2t=new BABYLON.Vector3(0,0,0);

		ori_altaz=1;
		ori_equat=0;
		calc_lat_lon_pos();


		camara_fija=0;
		planet_point_id=-1;
		planet_point_sat_id=0;

		planet_lineo_id=0;
		planet_lined_id=0;
		planet_line_data=[];		  
		planet_line=[];
		planet_traj_data=[];
		planet_traj_n=0;
		planet_traj=[];

		mueve_todo();

		s_o_1=[];


        //
        const createScene = function () {
    
            const scene = new BABYLON.Scene(engine);
				scene.clearColor = new BABYLON.Color3(0.0, 0.0, 0.0);
				scene.ambientColor = new BABYLON.Color3(1, 1, 1);

				//--Esferas planetarias y líneas de las orbitas
				for (var ii=0;ii<n_objetos;ii++) {

					//..//lines[ii] =BABYLON.Mesh.CreateLines ( "orbital_line", seg_orbs[ii],scene,true);
					lines[ii] =BABYLON.MeshBuilder.CreateLines ( "orbital_line", {updatable: true,points: seg_orbs[ii]},scene,true);  
					lines[ii].color = new BABYLON.Color3(1, 1, 1);
					lines[ii].alpha=orbits_alpha;
					s_o_1[ii]=lines[ii].getVerticesData(BABYLON.VertexBuffer.PositionKind);
					lines[ii].freezeNormals();

					var prad=planet_rad[ii]*i_ua_km;

					var polys=10;
					if (ii<=10) polys=40;

					//..//sph1[ii]=BABYLON.Mesh.CreateSphere("planet_sphere",polys,2*prad,scene,true);
					sph1[ii]= BABYLON.MeshBuilder.CreateSphere("planet_sphere", {segments:polys, diameter:2*prad,updatable: true}, scene);
					sph1[ii].position=planet_pos[ii];
					sph1[ii].scaling.y=1-planet_flat[ii];
					sph1[ii].receiveShadows=true;
					sph1[ii].freezeNormals();
					sph1[ii].layerMask=4;
					sph1[ii].isBlocker=true;
					
					sph1_mat[ii] = new BABYLON.StandardMaterial("planet_material", scene);
					sph1_mat[ii].backFaceCulling = true;
					sph1_mat[ii].diffuseTexture = new BABYLON.Texture(planet_text[ii], scene);
					sph1_mat[ii].diffuseTexture.uScale=-1;
					sph1_mat[ii].diffuseTexture.vScale=-1;
					sph1_mat[ii].specularColor = new BABYLON.Color3(0,0,0);

					if (ii==0) {

						sph1_mat[ii].emissiveColor = new BABYLON.Color3(1, 1, 0.75);
						sph1_mat[ii].disableLighting = true;
						sph1[ii].isBlocker=false;

					}


					if (typeof planet_text_bump[ii] != 'undefined') {

						sph1_mat[ii].bumpTexture = new BABYLON.Texture(planet_text_bump[ii], scene);
						sph1_mat[ii].bumpTexture.uScale=-1;
						sph1_mat[ii].bumpTexture.vScale=-1;
						
						if (ii==4) sph1_mat[ii].bumpTexture.level=0.5;

					}


					if (typeof planet_text_height[ii] != 'undefined') {

						sph1[ii].applyDisplacementMap(planet_text_height[ii], -planet_rad[ii]*i_ua_km*0.5, planet_rad[ii]*i_ua_km*0.5);

						if (ii==25) {
							sph1[ii].applyDisplacementMap(planet_text_height[ii], planet_rad[ii]*i_ua_km*1, planet_rad[ii]*i_ua_km*1);
						}

					}


				sph1[ii].material = sph1_mat[ii];

				sph1[ii].rotation=new BABYLON.Vector3(0, 0, 0);

				//Diurnal motion
				sph1[ii].rotate(BABYLON.Axis.Y, planet_w[ii], BABYLON.Space.WORLD);
				sph1[ii].rotate(BABYLON.Axis.X, 0.0, BABYLON.Space.WORLD);
				sph1[ii].rotate(BABYLON.Axis.Z, 0.0, BABYLON.Space.WORLD);
				//Axial Tilt
				sph1[ii].rotate(BABYLON.Axis.X, planet_ori1[ii], BABYLON.Space.WORLD);
				sph1[ii].rotate(BABYLON.Axis.Y, planet_ori2[ii], BABYLON.Space.WORLD);
				sph1[ii].rotate(BABYLON.Axis.Z, 0.0, BABYLON.Space.WORLD);


				}
				//-------------------------


				//----
				planet_line_data[0]=new BABYLON.Vector3(NaN,NaN,NaN);
				planet_line_data[1]=new BABYLON.Vector3(NaN,NaN,NaN);
				//..//planet_line =BABYLON.Mesh.CreateLines ( "planet_line", planet_line_data,scene,true);
				planet_line =BABYLON.MeshBuilder.CreateLines ( "planet_line", {points: planet_line_data},scene,true);  
				planet_line.color = new BABYLON.Color3(1, 1, 1);
			    planet_line.alpha=1;

				planet_traj_n=2;
				planet_traj_data[0]=new BABYLON.Vector3(NaN,NaN,NaN);
				planet_traj_data[1]=new BABYLON.Vector3(NaN,NaN,NaN);
				//planet_traj=BABYLON.Mesh.CreateLines ( "planet_line", planet_traj_data,scene,true);
				planet_traj =BABYLON.MeshBuilder.CreateLines ( "planet_traj", {points: planet_traj_data},scene,true);  
				planet_traj.color=new BABYLON.Color3(1,0,0);
				planet_traj.alpha=1.0;
				//----	


				//--Constelaciones
				//..//star_lines =BABYLON.Mesh.CreateLines ( "Constaltion_lines", star_pos,scene);
				star_lines =BABYLON.MeshBuilder.CreateLines ( "Constellation_lines", {points: star_pos},scene,true);  
			    star_lines.color = new BABYLON.Color3(1, 1, 1);
			    star_lines.alpha=constellations_alpha;
				//--------------------

				//--Sombras
				calcula_sombras();
				lines_umbra=BABYLON.Mesh.CreateLines ( "Umbra_lines", lines_umbra_pos,scene); 
				lines_umbra.color = new BABYLON.Color3(1, 0, 0);
				lines_penumbra=BABYLON.Mesh.CreateLines ( "Penumbra_lines", lines_penumbra_pos,scene); 
				lines_penumbra.color = new BABYLON.Color3(1, 1, 0);
				//line_umbra.alpha=0.5;
				//--------------------


				//--horizonte local
				lines_local_horizon=BABYLON.Mesh.CreateLines ( "Horizon_lines", local_horizon,scene); 
				lines_local_horizon.color = new BABYLON.Color3(0, 1, 0);				
				lines_local_horizon.alpha=0.25;
				lines_local_horizon.isVisible=false;
				//-----------------


				//--Marca sobre el planeta				
				//..//sph2=BABYLON.Mesh.CreateSphere("planet_mark",10,lat_lon_rad*0+1,scene,true);
				sph2= BABYLON.MeshBuilder.CreateSphere("planet_mark", {segments:10, diameter:1}, scene,true);
				sph2.position=lat_lon_pos;
				sph2.scaling=new BABYLON.Vector3(lat_lon_rad,lat_lon_rad,lat_lon_rad);
				sph2_mat = new BABYLON.StandardMaterial("planet_mark_material", scene);
				sph2_mat.emissiveColor = new BABYLON.Color3(1, 0, 0);
				sph2_mat.diffuseColor = new BABYLON.Color3(1, 0, 0);
				//sph2_mat.specularColor = new BABYLON.Color3(0,0,0);
				sph2.material = sph2_mat;
				//----------------


				//--Esfera de brillo solar (glow)
				//..//glow_sph=BABYLON.Mesh.CreateSphere("glow_sphere",10,1.1*planet_rad[0]*i_ua_km,scene,true);
				glow_sph= BABYLON.MeshBuilder.CreateSphere("glow_sphere", {segments:10, diameter:1.1*planet_rad[0]*i_ua_km}, scene,true);
				glow_sph.position=sph1[0].position;
				glow_sph_mat = new BABYLON.StandardMaterial("glow_sphere_material", scene);
				glow_sph_mat.emissiveColor = new BABYLON.Color3(1, 1, 0.75);
				glow_sph_mat.diffuseColor = new BABYLON.Color3(1, 1, 0.75);
				glow_sph_mat.alpha=0.1;
				glow_sph.material = glow_sph_mat;
				//---------------


				//--Esferas generadoras de sombra para La Tierra y La Luna
				//..//fake_earth=BABYLON.Mesh.CreateSphere("fake_earth_sphere",10,2*0.75*planet_rad[3]*i_ua_km,scene,true);
				fake_earth= BABYLON.MeshBuilder.CreateSphere("fake_earth_sphere", {segments:10, diameter:2*0.75*planet_rad[3]*i_ua_km}, scene,true);
				fake_earth.position=planet_pos[3];
				fake_earth.receiveShadows=false;
				fake_earth.layerMask=0;
				//..//fake_moon=BABYLON.Mesh.CreateSphere("fake_moon_sphere",10,2*0.55*planet_rad[4]*i_ua_km,scene,true);
				fake_moon= BABYLON.MeshBuilder.CreateSphere("fake_moon_sphere", {segments:10, diameter:2*0.55*planet_rad[4]*i_ua_km}, scene,true);
				fake_moon.position=planet_pos[4];
				fake_moon.receiveShadows=false;
				fake_moon.layerMask=0;
				//-------------------				


				//--Anillo de Saturno----
				const saturn_ring_shape = [
					new BABYLON.Vector3(0.55*70000*i_ua_km, 0, 0),
					new BABYLON.Vector3(0.5*145000*i_ua_km, 0, 0),
				];

				saturn_ring = BABYLON.MeshBuilder.CreateLathe("saturn_ring_lathe", {shape: saturn_ring_shape, radius: 2, tessellation:64, sideOrientation: BABYLON.Mesh.DOUBLESIDE});
				saturn_ring.convertToFlatShadedMesh();
				saturn_ring.position=planet_pos[7];
				saturn_ring.receiveShadows=true;
				saturn_ring.layerMask=4;

				//planet_id=7;
				var saturn_ring_material = new BABYLON.StandardMaterial("saturn_ring_material", scene);
				saturn_ring_material.diffuseTexture = new BABYLON.Texture("images/saturn_ring_02.png", scene);
				var srct=0.02;
				//saturn_ring_material.ambientColor = new BABYLON.Color3(0.25+srct, 0.25+srct, 0.25-srct);
				saturn_ring_material.emissiveColor = new BABYLON.Color3(0.24+srct, 0.24+srct, 0.24-srct);

				saturn_ring_material.diffuseTexture.uScale=1;
				saturn_ring_material.diffuseTexture.vScale=1;
				saturn_ring_material.diffuseTexture.hasAlpha = true;
				saturn_ring_material.transparencyMode = BABYLON.Material.MATERIAL_ALPHATESTANDBLEND;
   				saturn_ring_material.useAlphaFromDiffuseTexture = true;
				saturn_ring.material = saturn_ring_material;
				
				//Axial Tilt
				saturn_ring.rotate(BABYLON.Axis.X, planet_ori1[7], BABYLON.Space.WORLD);
				saturn_ring.rotate(BABYLON.Axis.Y, planet_ori2[7], BABYLON.Space.WORLD);
				saturn_ring.rotate(BABYLON.Axis.Z, 0.0, BABYLON.Space.WORLD);
				//-------------------------



				//--Anillo de Urano----
				const uranus_ring_shape = [
					new BABYLON.Vector3(0.5*48000*i_ua_km, 0, 0),
					new BABYLON.Vector3(0.45*48000*i_ua_km, 0, 0),
				];

				uranus_ring = BABYLON.MeshBuilder.CreateLathe("uranus_ring_lathe", {shape: uranus_ring_shape, radius: 2, tessellation:64, sideOrientation: BABYLON.Mesh.DOUBLESIDE});
				saturn_ring.convertToFlatShadedMesh();
				uranus_ring.position=planet_pos[8];
				uranus_ring.receiveShadows=true;
				uranus_ring.layerMask=4;

				var uranus_ring_material = new BABYLON.StandardMaterial("uranus_ring_material", scene);
				uranus_ring_material.diffuseTexture = new BABYLON.Texture("images/uranus_ring_02.png", scene);
				uranus_ring_material.emissiveColor = new BABYLON.Color3(0.35, 0.35, 0.35);
				uranus_ring_material.diffuseTexture.uScale=1;
				uranus_ring_material.diffuseTexture.vScale=1;
				uranus_ring_material.diffuseTexture.hasAlpha = true;
				uranus_ring_material.transparencyMode = BABYLON.Material.MATERIAL_ALPHATESTANDBLEND;
   				uranus_ring_material.useAlphaFromDiffuseTexture = true;
				uranus_ring.material = uranus_ring_material;

				//Axial Tilt
				uranus_ring.rotate(BABYLON.Axis.X, planet_ori1[8], BABYLON.Space.WORLD);
				uranus_ring.rotate(BABYLON.Axis.Y, planet_ori2[8], BABYLON.Space.WORLD);
				uranus_ring.rotate(BABYLON.Axis.Z, 0.0, BABYLON.Space.WORLD);
				//-------------------------


				//--Anillo de Neptuno----
				const neptune_ring_shape = [
					new BABYLON.Vector3(0.55*45000*i_ua_km, 0, 0),
					new BABYLON.Vector3(0.5*63000*i_ua_km, 0, 0),
				];

				neptune_ring = BABYLON.MeshBuilder.CreateLathe("neptune_ring_lathe", {shape: neptune_ring_shape, radius: 2, tessellation:64, sideOrientation: BABYLON.Mesh.DOUBLESIDE});
				neptune_ring.convertToFlatShadedMesh();
				neptune_ring.position=planet_pos[9];
				neptune_ring.receiveShadows=true;
				neptune_ring.layerMask=4;

				var neptune_ring_material = new BABYLON.StandardMaterial("neptune_ring_material", scene);
				neptune_ring_material.diffuseTexture = new BABYLON.Texture("images/neptune_ring_02.png", scene);
				neptune_ring_material.emissiveColor = new BABYLON.Color3(0.15, 0.15, 0.15);
				neptune_ring_material.diffuseTexture.uScale=1;
				neptune_ring_material.diffuseTexture.vScale=1;
				neptune_ring_material.diffuseTexture.hasAlpha = true;
				neptune_ring_material.transparencyMode = BABYLON.Material.MATERIAL_ALPHATESTANDBLEND;
   				neptune_ring_material.useAlphaFromDiffuseTexture = true;
				neptune_ring.material = neptune_ring_material;
				//neptune_ring.material.alpha=0.75;
				
				//Axial Tilt
				neptune_ring.rotate(BABYLON.Axis.X, planet_ori1[9], BABYLON.Space.WORLD);
				neptune_ring.rotate(BABYLON.Axis.Y, planet_ori2[9], BABYLON.Space.WORLD);
				neptune_ring.rotate(BABYLON.Axis.Z, 0.0, BABYLON.Space.WORLD);
				//-------------------------

				
				//Plano de proyeccion de sombras (solo para pruebas)
			    //var ground = BABYLON.Mesh.CreateGround("ground", 100, 100, 1, scene, false);
				//ground.position.y=-1;

				/*
				var ss=1.001;
				var pp0=planet_pos.slice();
				var pp3=new BABYLON.Vector3(0, 0, 0);
				pp3.x=(pp0[planet_id].x-pp0[0].x)*ss+pp0[0].x;
				pp3.y=(pp0[planet_id].y-pp0[0].y)*ss+pp0[0].y;
				pp3.z=(pp0[planet_id].z-pp0[0].z)*ss+pp0[0].z;
				
				//const abstractPlane = BABYLON.Plane.FromPositionAndNormal(pp3[3],pp3[3]);
    			const plane = BABYLON.MeshBuilder.CreatePlane("plane", {height:0.01, width: 0.01});
				plane.rotate(BABYLON.Axis.Y, Math.atan2((planet_pos[planet_id].x-planet_pos[0].x),(planet_pos[planet_id].z-planet_pos[0].z)), BABYLON.Space.WORLD);				
				plane.position=pp3;
				plane.receiveShadows=true;
				*/


				//--Esfera celeste
				//..//const sky_sphere = BABYLON.Mesh.CreateSphere("sky_sphere", 32,10000.0, scene);
				const sky_sphere = BABYLON.MeshBuilder.CreateSphere("sky_sphere", {segments:32, diameter:10000}, scene);
				
				//sky_sphere.isPickable=false;				

				var sky_material = new BABYLON.StandardMaterial("sky_sphere_material", scene);
				sky_material.backFaceCulling = false;
				sky_material.disableLighting = true;
				sky_material.diffuseTexture = new BABYLON.Texture("images/sky_map_05_1.jpg", scene);
				sky_material.emissiveColor = new BABYLON.Color3(1, 1, 1);
				sky_material.diffuseTexture.uScale=1;
				sky_material.diffuseTexture.vScale=-1;
				sky_sphere.material = sky_material;

				sky_sphere.rotate(BABYLON.Axis.X, 0.0, BABYLON.Space.WORLD);
				sky_sphere.rotate(BABYLON.Axis.Y, Math.PI, BABYLON.Space.WORLD);
				sky_sphere.rotate(BABYLON.Axis.Z, 0.0, BABYLON.Space.WORLD);

				sky_sphere.rotate(BABYLON.Axis.X, tilt, BABYLON.Space.WORLD);
				sky_sphere.rotate(BABYLON.Axis.Y, 0.0, BABYLON.Space.WORLD);
				sky_sphere.rotate(BABYLON.Axis.Z, 0.0, BABYLON.Space.WORLD);
				//-------------------


				//--Camara Principal
				var center=planet_pos[planet_id];
            	camera = new BABYLON.ArcRotateCamera("main_camera", -Math.PI / 2, Math.PI / 2.5, 15, center);
                        
				camera.attachControl(canvas, true);
				camera.minZ=0.000001;
				camera.wheelPrecision = 50; 
				camera.lowerRadiusLimit=0.00001;
				camera.upperRadiusLimit=100*1;
				camera.radius=0.0003;
				camera.inputs.attached.pointers.buttons = [0];
				//camera.inputs.remove(camera.inputs.attached.mousewheel); // desactiva rueda

				camera.radius=planet_rad[planet_id]*i_ua_km*7;
				camera.lowerRadiusLimit=planet_rad[planet_id]*i_ua_km*4;

				//Desabilita zoom en moviles
				const input = camera.inputs.attached.pointers;
				input.multiTouchPanAndZoom = false;
				input.multiTouchPanning = false;
				//input.pinchZoom = false;	
				//---------------


				//--Camara secundaria 
				camera2=new BABYLON.UniversalCamera("secondary_camera",planet_pos[planet_id]);
				camera2.attachControl(canvas, true);
				camera2.position=planet_pos[planet_id];
				camera2.position=lat_lon_pos;
				camera2.target=planet_pos[0];
				camera2.minZ=0.000001;
				//camera2.inputs.attached.pointers.buttons = [0];

				camera2.upVector.copyFrom(upv);
				camera2.intertia=0;
				scene.addCamera(camera2);
				scene.activeCamera=camera;
				//const input2 = camera2.inputs;
				//console.log(input2);
				//-----------------------------     


				//--Luces
            	light0 = new BABYLON.PointLight("main_light", new BABYLON.Vector3(0, 0.0, 0));
				light0.position=planet_pos[0];
						

        		scene.materials.forEach(function (mtl) {
            	mtl.maxSimultaneousLights = 6;});
       

				fake_sun_n=5;
				fake_sun_list=[3,6,7,9,8];
				light=[];
				fake_sun_cone_angle=[];
				fake_sun_distance=[];

				for (var ii=0;ii<fake_sun_n;ii++) {

					var ii1=fake_sun_list[ii];

					if (ii1==3) {
						fake_sun_cone_angle[ii]=2.0*dtor;
						fake_sun_distance[ii]=0.1;
					}

					if (ii1==6) {
						fake_sun_cone_angle[ii]=2.0*dtor;
						fake_sun_distance[ii]=0.1;
					}
	
					if (ii1==7) {
						fake_sun_cone_angle[ii]=1.5*dtor;
						fake_sun_distance[ii]=0.1;
					}

					if (ii1==8) {
						fake_sun_cone_angle[ii]=2.0*dtor;
						fake_sun_distance[ii]=0.05;
					}

					if (ii1==9) {
						fake_sun_cone_angle[ii]=2.0*dtor;
						fake_sun_distance[ii]=0.1;
					}

					//..//
					/*
					var lp=new BABYLON.Vector3(0,0,0);
					var dx,dy,dz,d;
					dx=planet_pos[0].x-planet_pos[ii1].x;
					dy=planet_pos[0].y-planet_pos[ii1].y;
					dz=planet_pos[0].z-planet_pos[ii1].z;
					d=Math.sqrt(dx*dx+dy*dy+dz*dz);
					dx/=d;dy/=d;dz/=d;

					lp.x=planet_pos[ii1].x+fake_sun_distance[ii]*dx;
					lp.y=planet_pos[ii1].y+fake_sun_distance[ii]*dy;
					lp.z=planet_pos[ii1].z+fake_sun_distance[ii]*dz;
					*/
					//..//
				
					var pp0_pp1=planet_pos[0].subtract(planet_pos[ii1]);
					pp0_pp1.normalize();
					var lp=planet_pos[ii1].add(pp0_pp1.scale(fake_sun_distance[ii]));

					//..//var dire_sun=new BABYLON.Vector3(planet_pos[ii1].x-planet_pos[0].x,planet_pos[ii1].y-planet_pos[0].y,planet_pos[ii1].z-planet_pos[0].z);
					var dire_sun=planet_pos[ii1].subtract(planet_pos[0]);
					light[ii] = new BABYLON.SpotLight("planet_light", planet_pos[0], dire_sun, fake_sun_cone_angle[ii], 2, scene);
					light[ii].shadowAngleScale=1;
					light[ii].position=lp;
					light[ii].shadowMinZ=0.002;
					light[ii].shadowMaxZ =2;
					light[ii].range=1;
					light[ii].intensity=1;
					//console.log(light[ii].intensity);

				}
				//------------------------

				
				//--Brillo del Sol (Glow)
				var glo = new BABYLON.GlowLayer("glow_effect", scene, {
            	blurKernelSize: 100
        		});
				glo.addExcludedMesh(sky_sphere);
				glo.addExcludedMesh(saturn_ring);
				glo.addExcludedMesh(uranus_ring);
				glo.addExcludedMesh(neptune_ring);
				glo.addExcludedMesh(fake_sun);
				glo.addExcludedMesh(sph2);
				glo.intensity = 500;
				//-----------------------
				

				//--Lens Flare
				var lensFlareSystem = new BABYLON.LensFlareSystem("lensFlareSystem",sph1[0],scene);
				var flare00 = new BABYLON.LensFlare(0.1,0,new BABYLON.Color3(1, 1, 1),"images/flare.png",lensFlareSystem);
				var flare01 = new BABYLON.LensFlare(0.075, 0.5, new BABYLON.Color3(0.8, 0.56, 0.72), "images/flare3.png", lensFlareSystem);
				var flare03 = new BABYLON.LensFlare(0.15, 0.25, new BABYLON.Color3(0.95, 0.89, 0.71), "images/flare.png", lensFlareSystem);
				//-----------------------


				//--Generador de sombras
				shadowGenerator=[];
				for (var ii=0;ii<fake_sun_n;ii++) {
				
					var shadow_map_size=1024;
					if (fake_sun_list[ii]==3) shadow_map_size=2048;
					if (fake_sun_list[ii]==7) shadow_map_size=2048;	
			
					shadowGenerator[ii] = new BABYLON.ShadowGenerator(shadow_map_size, light[ii]);
					shadowGenerator[ii].forceBackFacesOnly=true;
					shadowGenerator[ii].darkness=0.0;
					shadowGenerator[ii].usePoissonSampling = true;
					shadowGenerator[ii].filter=6;
					shadowGenerator[ii].enableSoftTransparentShadow = true;
		 			shadowGenerator[ii].transparencyShadow = true;
				}
				//----------------------
				
				trastoca_luces();

	
						
				//GUI
				
				var advancedTexture = BABYLON.GUI.AdvancedDynamicTexture.CreateFullscreenUI("UI");
	
				var al_left=BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_LEFT;
				var al_top=BABYLON.GUI.Control.VERTICAL_ALIGNMENT_TOP;


				
				//Firma y otros datos
				//----------------------------------

					//Cuadro de opciones del selector de fecha y hora
					var personal_data_rect = new BABYLON.GUI.Rectangle();
					personal_data_rect.width = "180px";
					personal_data_rect.height = "80px";
					personal_data_rect.cornerRadius = 20;
					personal_data_rect.color = "black";
					personal_data_rect.thickness = 4;
					personal_data_rect.background = "black";
					personal_data_rect.top="0";
					personal_data_rect.left="0";
					personal_data_rect.horizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_RIGHT;
					personal_data_rect.verticalAlignment = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_BOTTOM;
					personal_data_rect.alpha=0.4;
					personal_data_rect.isVisible=1;		
					advancedTexture.addControl(personal_data_rect);


					//Texto de datos del programa
					var personal_data_text = new BABYLON.GUI.TextBlock();
					personal_data_text.text = "SolSyS View v0.403 21d\n © cienzorama@gmail.com, 2023";
					personal_data_text.color = "white";
					personal_data_text.fontSize = 10;
					personal_data_text.top="20px";
					personal_data_text.horizontalAlignment = al_left;
					personal_data_text.verticalAlignment = al_top;				
					personal_data_rect.addControl(personal_data_text);


					//Texto de la filiación
					var bjs_text = new BABYLON.GUI.TextBlock();
					bjs_text.text = "Powered by";
					bjs_text.color = "white";
					bjs_text.fontSize = 14;
					bjs_text.top="-15px";
					bjs_text.left="-10px";
					bjs_text.horizontalAlignment = al_left;
					bjs_text.verticalAlignment = al_top;				
					personal_data_rect.addControl(bjs_text);


					//Logo de babylon.js
					var bjs_image = new BABYLON.GUI.Image("but", "images/babylonjs_logo.png");
					bjs_image.width = "35px";
					bjs_image.height = "35px";
					bjs_image.top="3px";
					bjs_image.left="120px";
					bjs_image.horizontalAlignment = al_left;
					bjs_image.verticalAlignment = al_top;	
					personal_data_rect.addControl(bjs_image);

				//----------------------------------


				//Datos de apuntado de las camaras
				//---------------------------

					//Rectangulo de datos de orientacion de la camaras
					var head_data_rect = new BABYLON.GUI.Rectangle();
					head_data_rect.width = "280px";
					head_data_rect.height = "40px";
					head_data_rect.cornerRadius = 20;
					head_data_rect.color = "black";
					head_data_rect.thickness = 4;
					head_data_rect.background = "maroon";
					head_data_rect.top="5px";
					head_data_rect.left="0px";
					head_data_rect.horizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_CENTER;
					head_data_rect.verticalAlignment = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_TOP;
					head_data_rect.alpha=0.4;
					head_data_rect.isVisible=0;		
					advancedTexture.addControl(head_data_rect);


					//Calculos de orientacion de la camara
					/*
					var vcam=camera.target.subtract(camera.position);
					vcam.normalize();
		
					var cam_ecl_lon=Math.atan2(vcam.z,vcam.x);
					var cam_pl=Math.sqrt(vcam.x*vcam.x+vcam.z*vcam.z);
					var cam_ecl_lat=Math.atan(vcam.y/cam_pl);

					var cam_ra=Math.atan2((Math.sin(cam_ecl_lon)*cos_tilt-Math.tan(cam_ecl_lat)*sin_tilt),Math.cos(cam_ecl_lon));
					var cam_de=Math.asin(Math.sin(cam_ecl_lat)*cos_tilt+Math.cos(cam_ecl_lat)*sin_tilt*Math.sin(cam_ecl_lon));

					cam_ra=cam_ra*12.0/Math.PI;
					cam_de=cam_de*180.0/Math.PI;

					if (cam_ra<0) cam_ra+=24;

					cam_ra=Math.floor(cam_ra*100.0)/100;
					cam_de=Math.floor(cam_de*100.0)/100;
					*/

				

					//Texto de datos de orientacion de las camaras
					var head_text = new BABYLON.GUI.TextBlock();
					//head_text.text = "RA " + cam_ra.toString() + "  DEC " + cam_de.toString() + " | Alt " + "--.-" + " Az " + "--.-";
					head_text.text = " --.--";				
					head_text.color = "white";
					head_text.fontSize = 14;
					head_text.top="0px";
					head_text.left="0px";
					head_text.horizontalAlignment = al_left;
					head_text.verticalAlignment = al_top;				
					head_data_rect.addControl(head_text);

				//--------------------------------



				//------------
				//Cuadro de dialogo de seleccion de fecha y hora

					//Cuadro de opciones del selector de fecha y hora
					var datetime_rect = new BABYLON.GUI.Rectangle();
					datetime_rect.width = "500px";
					datetime_rect.height = "250px";
					datetime_rect.cornerRadius = 20;
					datetime_rect.color = "Orange";
					datetime_rect.thickness = 4;
					datetime_rect.background = "green";
					datetime_rect.top="0";
					datetime_rect.left="0";
					datetime_rect.horizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_CENTER;
					datetime_rect.verticalAlignment = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_BOTTOM;
					datetime_rect.alpha=0.35;
					datetime_rect.isVisible=0;		
					advancedTexture.addControl(datetime_rect);


					//Boton de apertura y cierre de opciones del selector de fecha y hora
					var datetime_button = BABYLON.GUI.Button.CreateSimpleButton("datetime_button"," None ");
					datetime_button.width = "160px";
					datetime_button.height = "30px";
					datetime_button.color = "white";
					datetime_button.cornerRadius=10;
					datetime_button.background = "blue";
					datetime_button.top="10px";
					datetime_button.left="20px";
					datetime_button.horizontalAlignment = al_left;
					datetime_button.verticalAlignment =	al_top;
					datetime_button.textBlock.text="Date & TIme";						
					datetime_button.onPointerClickObservable.add (function() {

						selector_rect.isVisible=0;
						point_to_rect.isVisible=0;
						dt_rect.isVisible=0;
						opts_rect.isVisible=0;
						if (datetime_rect.isVisible==1) {datetime_rect.isVisible=0;} else {datetime_rect.isVisible=1;}

					});
					advancedTexture.addControl(datetime_button);


					//Texto de la fecha y la hora en la pantalla principal
					var datetime_text = new BABYLON.GUI.TextBlock();
					datetime_text.text = fecha[0].toString().padStart(2,"0") + " " +
												fecha[1].toString().padStart(2,"0") + " " +
												fecha[2].toString() + "  " + "\n" +
												fecha[3].toString().padStart(2,"0") + ":" +
												fecha[4].toString().padStart(2,"0") + ":" +
												fecha[5].toString().padStart(2,"0");
					datetime_text.color = "white";
					datetime_text.top="50px";
					datetime_text.left="00px";
					datetime_text.height="60px";
					datetime_text.width = "190px";
					datetime_text.fontSize=30;
					datetime_text.horizontalAlignment = al_left;
					datetime_text.verticalAlignment = al_top;				
					advancedTexture.addControl(datetime_text);



					//Texto de la fecha y la hora LOCAL en la pantalla principal
					var localtime_text = new BABYLON.GUI.TextBlock();
					localtime_text.text = fecha_local[0].toString().padStart(2,"0") + " " +
												fecha_local[1].toString().padStart(2,"0") + " " +
												fecha_local[2].toString() + " " + 
												fecha_local[3].toString().padStart(2,"0") + ":" +
												fecha_local[4].toString().padStart(2,"0") + ":" +
												fecha_local[5].toString().padStart(2,"0");
					localtime_text.color = "yellow";
					localtime_text.top="100px";
					localtime_text.left="05px";
					localtime_text.height="60px";
					localtime_text.width = "190px";
					localtime_text.fontSize=16;
					localtime_text.horizontalAlignment = al_left;
					localtime_text.verticalAlignment = al_top;				
					advancedTexture.addControl(localtime_text);



					//Texto de la fecha y la hora en el cuadro de dialogo
					var datetime_rect_text = new BABYLON.GUI.TextBlock();
					datetime_rect_text.text = fecha[0].toString().padStart(2,"0") + "  " +
												fecha[1].toString().padStart(2,"0") + "  " +
												fecha[2].toString() + "  " +
												fecha[3].toString().padStart(2,"0") + " : " +
												fecha[4].toString().padStart(2,"0") + " : " +
												fecha[5].toString().padStart(2,"0");
					datetime_rect_text.color = "white";
					datetime_rect_text.top="70px";
					datetime_rect_text.left="20px";
					datetime_rect_text.height="60px";
					datetime_rect_text.width = "450px";
					datetime_rect.fontSize = 40;
					datetime_rect_text.horizontalAlignment = al_left;
					datetime_rect_text.verticalAlignment = al_top;				
					datetime_rect.addControl(datetime_rect_text);


					//Boton de dia +1
					var dp_button = BABYLON.GUI.Button.CreateSimpleButton("dp_button","+");
					dp_button.width = "40px";
					dp_button.height = "60px";
					dp_button.color = "white";
					dp_button.cornerRadius=10;
					dp_button.background = "orange";
					dp_button.top="10px";
					dp_button.left="25px";
					dp_button.horizontalAlignment = al_left;
					dp_button.verticalAlignment =	al_top;					
					dp_button.onPointerClickObservable.add (function() {fecha[0]++;change_date_mw=1;});
					dp_button.onWheelObservable.add(function(evt) {
						if (evt.y<0) {fecha[0]++;change_date_mw=1;}
						if (evt.y>0) {fecha[0]--;change_date_mw=1;}  
					});	
					datetime_rect.addControl(dp_button);


					//Boton de dia -1
					var dm_button = BABYLON.GUI.Button.CreateSimpleButton("dm_button","-");
					dm_button.width = "40px";
					dm_button.height = "60px";
					dm_button.color = "white";
					dm_button.cornerRadius=10;
					dm_button.background = "orange";
					dm_button.top="130px";
					dm_button.left="25px";
					dm_button.horizontalAlignment = al_left;
					dm_button.verticalAlignment =	al_top;					
					dm_button.onPointerClickObservable.add (function() {fecha[0]--;change_date_mw=1;});
					dm_button.onWheelObservable.add(function(evt) {
						if (evt.y<0) {fecha[0]++;change_date_mw=1;}
						if (evt.y>0) {fecha[0]--;change_date_mw=1;}  
					});					
					datetime_rect.addControl(dm_button);


					//Boton de mes +1
					var mp_button = BABYLON.GUI.Button.CreateSimpleButton("mp_button","+");
					mp_button.width = "40px";
					mp_button.height = "60px";
					mp_button.color = "white";
					mp_button.cornerRadius=10;
					mp_button.background = "orange";
					mp_button.top="10px";
					mp_button.left="90px";
					mp_button.horizontalAlignment = al_left;
					mp_button.verticalAlignment =	al_top;					
					mp_button.onPointerClickObservable.add (function() {fecha[1]++;change_date_mw=1;});
					mp_button.onWheelObservable.add(function(evt) {
						if (evt.y<0) {fecha[1]++;change_date_mw=1;}
						if (evt.y>0) {fecha[1]--;change_date_mw=1;}  
					});	
					datetime_rect.addControl(mp_button);


					//Boton de mes -1
					var mm_button = BABYLON.GUI.Button.CreateSimpleButton("mm_button","-");
					mm_button.width = "40px";
					mm_button.height = "60px";
					mm_button.color = "white";
					mm_button.cornerRadius=10;
					mm_button.background = "orange";
					mm_button.top="130px";
					mm_button.left="90px";
					mm_button.horizontalAlignment = al_left;
					mm_button.verticalAlignment =	al_top;					
					mm_button.onPointerClickObservable.add (function() {fecha[1]--;change_date_mw=1;});
					mm_button.onWheelObservable.add(function(evt) {
						if (evt.y<0) {fecha[1]++;change_date_mw=1;}
						if (evt.y>0) {fecha[1]--;change_date_mw=1;}  
					});	
					datetime_rect.addControl(mm_button);


					//Boton de ano +1
					var yp_button = BABYLON.GUI.Button.CreateSimpleButton("yp_button","+");
					yp_button.width = "80px";
					yp_button.height = "60px";
					yp_button.color = "white";
					yp_button.cornerRadius=10;
					yp_button.background = "orange";
					yp_button.top="10px";
					yp_button.left="160px";
					yp_button.horizontalAlignment = al_left;
					yp_button.verticalAlignment =	al_top;					
					yp_button.onPointerClickObservable.add (function() {fecha[2]++;change_date_mw=1;});
					yp_button.onWheelObservable.add(function(evt) {
						if (evt.y<0) {fecha[2]++;change_date_mw=1;}
						if (evt.y>0) {fecha[2]--;change_date_mw=1;}  
					});	
					datetime_rect.addControl(yp_button);


					//Boton de ano -1
					var ym_button = BABYLON.GUI.Button.CreateSimpleButton("ym_button","-");
					ym_button.width = "80px";
					ym_button.height = "60px";
					ym_button.color = "white";
					ym_button.cornerRadius=10;
					ym_button.background = "orange";
					ym_button.top="130px";
					ym_button.left="160px";
					ym_button.horizontalAlignment = al_left;
					ym_button.verticalAlignment =	al_top;					
					ym_button.onPointerClickObservable.add (function() {fecha[2]--;change_date_mw=1;});
					ym_button.onWheelObservable.add(function(evt) {
						if (evt.y<0) {fecha[2]++;change_date_mw=1;}
						if (evt.y>0) {fecha[2]--;change_date_mw=1;}  
					});	
					datetime_rect.addControl(ym_button);


					//Boton de hora +1
					var hp_button = BABYLON.GUI.Button.CreateSimpleButton("hp_button","+");
					hp_button.width = "40px";
					hp_button.height = "60px";
					hp_button.color = "white";
					hp_button.cornerRadius=10;
					hp_button.background = "orange";
					hp_button.top="10px";
					hp_button.left="270px";
					hp_button.horizontalAlignment = al_left;
					hp_button.verticalAlignment =	al_top;					
					hp_button.onPointerClickObservable.add (function() {fecha[3]++;change_date_mw=1;});
					hp_button.onWheelObservable.add(function(evt) {
						if (evt.y<0) {fecha[3]++;change_date_mw=1;}
						if (evt.y>0) {fecha[3]--;change_date_mw=1;}  
					});	
					datetime_rect.addControl(hp_button);


					//Boton de hora -1
					var hm_button = BABYLON.GUI.Button.CreateSimpleButton("hm_button","-");
					hm_button.width = "40px";
					hm_button.height = "60px";
					hm_button.color = "white";
					hm_button.cornerRadius=10;
					hm_button.background = "orange";
					hm_button.top="130px";
					hm_button.left="270px";
					hm_button.horizontalAlignment = al_left;
					hm_button.verticalAlignment =	al_top;					
					hm_button.onPointerClickObservable.add (function() {fecha[3]--;change_date_mw=1;});
					hm_button.onWheelObservable.add(function(evt) {
						if (evt.y<0) {fecha[3]++;change_date_mw=1;}
						if (evt.y>0) {fecha[3]--;change_date_mw=1;}  
					});
					datetime_rect.addControl(hm_button);


					//Boton de minuto +1
					var mip_button = BABYLON.GUI.Button.CreateSimpleButton("mip_button","+");
					mip_button.width = "40px";
					mip_button.height = "60px";
					mip_button.color = "white";
					mip_button.cornerRadius=10;
					mip_button.background = "orange";
					mip_button.top="10px";
					mip_button.left="350px";
					mip_button.horizontalAlignment = al_left;
					mip_button.verticalAlignment =	al_top;					
					mip_button.onPointerClickObservable.add (function() {fecha[4]++;change_date_mw=1;});
					mip_button.onWheelObservable.add(function(evt) {
						if (evt.y<0) {fecha[4]++;change_date_mw=1;}
						if (evt.y>0) {fecha[4]--;change_date_mw=1;}  
					});
					datetime_rect.addControl(mip_button);


					//Boton de minuto -1
					var mim_button = BABYLON.GUI.Button.CreateSimpleButton("mim_button","-");
					mim_button.width = "40px";
					mim_button.height = "60px";
					mim_button.color = "white";
					mim_button.cornerRadius=10;
					mim_button.background = "orange";
					mim_button.top="130px";
					mim_button.left="350px";
					mim_button.horizontalAlignment = al_left;
					mim_button.verticalAlignment =	al_top;					
					mim_button.onPointerClickObservable.add (function() {fecha[4]--;change_date_mw=1;});
					mim_button.onWheelObservable.add(function(evt) {
						if (evt.y<0) {fecha[4]++;change_date_mw=1;}
						if (evt.y>0) {fecha[4]--;change_date_mw=1;}  
					});
					datetime_rect.addControl(mim_button);


					//Boton de segundo +1
					var sep_button = BABYLON.GUI.Button.CreateSimpleButton("sep_button","+");
					sep_button.width = "40px";
					sep_button.height = "60px";
					sep_button.color = "white";
					sep_button.cornerRadius=10;
					sep_button.background = "orange";
					sep_button.top="10px";
					sep_button.left="423px";
					sep_button.horizontalAlignment = al_left;
					sep_button.verticalAlignment =	al_top;					
					sep_button.onPointerClickObservable.add (function() {fecha[5]++;change_date_mw=1;});
					sep_button.onWheelObservable.add(function(evt) {
						if (evt.y<0) {fecha[5]++;change_date_mw=1;}
						if (evt.y>0) {fecha[5]--;change_date_mw=1;}  
					});
					datetime_rect.addControl(sep_button);


					//Boton de segundo -1
					var sem_button = BABYLON.GUI.Button.CreateSimpleButton("sem_button","-");
					sem_button.width = "40px";
					sem_button.height = "60px";
					sem_button.color = "white";
					sem_button.cornerRadius=10;
					sem_button.background = "orange";
					sem_button.top="130px";
					sem_button.left="423px";
					sem_button.horizontalAlignment = al_left;
					sem_button.verticalAlignment =	al_top;					
					sem_button.onPointerClickObservable.add (function() {fecha[5]--;change_date_mw=1;});
					sem_button.onWheelObservable.add(function(evt) {
						if (evt.y<0) {fecha[5]++;change_date_mw=1;}
						if (evt.y>0) {fecha[5]--;change_date_mw=1;}  
					});
					datetime_rect.addControl(sem_button);



					//Boton cerrar dialogo de cambio de fecha y hora
					var datetime_close_button = BABYLON.GUI.Button.CreateSimpleButton("datetime_close_button"," Close ");
					datetime_close_button.width = "300px";
					datetime_close_button.height = "40px";
					datetime_close_button.color = "black";
					datetime_close_button.background = "white";
					datetime_close_button.top="198px";
					datetime_close_button.left="10px";
					datetime_close_button.cornerRadius=10;
					datetime_close_button.fontSize=24;
					datetime_close_button.horizontalAlignment = al_left;
					datetime_close_button.verticalAlignment =	al_top;						
					datetime_close_button.onPointerClickObservable.add (function() {
						datetime_rect.isVisible=0;
					});
					datetime_rect.addControl(datetime_close_button);


					//Boton cerrar dialogo de cambio de fecha y hora
					var now_button = BABYLON.GUI.Button.CreateSimpleButton("now_button"," NOW! ");
					now_button.width = "112px";
					now_button.height = "40px";
					now_button.color = "white";
					now_button.background = "blue";
					now_button.top="198px";
					now_button.left="350px";
					now_button.cornerRadius=10;
					now_button.fontSize=24;
					now_button.horizontalAlignment = al_left;
					now_button.verticalAlignment =	al_top;						
					now_button.onPointerClickObservable.add (function() {
						fecha=obtiene_fecha_actual();
						change_date_mw=1;	
					});
					datetime_rect.addControl(now_button);

				//------------



				//Texto del dia juliano de efemerides
				var jd_text = new BABYLON.GUI.TextBlock();
				jd_text.text = "JD  "+ (Math.floor(jd*100000)/100000).toString();
				jd_text.color = "white";
				//text1.fontSize = 24;
				jd_text.top="140px";
				jd_text.left="10px";
				jd_text.height="30px";
				jd_text.width = "180px";
				jd_text.horizontalAlignment = al_left;
				jd_text.verticalAlignment = al_top;				
				advancedTexture.addControl(jd_text);


				//-----------
				//Intervalo de tiempo


				//Cuadro de opciones de modificacion del intervalo
				var dt_rect = new BABYLON.GUI.Rectangle();
				dt_rect.width = "500px";
				dt_rect.height = "260px";
				dt_rect.cornerRadius = 20;
				dt_rect.color = "Orange";
				dt_rect.thickness = 4;
				dt_rect.background = "green";
				dt_rect.top="0";
				dt_rect.left="0";
				dt_rect.horizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_CENTER;
				dt_rect.verticalAlignment = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_BOTTOM;
				dt_rect.alpha=0.35;
				dt_rect.isVisible=0;		
				advancedTexture.addControl(dt_rect);


				//Boton de apertura y cierre de modificacion de intervalo
				var dt_button = BABYLON.GUI.Button.CreateSimpleButton("interval_button"," None ");
				dt_button.width = "160px";
				dt_button.height = "30px";
				dt_button.color = "white";
				dt_button.cornerRadius=10;
				dt_button.background = "purple";
				dt_button.top="170px";
				dt_button.left="20px";
				dt_button.horizontalAlignment = al_left;
				dt_button.verticalAlignment =	al_top;
				dt_button.textBlock.text="Animation";						
				dt_button.onPointerClickObservable.add (function() {

					point_to_rect.isVisible=0;
					datetime_rect.isVisible=0;
					selector_rect.isVisible=0;
					opts_rect.isVisible=0;
					if (dt_rect.isVisible==1) {dt_rect.isVisible=0;} else {dt_rect.isVisible=1;}

				});
				advancedTexture.addControl(dt_button);


				//Texto de Tiempo de intervalo
				var dt_rect_text = new BABYLON.GUI.TextBlock();
				dt_rect_text.text =  dtv[0].toString().padStart(3,"0") + "  " +
											dtv[1].toString().padStart(2,"0") + " : " +
											dtv[2].toString().padStart(2,"0") + " : " +
											dtv[3].toString().padStart(2,"0");
				dt_rect_text.color = "white";
				dt_rect_text.top="70px";
				dt_rect_text.left="10px";
				dt_rect_text.height="60px";
				dt_rect_text.width = "310px";
				dt_rect_text.fontSize=40;
				dt_rect_text.horizontalAlignment = al_left;
				dt_rect_text.verticalAlignment = al_top;				
				dt_rect.addControl(dt_rect_text);


				//Boton de dia +1 de intervalo
				var dt_dp_button = BABYLON.GUI.Button.CreateSimpleButton("dt_dp_button","+");
				dt_dp_button.width = "65px";
				dt_dp_button.height = "60px";
				dt_dp_button.color = "white";
				dt_dp_button.cornerRadius=10;
				dt_dp_button.background = "orange";
				dt_dp_button.top="10px";
				dt_dp_button.left="25px";
				dt_dp_button.horizontalAlignment = al_left;
				dt_dp_button.verticalAlignment =	al_top;
				dt_dp_button.fontSize=40;						
				dt_dp_button.onPointerClickObservable.add (function() {dtv[0]++;cambia_dt=1;});
				dt_dp_button.onWheelObservable.add(function(evt) {
					if (evt.y<0) {dtv[0]++;cambia_dt=1;}
					if (evt.y>0) {dtv[0]--;cambia_dt=1;}  
				});	
				dt_rect.addControl(dt_dp_button);


				//Boton de dia -1 de intervalo
				var dt_dm_button = BABYLON.GUI.Button.CreateSimpleButton("dt_dm_button","-");
				dt_dm_button.width = "65px";
				dt_dm_button.height = "60px";
				dt_dm_button.color = "white";
				dt_dm_button.cornerRadius=10;
				dt_dm_button.background = "orange";
				dt_dm_button.top="130px";
				dt_dm_button.left="25px";
				dt_dm_button.horizontalAlignment = al_left;
				dt_dm_button.verticalAlignment =	al_top;
				dt_dm_button.fontSize=40;						
				dt_dm_button.onPointerClickObservable.add (function() {dtv[0]--;cambia_dt=1;});
				dt_dm_button.onWheelObservable.add(function(evt) {
					if (evt.y<0) {dtv[0]++;cambia_dt=1;}
					if (evt.y>0) {dtv[0]--;cambia_dt=1;}  
				});					
				dt_rect.addControl(dt_dm_button);


				//Boton de hora +1 de intervalo
				var dt_hp_button = BABYLON.GUI.Button.CreateSimpleButton("dt_hp_button","+");
				dt_hp_button.width = "40px";
				dt_hp_button.height = "60px";
				dt_hp_button.color = "white";
				dt_hp_button.cornerRadius=10;
				dt_hp_button.background = "orange";
				dt_hp_button.top="10px";
				dt_hp_button.left="115px";
				dt_hp_button.horizontalAlignment = al_left;
				dt_hp_button.verticalAlignment =	al_top;
				dt_hp_button.fontSize=40;						
				dt_hp_button.onPointerClickObservable.add (function() {dtv[1]++;cambia_dt=1;});
				dt_hp_button.onWheelObservable.add(function(evt) {
					if (evt.y<0) {dtv[1]++;cambia_dt=1;}
					if (evt.y>0) {dtv[1]--;cambia_dt=1;}  
				});	
				dt_rect.addControl(dt_hp_button);


				//Boton de hora -1 de intervalo
				var dt_hm_button = BABYLON.GUI.Button.CreateSimpleButton("dt_hm_button","-");
				dt_hm_button.width = "40px";
				dt_hm_button.height = "60px";
				dt_hm_button.color = "white";
				dt_hm_button.cornerRadius=10;
				dt_hm_button.background = "orange";
				dt_hm_button.top="130px";
				dt_hm_button.left="115px";
				dt_hm_button.horizontalAlignment = al_left;
				dt_hm_button.verticalAlignment =	al_top;
				dt_hm_button.fontSize=40;						
				dt_hm_button.onPointerClickObservable.add (function() {dtv[1]--;cambia_dt=1;});
				dt_hm_button.onWheelObservable.add(function(evt) {
					if (evt.y<0) {dtv[1]++;cambia_dt=1;}
					if (evt.y>0) {dtv[1]--;cambia_dt=1;}  
				});					
				dt_rect.addControl(dt_hm_button);


				//Boton de minuto +1 de intervalo
				var dt_mp_button = BABYLON.GUI.Button.CreateSimpleButton("dt_mp_button","+");
				dt_mp_button.width = "40px";
				dt_mp_button.height = "60px";
				dt_mp_button.color = "white";
				dt_mp_button.cornerRadius=10;
				dt_mp_button.background = "orange";
				dt_mp_button.top="10px";
				dt_mp_button.left="195px";
				dt_mp_button.horizontalAlignment = al_left;
				dt_mp_button.verticalAlignment =	al_top;
				dt_mp_button.fontSize=40;						
				dt_mp_button.onPointerClickObservable.add (function() {dtv[2]++;cambia_dt=1;});
				dt_mp_button.onWheelObservable.add(function(evt) {
					if (evt.y<0) {dtv[2]++;cambia_dt=1;}
					if (evt.y>0) {dtv[2]--;cambia_dt=1;}  
				});	
				dt_rect.addControl(dt_mp_button);


				//Boton de minuto -1 de intervalo
				var dt_mm_button = BABYLON.GUI.Button.CreateSimpleButton("dt_mm_button","-");
				dt_mm_button.width = "40px";
				dt_mm_button.height = "60px";
				dt_mm_button.color = "white";
				dt_mm_button.cornerRadius=10;
				dt_mm_button.background = "orange";
				dt_mm_button.top="130px";
				dt_mm_button.left="195px";
				dt_mm_button.horizontalAlignment = al_left;
				dt_mm_button.verticalAlignment =	al_top;
				dt_mm_button.fontSize=40;						
				dt_mm_button.onPointerClickObservable.add (function() {dtv[2]--;cambia_dt=1;});
				dt_mm_button.onWheelObservable.add(function(evt) {
					if (evt.y<0) {dtv[2]++;cambia_dt=1;}
					if (evt.y>0) {dtv[2]--;cambia_dt=1;}  
				});					
				dt_rect.addControl(dt_mm_button);


				//Boton de segundo +1 de intervalo
				var dt_sp_button = BABYLON.GUI.Button.CreateSimpleButton("dt_sp_button","+");
				dt_sp_button.width = "40px";
				dt_sp_button.height = "60px";
				dt_sp_button.color = "white";
				dt_sp_button.cornerRadius=10;
				dt_sp_button.background = "orange";
				dt_sp_button.top="10px";
				dt_sp_button.left="270px";
				dt_sp_button.horizontalAlignment = al_left;
				dt_sp_button.verticalAlignment =	al_top;
				dt_sp_button.fontSize=40;					
				dt_sp_button.onPointerClickObservable.add (function() {dtv[3]++;cambia_dt=1;});
				dt_sp_button.onWheelObservable.add(function(evt) {
					if (evt.y<0) {dtv[3]++;cambia_dt=1;}
					if (evt.y>0) {dtv[3]--;cambia_dt=1;}  
				});	
				dt_rect.addControl(dt_sp_button);


				//Boton de segundo -1 de intervalo
				var dt_sm_button = BABYLON.GUI.Button.CreateSimpleButton("dt_sm_button","-");
				dt_sm_button.width = "40px";
				dt_sm_button.height = "60px";
				dt_sm_button.color = "white";
				dt_sm_button.cornerRadius=10;
				dt_sm_button.background = "orange";
				dt_sm_button.top="130px";
				dt_sm_button.left="270px";
				dt_sm_button.horizontalAlignment = al_left;
				dt_sm_button.verticalAlignment =	al_top;
				dt_sm_button.fontSize=40;					
				dt_sm_button.onPointerClickObservable.add (function() {dtv[3]--;cambia_dt=1;});
				dt_sm_button.onWheelObservable.add(function(evt) {
					if (evt.y<0) {dtv[3]++;cambia_dt=1;}
					if (evt.y>0) {dtv[3]--;cambia_dt=1;}  
				});					
				dt_rect.addControl(dt_sm_button);


				//Boton cerrar dialogo de intervalo
				var dt_close_button = BABYLON.GUI.Button.CreateSimpleButton("dt_close_button"," Close ");
				dt_close_button.width = "470px";
				dt_close_button.height = "40px";
				dt_close_button.color = "black";
				dt_close_button.background = "white";
				dt_close_button.top="205px";
				dt_close_button.left="10px";
				dt_close_button.cornerRadius=10;
				dt_close_button.fontSize=24;
				dt_close_button.horizontalAlignment = al_left;
				dt_close_button.verticalAlignment =	al_top;						
				dt_close_button.onPointerClickObservable.add (function() {
					dt_rect.isVisible=0;
				});
				dt_rect.addControl(dt_close_button);


				//Botones de animacion hacia adelante y atras en el tiempo
				var ff_button = BABYLON.GUI.Button.CreateSimpleButton("ff_button",">>");
				var rw_button = BABYLON.GUI.Button.CreateSimpleButton("rw_button","<<");


				//Boton de animacion hacia adelante en el tiempo
				ff_button.width = "70px";
				ff_button.height = "85px";
				ff_button.color = "white";
				ff_button.background = "green";
				ff_button.top="10px";
				ff_button.left="410px";
				ff_button.horizontalAlignment = al_left;
				ff_button.verticalAlignment = al_top;
				ff_button.cornerRadius=10;
				ff_button.fontSize=40;							
				ff_button.onPointerClickObservable.add (function() {

					if (animacion==0) {
						animacion=1;
						time_control=1;
						ff_button.background = "red";
					} else {
						animacion=0;
						time_control=0;
						ff_button.background = "green";
						rw_button.background = "green";
					}
				
				});
				dt_rect.addControl(ff_button);     
			

				//Boton de animacion haia atras en el tiempo
				rw_button.width = "70px";
				rw_button.height = "85px";
				rw_button.color = "white";
				rw_button.background = "green";
				rw_button.top="10px";
				rw_button.left="330px";
				rw_button.verticalAlignment = al_top;
				rw_button.horizontalAlignment = al_left;
				rw_button.cornerRadius=10;
				rw_button.fontSize=40;
				rw_button.onPointerClickObservable.add (function() {

					if (animacion==0) {
						animacion=1;
						time_control=-1;
						rw_button.background = "red";
					} else {
						animacion=0;
						time_control=0;
						ff_button.background = "green";
						rw_button.background = "green";
					}
				
				});
				dt_rect.addControl(rw_button);


				//Boton de paso hacia atras en el tiempo
				var rs_button = BABYLON.GUI.Button.CreateSimpleButton("rs_button","<");
				rs_button.width = "70px";
				rs_button.height = "85px";
				rs_button.color = "white";
				rs_button.background = "purple";
				rs_button.top="110px";
				rs_button.left="330px";
				rs_button.verticalAlignment = al_top;
				rs_button.horizontalAlignment = al_left;
				rs_button.cornerRadius=10;
				rs_button.fontSize=40;
				rs_button.onPointerClickObservable.add (function() {

					animacion_paso=1;
					animacion=1;
					time_control=-1;
				
				});
				dt_rect.addControl(rs_button);


				//Boton de paso hacia adelante en el tiempo
				var fs_button = BABYLON.GUI.Button.CreateSimpleButton("fs_button",">");
				fs_button.width = "70px";
				fs_button.height = "85px";
				fs_button.color = "white";
				fs_button.background = "purple";
				fs_button.top="110px";
				fs_button.left="410px";
				fs_button.verticalAlignment = al_top;
				fs_button.horizontalAlignment = al_left;
				fs_button.cornerRadius=10;
				fs_button.fontSize=40;
				fs_button.onPointerClickObservable.add (function() {

					animacion_paso=1;
					animacion=1;
					time_control=1;					
				
				});
				dt_rect.addControl(fs_button);

				//------------


				//-------
				//Selector de objeto


				//Cuadro de opciones del selector de objeto
				var selector_rect = new BABYLON.GUI.Rectangle();
				selector_rect.width = "400px";
				selector_rect.height = "190px";
				selector_rect.cornerRadius = 20;
				selector_rect.color = "Orange";
				selector_rect.thickness = 4;
				selector_rect.background = "green";
				selector_rect.top="0";
				selector_rect.left="0";
				selector_rect.horizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_CENTER;
				selector_rect.verticalAlignment = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_BOTTOM;
				selector_rect.alpha=0.35;
				selector_rect.isVisible=0;		
				advancedTexture.addControl(selector_rect);


				//Boton de apertura y cierre de opciones del selector de objeto
				var selector_button = BABYLON.GUI.Button.CreateSimpleButton("selector_button"," None ");
				selector_button.width = "160px";
				selector_button.height = "50px";
				selector_button.color = "white";
				selector_button.cornerRadius=10;
				selector_button.background = "orange";
				selector_button.top="210px";
				selector_button.left="20px";
				selector_button.horizontalAlignment = al_left;
				selector_button.verticalAlignment =	al_top;
				selector_button.textBlock.text="View:\n"+planet_names[planet_id]+":Center";						
				selector_button.onPointerClickObservable.add (function() {

					point_to_rect.isVisible=0;
					datetime_rect.isVisible=0;
					dt_rect.isVisible=0;
					opts_rect.isVisible=0;
					if (selector_rect.isVisible==1) {selector_rect.isVisible=0;} else {selector_rect.isVisible=1;}

				});
				advancedTexture.addControl(selector_button);


				//Texto del selector de planeta
				var pn_text = new BABYLON.GUI.TextBlock();
				pn_text.text = planet_names[planet_id];
				pn_text.color = "white";
				pn_text.fontSize = 24;
				pn_text.top="20px";
				pn_text.left="50px";
				pn_text.height="60px";
				pn_text.width = "180px";
				pn_text.horizontalAlignment = al_left;
				pn_text.verticalAlignment = al_top;				
				selector_rect.addControl(pn_text);


				//Texto del selector de satelite
				var sn_text = new BABYLON.GUI.TextBlock();
				sn_text.text = "Center";
				sn_text.color = "white";
				sn_text.fontSize = 24;
				sn_text.top="80px";
				sn_text.left="55px";
				sn_text.height="60px";
				sn_text.width = "180px";
				sn_text.horizontalAlignment = al_left;
				sn_text.verticalAlignment = al_top;				
				selector_rect.addControl(sn_text);


				//Boton de siguiente planeta
				var pp_button = BABYLON.GUI.Button.CreateSimpleButton("pp_button"," > ");
				pp_button.width = "60px";
				pp_button.height = "40px";
				pp_button.color = "white";
				pp_button.background = "orange";
				pp_button.top="20px";
				pp_button.left="220px";
				pp_button.cornerRadius=10;
				pp_button.horizontalAlignment = al_left;
				pp_button.verticalAlignment = al_top;							
				pp_button.onPointerClickObservable.add (function() {

					//Busca el parent por si planet_id es un satelite
					var par=planet_parent[planet_id];
					if (par<=0) {

					} else {
						planet_id=par;
					}

					planet_id++;
					if (planet_id>planet_id_max-1) planet_id=planet_id_max-1;
					if (planet_id>10) planet_id=10;
					if (planet_id==4) planet_id=5;
					pn_text.text = planet_names[planet_id];
					actualiza=1;
					change_focus=1;
				
					selector_button.textBlock.text="View:\n" + planet_names[planet_id]+":Center";

					//Pone a cero en contador de satelite
					planet_sat_id=0;
					//sn_text.text=planet_names[planet_sat[planet_id][planet_sat_id]];
					sn_text.text="Center";

					if (planet_lineo_id==planet_id) {
						plineo_button.color="red";
					} else {
						plineo_button.color="gray";
					}
					if (planet_lined_id==planet_id) {
						plined_button.color="red";
					} else {
						plined_button.color="gray";
					}


				
				});
				selector_rect.addControl(pp_button); 


				//Boton de planeta anterior
				var pm_button = BABYLON.GUI.Button.CreateSimpleButton("pm_button"," < ");
				pm_button.width = "60px";
				pm_button.height = "40px";
				pm_button.color = "white";
				pm_button.background = "orange";
				pm_button.top="20px";
				pm_button.left="10px";
				pm_button.cornerRadius=10;
				pm_button.horizontalAlignment = al_left;
				pm_button.verticalAlignment = al_top;							
				pm_button.onPointerClickObservable.add (function() {

					//Busca el parent por si planet_id es un satelite
					var par=planet_parent[planet_id];
					if (par<=0) {
					
					} else {
						planet_id=par;
					}
					
					planet_id--;
					if (planet_id<0) planet_id=0;
					if (planet_id==4) planet_id=3;
					pn_text.text = planet_names[planet_id];
					actualiza=1;	
					change_focus=1;

					selector_button.textBlock.text="View:\n" + planet_names[planet_id]+":Center";

					//Resetea el contador de satelite
					planet_sat_id=0;
					//sn_text.text=planet_names[planet_sat[planet_id][planet_sat_id]];
					sn_text.text="Center";

					if (planet_lineo_id==planet_id) {
						plineo_button.color="red";
					} else {
						plineo_button.color="gray";
					}
					if (planet_lined_id==planet_id) {
						plined_button.color="red";
					} else {
						plined_button.color="gray";
					}
				
				});
				selector_rect.addControl(pm_button);


				//Boton de satelite siguiente
				var sp_button = BABYLON.GUI.Button.CreateSimpleButton("sp_button"," > ");
				sp_button.width = "60px";
				sp_button.height = "40px";
				sp_button.color = "black";
				sp_button.background = "yellow";
				sp_button.top="80px";
				sp_button.left="220px";
				sp_button.cornerRadius=10;
				sp_button.horizontalAlignment = al_left;
				sp_button.verticalAlignment = al_top;							
				sp_button.onPointerClickObservable.add (function() {

					var par=planet_parent[planet_id];
					if (par<=0) par=planet_id;
				
					planet_sat_id++;
					if (planet_sat_id>planet_sat_n[par]) planet_sat_id=planet_sat_n[par];

					planet_id=planet_sat[par][planet_sat_id];

					if (planet_sat_id==0) {
						selector_button.textBlock.text="View:\n" + planet_names[par]+":Center";
					} else {
						selector_button.textBlock.text="View:\n" + planet_names[par]+":"+planet_names[planet_id];
					}

					sn_text.text = planet_names[planet_id];
					if (planet_sat_id==0) sn_text.text="Center";
					actualiza=1;
					change_focus=1;

					if (planet_lineo_id==planet_id) {
						plineo_button.color="red";
					} else {
						plineo_button.color="gray";
					}
					if (planet_lined_id==planet_id) {
						plined_button.color="red";
					} else {
						plined_button.color="gray";
					}
									
				});
				selector_rect.addControl(sp_button); 


				//Boton de satelite anterior
				var sm_button = BABYLON.GUI.Button.CreateSimpleButton("sm_button"," < ");
				sm_button.width = "60px";
				sm_button.height = "40px";
				sm_button.color = "black";
				sm_button.background = "yellow";
				sm_button.top="80px";
				sm_button.left="10px";
				sm_button.cornerRadius=10;
				sm_button.horizontalAlignment = al_left;
				sm_button.verticalAlignment = al_top;							
				sm_button.onPointerClickObservable.add (function() {

					var par=planet_parent[planet_id];
					if (par<=0) par=planet_id;
				
					planet_sat_id--;
					if (planet_sat_id<0) planet_sat_id=0;

					planet_id=planet_sat[par][planet_sat_id];


					if (planet_sat_id==0) {
						selector_button.textBlock.text="View \n" + planet_names[par]+":Center";
					} else {
						selector_button.textBlock.text="View \n" + planet_names[par]+":"+planet_names[planet_id];
					}

					sn_text.text = planet_names[planet_id];
					if (planet_sat_id==0) sn_text.text="Center";
					actualiza=1;
					change_focus=1;

					if (planet_lineo_id==planet_id) {
						plineo_button.color="red";
					} else {
						plineo_button.color="gray";
					}
					if (planet_lined_id==planet_id) {
						plined_button.color="red";
					} else {
						plined_button.color="gray";
					}


				});
				selector_rect.addControl(sm_button);


				//Boton que cierra el dialogo de selector de planeta
				var selector_close_button = BABYLON.GUI.Button.CreateSimpleButton("selector_close_button"," Close ");
				selector_close_button.width = "370px";
				selector_close_button.height = "30px";
				selector_close_button.color = "black";
				selector_close_button.background = "white";
				selector_close_button.top="140px";
				selector_close_button.left="10px";
				selector_close_button.cornerRadius=10;
				selector_close_button.horizontalAlignment = al_left;
				selector_close_button.verticalAlignment =	al_top;						
				selector_close_button.onPointerClickObservable.add (function() {
					selector_rect.isVisible=0;
				});
				selector_rect.addControl(selector_close_button);


				//Boton de seleccion de linea de origen
				var plineo_button = BABYLON.GUI.Button.CreateSimpleButton("point_to_close_button","LINE O");
				plineo_button.width = "70px";
				plineo_button.height = "40px";
				plineo_button.color = "gray";
				plineo_button.background = "white";
				plineo_button.top="20px";
				plineo_button.left="310px";
				plineo_button.cornerRadius=10;
				plineo_button.horizontalAlignment = al_left;
				plineo_button.verticalAlignment =	al_top;						
				plineo_button.onPointerClickObservable.add (function() {

					if (planet_lineo_id==planet_id) {
						planet_lineo_id=0;
						plineo_button.color="gray";
					} else {
						planet_lineo_id=planet_id;
						plineo_button.color = "red";
					}

					actualiza=1;
					planet_traj_n=2;
					planet_traj_data=[];
					planet_traj_data[0]=new BABYLON.Vector3(NaN,NaN,NaN);
					planet_traj_data[1]=new BABYLON.Vector3(NaN,NaN,NaN);


				});
				selector_rect.addControl(plineo_button);


				//Boton de seleccion de linea de destino
				var plined_button = BABYLON.GUI.Button.CreateSimpleButton("point_to_close_button","LINE D");
				plined_button.width = "70px";
				plined_button.height = "40px";
				plined_button.color = "gray";
				plined_button.background = "white";
				plined_button.top="75px";
				plined_button.left="310px";
				plined_button.cornerRadius=10;
				plined_button.horizontalAlignment = al_left;
				plined_button.verticalAlignment =	al_top;						
				plined_button.onPointerClickObservable.add (function() {

					if (planet_lined_id==planet_id) {
						planet_lined_id=0;
						plined_button.color="gray";
					} else {
						planet_lined_id=planet_id;
						plined_button.color = "red";
					}

					actualiza=1;
					planet_traj_n=2;
					planet_traj_data=[];
					planet_traj_data[0]=new BABYLON.Vector3(NaN,NaN,NaN);
					planet_traj_data[1]=new BABYLON.Vector3(NaN,NaN,NaN);


				});
				selector_rect.addControl(plined_button);


				//Boton de borrar el trazo de trayectoria
				var clr_pline_button = BABYLON.GUI.Button.CreateSimpleButton("point_to_close_button","CLR L");
				clr_pline_button.width = "80px";
				clr_pline_button.height = "30px";
				clr_pline_button.color = "orange";
				clr_pline_button.background = "green";
				clr_pline_button.top="370px";
				clr_pline_button.left="20px";
				clr_pline_button.cornerRadius=10;
				clr_pline_button.horizontalAlignment = al_left;
				clr_pline_button.verticalAlignment =	al_top;						
				clr_pline_button.onPointerClickObservable.add (function() {

					actualiza=1;
					planet_traj_n=2;
					planet_traj_data=[];
					planet_traj_data[0]=new BABYLON.Vector3(NaN,NaN,NaN);
					planet_traj_data[1]=new BABYLON.Vector3(NaN,NaN,NaN);


				});
				advancedTexture.addControl(clr_pline_button);

				//------------------


				//--------
				//Panel de opciones general

				//Cuadro de opciones generales
				var opts_rect = new BABYLON.GUI.Rectangle();
				opts_rect.width = "500px";
				opts_rect.height = "260px";
				opts_rect.cornerRadius = 20;
				opts_rect.color = "Orange";
				opts_rect.thickness = 4;
				opts_rect.background = "green";
				opts_rect.top="0";
				opts_rect.left="0";
				opts_rect.horizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_CENTER;
				opts_rect.verticalAlignment = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_BOTTOM;
				opts_rect.alpha=0.35;
				opts_rect.isVisible=0;		
				advancedTexture.addControl(opts_rect);


				//Boton de apertura y cierre de opciones del selector de objeto
				var opts_button = BABYLON.GUI.Button.CreateSimpleButton("selector_button"," None ");
				opts_button.width = "80px";
				opts_button.height = "30px";
				opts_button.color = "black";
				opts_button.cornerRadius=10;
				opts_button.background = "yellow";
				opts_button.top="330px";
				opts_button.left="20px";
				opts_button.horizontalAlignment = al_left;
				opts_button.verticalAlignment =	al_top;
				opts_button.textBlock.text="OPS"					
				opts_button.onPointerClickObservable.add (function() {

					point_to_rect.isVisible=0;
					datetime_rect.isVisible=0;
					dt_rect.isVisible=0;
					selector_rect.isVisible=0;
					if (opts_rect.isVisible==1) {opts_rect.isVisible=0;} else {opts_rect.isVisible=1;}

				});
				advancedTexture.addControl(opts_button);


				//Boton que cierra el dialogo de selector de opciones generales
				var opts_close_button = BABYLON.GUI.Button.CreateSimpleButton("selector_close_button"," Close ");
				opts_close_button.width = "480px";
				opts_close_button.height = "30px";
				opts_close_button.color = "black";
				opts_close_button.background = "white";
				opts_close_button.top="220px";
				opts_close_button.left="5px";
				opts_close_button.cornerRadius=10;
				opts_close_button.horizontalAlignment = al_left;
				opts_close_button.verticalAlignment =	al_top;						
				opts_close_button.onPointerClickObservable.add (function() {
					opts_rect.isVisible=0;
				});
				opts_rect.addControl(opts_close_button);


				//----------


				//-----
				//Panel de opciones 1

				//Cuadro de opciones del selector de objeto
				var opt1_rect = new BABYLON.GUI.Rectangle();
				opt1_rect.width = "420px";
				opt1_rect.height = "215px";
				opt1_rect.cornerRadius = 20;
				opt1_rect.color = "Orange";
				opt1_rect.thickness = 4;
				opt1_rect.background = "green";
				opt1_rect.top="0";
				opt1_rect.left="0";
				opt1_rect.horizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_RIGHT;
				opt1_rect.verticalAlignment = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_TOP;
				opt1_rect.alpha=0.85;
				opt1_rect.isVisible=1;		
				opts_rect.addControl(opt1_rect);


				//Boton de apertura y cierre de opciones del selector de objeto
				var opt1_button = BABYLON.GUI.Button.CreateSimpleButton("selector_button"," None ");
				opt1_button.width = "50px";
				opt1_button.height = "30px";
				opt1_button.color = "black";
				opt1_button.cornerRadius=10;
				opt1_button.background = "yellow";
				opt1_button.top="10px";
				opt1_button.left="10px";
				opt1_button.horizontalAlignment = al_left;
				opt1_button.verticalAlignment =	al_top;
				opt1_button.textBlock.text=" I "					
				opt1_button.onPointerClickObservable.add (function() {

					opt1_rect.isVisible=true;
					opt2_rect.isVisible=false;
					opt3_rect.isVisible=false;

					opt1_button.color="black";
					opt1_button.background="yellow";

					opt2_button.color="white";
					opt2_button.background="gray";

					opt3_button.color="white";
					opt3_button.background="gray";

				});
				opts_rect.addControl(opt1_button);

			
				//Control del zoom fov
				fov_slider = new BABYLON.GUI.Slider();
				fov_slider.minimum = 0.001;
				fov_slider.maximum = 1;
				fov_slider.value = 1;
				fov_slider.step=0.001;
				fov_slider.height = "20px";
				fov_slider.width = "250px";
				fov_slider.top="20px";
				fov_slider.left="10px";
				fov_slider.background = "blue";
				fov_slider.horizontalAlignment = al_left;
				fov_slider.verticalAlignment = al_top;			
				fov_slider.onValueChangedObservable.add(function(value) {

					var value1=Math.pow(fov_slider.value,3)*0.8;
		
					camera.fov=value1;
					camera2.fov=value1;
					fov_text.text = "FOV: " + (Math.floor(((camera.fov)/Math.PI*180.0)*1000)/1000).toString();					
				
					if (camera2.fov<cam2_fov_limit) {

						camera2.minZ=0.1;
						camera2.maxZ=50;

					} else {

						camera2.minZ=0.000001;
						camera2.maxZ=10000;

					}

				});
				fov_slider.onPointerDownObservable.add(function() {sobre_control=1;});
				fov_slider.onPointerUpObservable.add(function() {sobre_control=0;});
				opt1_rect.addControl(fov_slider);


				//Texto de los slider de FOV
				var fov_text = new BABYLON.GUI.TextBlock();
				fov_text.text = "FOV: " + (Math.floor(((camera2.fov)/Math.PI*180.0)*1000)/1000).toString()+"º";
				fov_text.color = "white";
				fov_text.fontSize = 22;
				fov_text.top="18px";
				fov_text.left="270px";
				fov_text.height="30px";
				fov_text.width = "140px";
				fov_text.horizontalAlignment = al_left;
				fov_text.verticalAlignment = al_top;				
				opt1_rect.addControl(fov_text);


				//Control de latitud
				var lat_slider = new BABYLON.GUI.Slider();
				lat_slider.minimum = -90;
				lat_slider.maximum = 90;
				lat_slider.value = lat*180.0/Math.PI;
				lat_slider.step=0.1;
				lat_slider.height = "20px";
				lat_slider.width = "250px";
				lat_slider.top="50px";
				lat_slider.left="10px";
				lat_slider.background = "purple";
				lat_slider.horizontalAlignment = al_left;
				lat_slider.verticalAlignment = al_top;			
				lat_slider.onValueChangedObservable.add(function(value) {

					lat=value*Math.PI/180.0;
					lat_text.text = "Lat: " + (Math.floor(lat_slider.value*1000)/1000).toFixed(1)+"º";
					actualiza=1;

				});
				lat_slider.onPointerDownObservable.add(function() {sobre_control=1;});
				lat_slider.onPointerUpObservable.add(function() {sobre_control=0;});
				opt1_rect.addControl(lat_slider);


				//Texto del slider de latitud
				var lat_text = new BABYLON.GUI.TextBlock();
				lat_text.text = "Lat: " + (Math.floor(lat_slider.value*1000)/1000).toFixed(1)+"º";
				lat_text.color = "white";
				lat_text.fontSize = 22;
				lat_text.top="45px";
				lat_text.left="270px";
				lat_text.height="30px";
				lat_text.width = "140px";
				lat_text.horizontalAlignment = al_left;
				lat_text.verticalAlignment = al_top;				
				opt1_rect.addControl(lat_text);


				//Control de longitud
				var lon_slider = new BABYLON.GUI.Slider();
				lon_slider.minimum = -180;
				lon_slider.maximum = 180;
				lon_slider.value = lon*180.0/Math.PI;
				lon_slider.step=0.1;
				lon_slider.height = "20px";
				lon_slider.width = "250px";
				lon_slider.top="80px";
				lon_slider.left="10px";
				lon_slider.background = "purple";
				lon_slider.horizontalAlignment = al_left;
				lon_slider.verticalAlignment = al_top;			
				lon_slider.onValueChangedObservable.add(function(value) {

					lon=value*Math.PI/180.0;
					lon_text.text = "Lon: " + (Math.floor(lon_slider.value*1000)/1000).toFixed(1)+"º";
					actualiza=1;
				
				});
				lon_slider.onPointerDownObservable.add(function() {sobre_control=1;});
				lon_slider.onPointerUpObservable.add(function() {sobre_control=0;});
				opt1_rect.addControl(lon_slider);


				//Texto del slider de longitud
				var lon_text = new BABYLON.GUI.TextBlock();
				lon_text.text = "Lon: " + (Math.floor(lon_slider.value*1000)/1000).toFixed(1)+"º";;
				lon_text.color = "white";
				lon_text.fontSize = 22;
				lon_text.top="75px";
				lon_text.left="270px";
				lon_text.height="30px";
				lon_text.width = "140px";
				lon_text.horizontalAlignment = al_left;
				lon_text.verticalAlignment = al_top;				
				opt1_rect.addControl(lon_text);


				//Control de altura
				var alt_slider = new BABYLON.GUI.Slider();
				alt_slider.minimum = 0;
				alt_slider.maximum = 1000;
				alt_slider.value = lat_lon_alt;
				alt_slider.step=0.1;
				alt_slider.height = "20px";
				alt_slider.width = "250px";
				alt_slider.top="110px";
				alt_slider.left="10px";
				alt_slider.background = "white";
				alt_slider.horizontalAlignment = al_left;
				alt_slider.verticalAlignment = al_top;			
				alt_slider.onValueChangedObservable.add(function(value) {

					lat_lon_alt=value;
					alt_text.text = "Alt: " + alt_slider.value.toString()+" Km";
					actualiza=1;
				
				});
				alt_slider.onPointerDownObservable.add(function() {sobre_control=1;});
				alt_slider.onPointerUpObservable.add(function() {sobre_control=0;});
				opt1_rect.addControl(alt_slider);

				
				//Texto del slider de altura
				var alt_text = new BABYLON.GUI.TextBlock();
				alt_text.text = "Alt: " + alt_slider.value.toString()+" Km";
				alt_text.color = "white";
				alt_text.fontSize = 22;
				alt_text.top="107px";
				alt_text.left="270px";
				alt_text.height="30px";
				alt_text.width = "140px";
				alt_text.horizontalAlignment = al_left;
				alt_text.verticalAlignment = al_top;				
				opt1_rect.addControl(alt_text);


				//transparencia de las orbitas
				var orbs_trans_slider = new BABYLON.GUI.Slider();
				orbs_trans_slider.minimum = 0;
				orbs_trans_slider.maximum = 0.5;
				orbs_trans_slider.value = orbits_alpha;
				orbs_trans_slider.step=0.01;
				orbs_trans_slider.height = "20px";
				orbs_trans_slider.width = "250px";
				orbs_trans_slider.top="142px";
				orbs_trans_slider.left="10px";
				orbs_trans_slider.background = "yellow";
				orbs_trans_slider.horizontalAlignment = al_left;
				orbs_trans_slider.verticalAlignment = al_top;			
				orbs_trans_slider.onValueChangedObservable.add(function(value) {
					
					orbits_alpha=value;

					for (var ii=0;ii<n_objetos;ii++) {
						lines[ii].alpha=orbits_alpha;
					}

					actualiza=1;
				
				});
				orbs_trans_slider.onPointerDownObservable.add(function() {sobre_control=1;});
				orbs_trans_slider.onPointerUpObservable.add(function() {sobre_control=0;});
				opt1_rect.addControl(orbs_trans_slider);
				

				//Texto del slider de transparencia de las orbitas
				var orbs_trans_text = new BABYLON.GUI.TextBlock();
				orbs_trans_text.text = "Orbits alpha";
				orbs_trans_text.color = "yellow";
				orbs_trans_text.fontSize = 22;
				orbs_trans_text.top="138px";
				orbs_trans_text.left="270px";
				orbs_trans_text.height="30px";
				orbs_trans_text.width = "140px";
				orbs_trans_text.horizontalAlignment = al_left;
				orbs_trans_text.verticalAlignment = al_top;				
				opt1_rect.addControl(orbs_trans_text);


				//Slider de transparencia de constelaciones		
				var const_trans_slider = new BABYLON.GUI.Slider();
				const_trans_slider.minimum = 0;
				const_trans_slider.maximum = 0.25;
				const_trans_slider.value = constellations_alpha;
				const_trans_slider.step=0.01;
				const_trans_slider.height = "20px";
				const_trans_slider.width = "250px";
				const_trans_slider.top="175px";
				const_trans_slider.left="10px";
				const_trans_slider.background = "orange";
				const_trans_slider.horizontalAlignment = al_left;
				const_trans_slider.verticalAlignment = al_top;			
				const_trans_slider.onValueChangedObservable.add(function(value) {

					constellations_alpha=value;
					star_lines.alpha=constellations_alpha; 
				
				});
				const_trans_slider.onPointerDownObservable.add(function() {sobre_control=1;});
				const_trans_slider.onPointerUpObservable.add(function() {sobre_control=0;});
				opt1_rect.addControl(const_trans_slider);


				//Texto de transparencia de constelaciones
				var const_trans_text = new BABYLON.GUI.TextBlock();
				const_trans_text.text = "  Const. alpha"; 
				const_trans_text.color = "orange";
				const_trans_text.fontSize = 22;
				const_trans_text.top="170px";
				const_trans_text.left="242px";
				const_trans_text.height="30px";
				const_trans_text.width = "180px";
				const_trans_text.horizontalAlignment = al_left;
				const_trans_text.verticalAlignment = al_top;				
				opt1_rect.addControl(const_trans_text);

				//-----


				//-----
				//Panel de opciones 2


				//Cuadro de opciones del selector de objeto
				var opt2_rect = new BABYLON.GUI.Rectangle();
				opt2_rect.width = "420px";
				opt2_rect.height = "215px";
				opt2_rect.cornerRadius = 20;
				opt2_rect.color = "Orange";
				opt2_rect.thickness = 4;
				opt2_rect.background = "green";
				opt2_rect.top="0";
				opt2_rect.left="0";
				opt2_rect.horizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_RIGHT;
				opt2_rect.verticalAlignment = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_TOP;
				opt2_rect.alpha=0.85;
				opt2_rect.isVisible=0;		
				opts_rect.addControl(opt2_rect);


				//Boton de apertura y cierre de opciones del selector de objeto
				var opt2_button = BABYLON.GUI.Button.CreateSimpleButton("opciones 2"," None ");
				opt2_button.width = "50px";
				opt2_button.height = "30px";
				opt2_button.color = "white";
				opt2_button.cornerRadius=10;
				opt2_button.background = "gray";
				opt2_button.top="50px";
				opt2_button.left="10px";
				opt2_button.horizontalAlignment = al_left;
				opt2_button.verticalAlignment =	al_top;
				opt2_button.textBlock.text=" II "					
				opt2_button.onPointerClickObservable.add (function() {

					opt1_rect.isVisible=false;
					opt2_rect.isVisible=true;
					opt3_rect.isVisible=false;

					opt1_button.color="white";
					opt1_button.background="gray";

					opt2_button.color="black";
					opt2_button.background="yellow";

					opt3_button.color="white";
					opt3_button.background="gray";

				});
				opts_rect.addControl(opt2_button);


				//Magnitud de glow
				var glow_slider = new BABYLON.GUI.Slider();
				glow_slider.minimum = 0;
				glow_slider.maximum = 1000;
				glow_slider.value = glo.intensity;
				glow_slider.step=1;
				glow_slider.height = "20px";
				glow_slider.width = "250px";
				glow_slider.top="20px";
				glow_slider.left="10px";
				glow_slider.background = "yellow";
				glow_slider.horizontalAlignment = al_left;
				glow_slider.verticalAlignment = al_top;			
				glow_slider.onValueChangedObservable.add(function(value) {
					//camera.radius=planet_rad[planet_id]*i_ua_km*value;
					glo.intensity=value;
					if (value==5) {
						glow_sph_mat.alpha=0.001;
					} else {
						glow_sph_mat.alpha=0.1;
					}					
				});
				glow_slider.onPointerDownObservable.add(function() {sobre_control=1;});
				glow_slider.onPointerUpObservable.add(function() {sobre_control=0;});
				opt2_rect.addControl(glow_slider);


				//Texto de control del glow
				var glow_text = new BABYLON.GUI.TextBlock();
				glow_text.text = "Glow intensity"
				glow_text.color = "yellow";
				glow_text.fontSize = 20;
				glow_text.top="16px";
				glow_text.left="248px";
				glow_text.height="30px";
				glow_text.width = "180px";
				glow_text.horizontalAlignment = al_left;
				glow_text.verticalAlignment = al_top;				
				opt2_rect.addControl(glow_text);


				//Control de la intensidad de la iluminacion
				var light_intensity_slider = new BABYLON.GUI.Slider();
				light_intensity_slider.minimum = 0.5;
				light_intensity_slider.maximum = 2;
				light_intensity_slider.value = 1;
				light_intensity_slider.step=0.01;
				light_intensity_slider.height = "20px";
				light_intensity_slider.width = "250px";
				light_intensity_slider.top="50px";
				light_intensity_slider.left="10px";
				light_intensity_slider.background = "orange";
				light_intensity_slider.horizontalAlignment = al_left;
				light_intensity_slider.verticalAlignment = al_top;			
				light_intensity_slider.onValueChangedObservable.add(function(value) {
	
					light0.intensity=value;

					for (var ii=0;ii<fake_sun_n;ii++) {

						light[ii].intensity=value;

					}
	
				});
				glow_slider.onPointerDownObservable.add(function() {sobre_control=1;});
				glow_slider.onPointerUpObservable.add(function() {sobre_control=0;});
				opt2_rect.addControl(light_intensity_slider);


				//Texto del control de la intesidad de la limunacion
				var light_intensity_text = new BABYLON.GUI.TextBlock();
				light_intensity_text.text = "Light intensity"
				light_intensity_text.color = "orange";
				light_intensity_text.fontSize = 20;
				light_intensity_text.top="45px";
				light_intensity_text.left="248px";
				light_intensity_text.height="30px";
				light_intensity_text.width = "180px";
				light_intensity_text.horizontalAlignment = al_left;
				light_intensity_text.verticalAlignment = al_top;				
				opt2_rect.addControl(light_intensity_text);


				//Slider de selección de zona horaria		
				var utc_slider = new BABYLON.GUI.Slider();
				utc_slider.minimum = -12;
				utc_slider.maximum = 12;
				utc_slider.value = 0;
				utc_slider.step=1;
				utc_slider.height = "20px";
				utc_slider.width = "250px";
				utc_slider.top="80px";
				utc_slider.left="10px";
				utc_slider.background = "white";
				utc_slider.horizontalAlignment = al_left;
				utc_slider.verticalAlignment = al_top;			
				utc_slider.onValueChangedObservable.add(function(value) {

					utc_zone=value;
					actualiza=1;
					change_date_mw=1;
					utc_text.text = "UTC " + (utc_zone<=0?"":"+") + utc_zone; 
				
				});
				utc_slider.onPointerDownObservable.add(function() {sobre_control=1;});
				utc_slider.onPointerUpObservable.add(function() {sobre_control=0;});
				opt2_rect.addControl(utc_slider);


				//Texto de selección de zona horaria
				var utc_text = new BABYLON.GUI.TextBlock();
				utc_text.text = "UTC " + (utc_zone<=0?"":"+") + utc_zone; 
				utc_text.color = "white";
				utc_text.fontSize = 20;
				utc_text.top="75px";
				utc_text.left="220px";
				utc_text.height="30px";
				utc_text.width = "180px";
				utc_text.horizontalAlignment = al_left;
				utc_text.verticalAlignment = al_top;				
				opt2_rect.addControl(utc_text);


				//Opcion de sombras computadas
				var sombras_checkbox = new BABYLON.GUI.Checkbox();
				sombras_checkbox.width = "20px";
				sombras_checkbox.height = "20px";
				sombras_checkbox.color = "white";
				sombras_checkbox.background = "green";
				sombras_checkbox.top="110px";
				sombras_checkbox.left="20px";
				sombras_checkbox.text="hola";
				sombras_checkbox.horizontalAlignment = al_left;
				sombras_checkbox.verticalAlignment = al_top;	
				sombras_checkbox.onIsCheckedChangedObservable.add(function(value) {
					calculame_las_sombras=value;
					actualiza=1;
				});	     
				opt2_rect.addControl(sombras_checkbox);

				


				//Texto de sombras computadas
				var sombras_text = new BABYLON.GUI.TextBlock();
				sombras_text.text = "Computed Shadows"
				sombras_text.color = "white";
				sombras_text.fontSize = 20;
				sombras_text.top="105px";
				sombras_text.left="50px";
				sombras_text.height="30px";
				sombras_text.width = "180px";
				sombras_text.horizontalAlignment = al_left;
				sombras_text.verticalAlignment = al_top;				
				opt2_rect.addControl(sombras_text);


				//Opcion de modo interactivo
				var modeinter_checkbox = new BABYLON.GUI.Checkbox();
				modeinter_checkbox.width = "20px";
				modeinter_checkbox.height = "20px";
				modeinter_checkbox.color = "white";
				modeinter_checkbox.background = "green";
				modeinter_checkbox.top="140px";
				modeinter_checkbox.left="20px";
				modeinter_checkbox.text="hola";
				modeinter_checkbox.horizontalAlignment = al_left;
				modeinter_checkbox.verticalAlignment = al_top;	
				modeinter_checkbox.onIsCheckedChangedObservable.add(function(value) {
					modo_interactivo=value;
					actualiza=1;
					
					if (modo_interactivo==false) {
						for (var ii=1;ii<=10;ii++) {

								if (ii==4) continue;
						
								sprite_planet[ii].isVisible=false;
								sprite_planet[ii].isPickable=false;
						}
					}

					//console.log(modo_interactivo);

				});	     
				opt2_rect.addControl(modeinter_checkbox);


				//Texto de modo interactivo
				var modeinter_text = new BABYLON.GUI.TextBlock();
				modeinter_text.text = "Ineractive mode"
				modeinter_text.color = "white";
				modeinter_text.fontSize = 20;
				modeinter_text.top="135px";
				modeinter_text.left="32px";
				modeinter_text.height="30px";
				modeinter_text.width = "180px";
				modeinter_text.horizontalAlignment = al_left;
				modeinter_text.verticalAlignment = al_top;				
				opt2_rect.addControl(modeinter_text);


				//Opcion de correccion de la velocidad de la luz
				var slcor_checkbox = new BABYLON.GUI.Checkbox();
				slcor_checkbox.width = "20px";
				slcor_checkbox.height = "20px";
				slcor_checkbox.color = "white";
				slcor_checkbox.background = "green";
				slcor_checkbox.top="170px";
				slcor_checkbox.left="20px";
				slcor_checkbox.text="hola";
				slcor_checkbox.horizontalAlignment = al_left;
				slcor_checkbox.verticalAlignment = al_top;	
				slcor_checkbox.onIsCheckedChangedObservable.add(function(value) {
					speed_light_correction=value;
					actualiza=1;
				});	     
				opt2_rect.addControl(slcor_checkbox);


				//Texto de la opcion de correcion de la velocidad de la luz
				var slcor_text = new BABYLON.GUI.TextBlock();
				slcor_text.text = "Speed light correction"
				slcor_text.color = "white";
				slcor_text.fontSize = 20;
				slcor_text.top="165px";
				slcor_text.left="42px";
				slcor_text.height="30px";
				slcor_text.width = "210px";
				slcor_text.horizontalAlignment = al_left;
				slcor_text.verticalAlignment = al_top;				
				opt2_rect.addControl(slcor_text);

				
				//Boton que cierra el dialogo de selector de opciones 1
				var opt2_close_button = BABYLON.GUI.Button.CreateSimpleButton("selector_close_button"," Close ");
				opt2_close_button.width = "390px";
				opt2_close_button.height = "30px";
				opt2_close_button.color = "black";
				opt2_close_button.background = "white";
				opt2_close_button.top="215px";
				opt2_close_button.left="10px";
				opt2_close_button.cornerRadius=10;
				opt2_close_button.horizontalAlignment = al_left;
				opt2_close_button.verticalAlignment =	al_top;						
				opt2_close_button.onPointerClickObservable.add (function() {
					opt2_rect.isVisible=0;
				});
				opt2_rect.addControl(opt2_close_button);


				//------


				//-----
				//Panel de opciones 3


				//Cuadro de opciones del selector de objeto
				var opt3_rect = new BABYLON.GUI.Rectangle();
				opt3_rect.width = "420px";
				opt3_rect.height = "215px";
				opt3_rect.cornerRadius = 20;
				opt3_rect.color = "Orange";
				opt3_rect.thickness = 4;
				opt3_rect.background = "green";
				opt3_rect.top="0";
				opt3_rect.left="0";
				opt3_rect.horizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_RIGHT;
				opt3_rect.verticalAlignment = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_TOP;
				opt3_rect.alpha=0.85;
				opt3_rect.isVisible=0;		
				opts_rect.addControl(opt3_rect);


				//Boton de apertura y cierre de opciones del selector de objeto
				var opt3_button = BABYLON.GUI.Button.CreateSimpleButton("opciones 3"," None ");
				opt3_button.width = "50px";
				opt3_button.height = "30px";
				opt3_button.color = "white";
				opt3_button.cornerRadius=10;
				opt3_button.background = "gray";
				opt3_button.top="90px";
				opt3_button.left="10px";
				opt3_button.horizontalAlignment = al_left;
				opt3_button.verticalAlignment =	al_top;
				opt3_button.textBlock.text=" III "					
				opt3_button.onPointerClickObservable.add (function() {

					opt1_rect.isVisible=false;
					opt2_rect.isVisible=false;
					opt3_rect.isVisible=true;
					

					opt1_button.color="white";
					opt1_button.background="gray";

					opt2_button.color="white";
					opt2_button.background="gray";

					opt3_button.color="black";
					opt3_button.background="yellow";


				});
				opts_rect.addControl(opt3_button);


				//Opcipn de rectangulo de orientacion
				var head_checkbox = new BABYLON.GUI.Checkbox();
				head_checkbox.width = "20px";
				head_checkbox.height = "20px";
				head_checkbox.color = "white";
				head_checkbox.background = "green";
				head_checkbox.top="20px";
				head_checkbox.left="20px";
				head_checkbox.horizontalAlignment = al_left;
				head_checkbox.verticalAlignment = al_top;	
				head_checkbox.onIsCheckedChangedObservable.add(function(value) {
					
					head_coordinates=value;
					head_data_rect.isVisible=head_coordinates;
					actualiza=1;

				});	     
				opt3_rect.addControl(head_checkbox);


				//Texto de rectangulo de orientacion
				var head_cb_text = new BABYLON.GUI.TextBlock();
				head_cb_text.text = "Camera target point info"
				head_cb_text.color = "white";
				head_cb_text.fontSize = 20;
				head_cb_text.top="17px";
				head_cb_text.left="50px";
				head_cb_text.height="30px";
				head_cb_text.width = "220px";
				head_cb_text.horizontalAlignment = al_left;
				head_cb_text.verticalAlignment = al_top;				
				opt3_rect.addControl(head_cb_text);


				//Opcipn de fijar alt_az
				var alt_az_lock_checkbox = new BABYLON.GUI.Checkbox();
				alt_az_lock_checkbox.width = "20px";
				alt_az_lock_checkbox.height = "20px";
				alt_az_lock_checkbox.color = "white";
				alt_az_lock_checkbox.background = "green";
				alt_az_lock_checkbox.top="50px";
				alt_az_lock_checkbox.left="20px";
				alt_az_lock_checkbox.horizontalAlignment = al_left;
				alt_az_lock_checkbox.verticalAlignment = al_top;
				alt_az_lock_checkbox.isChecked=true;	
				alt_az_lock_checkbox.onIsCheckedChangedObservable.add(function(value) {
					
					alt_az_lock=value;
					actualiza=1;

				});	     
				opt3_rect.addControl(alt_az_lock_checkbox);


				//Texto de opcion de fijar alt_az
				var alt_az_lock_cb_text = new BABYLON.GUI.TextBlock();
				alt_az_lock_cb_text.text = "Alt/Az Animation Lock"
				alt_az_lock_cb_text.color = "white";
				alt_az_lock_cb_text.fontSize = 20;
				alt_az_lock_cb_text.top="47px";
				alt_az_lock_cb_text.left="50px";
				alt_az_lock_cb_text.height="30px";
				alt_az_lock_cb_text.width = "200px";
				alt_az_lock_cb_text.horizontalAlignment = al_left;
				alt_az_lock_cb_text.verticalAlignment = al_top;				
				opt3_rect.addControl(alt_az_lock_cb_text);


				///Texto de opcion de orientacion
				var ori_cb_text = new BABYLON.GUI.TextBlock();
				ori_cb_text.text = "Orientation"
				ori_cb_text.color = "white";
				ori_cb_text.fontSize = 20;
				ori_cb_text.top="77px";
				ori_cb_text.left="20px";
				ori_cb_text.height="30px";
				ori_cb_text.width = "100px";
				ori_cb_text.horizontalAlignment = al_left;
				ori_cb_text.verticalAlignment = al_top;				
				opt3_rect.addControl(ori_cb_text);


				//Orientacion alt_az
				var ori_altaz_checkbox = new BABYLON.GUI.Checkbox();
				ori_altaz_checkbox.width = "20px";
				ori_altaz_checkbox.height = "20px";
				ori_altaz_checkbox.color = "white";
				ori_altaz_checkbox.background = "green";
				ori_altaz_checkbox.top="80px";
				ori_altaz_checkbox.left="140px";
				ori_altaz_checkbox.horizontalAlignment = al_left;
				ori_altaz_checkbox.verticalAlignment = al_top;
				ori_altaz_checkbox.isChecked=true;	
				ori_altaz_checkbox.onIsCheckedChangedObservable.add(function(value) {
					
					ori_altaz=value;
					if (ori_altaz==1) {ori_equat=0;} else {ori_equat=1;}

					ori_equat_checkbox.isChecked=ori_equat;

					actualiza=1;

				});	     
				opt3_rect.addControl(ori_altaz_checkbox);


				///Texto de opcion de orientacion altaz
				var ori_altaz_cb_text = new BABYLON.GUI.TextBlock();
				ori_altaz_cb_text.text = "AltAz"
				ori_altaz_cb_text.color = "white";
				ori_altaz_cb_text.fontSize = 20;
				ori_altaz_cb_text.top="77px";
				ori_altaz_cb_text.left="160px";
				ori_altaz_cb_text.height="30px";
				ori_altaz_cb_text.width = "70px";
				ori_altaz_cb_text.horizontalAlignment = al_left;
				ori_altaz_cb_text.verticalAlignment = al_top;				
				opt3_rect.addControl(ori_altaz_cb_text);


				//Orientacion equatorial
				var ori_equat_checkbox = new BABYLON.GUI.Checkbox();
				ori_equat_checkbox.width = "20px";
				ori_equat_checkbox.height = "20px";
				ori_equat_checkbox.color = "white";
				ori_equat_checkbox.background = "green";
				ori_equat_checkbox.top="80px";
				ori_equat_checkbox.left="260px";
				ori_equat_checkbox.horizontalAlignment = al_left;
				ori_equat_checkbox.verticalAlignment = al_top;
				ori_equat_checkbox.isChecked=false;	
				ori_equat_checkbox.onIsCheckedChangedObservable.add(function(value) {
					
					ori_equat=value;
					if (ori_equat==1) {ori_altaz=0;} else {ori_altaz=1;}

					ori_altaz_checkbox.isChecked=ori_altaz;

					actualiza=1;

				});	     
				opt3_rect.addControl(ori_equat_checkbox);


				///Texto de opcion de orientacion equat
				var ori_altaz_cb_text = new BABYLON.GUI.TextBlock();
				ori_altaz_cb_text.text = "Equat"
				ori_altaz_cb_text.color = "white";
				ori_altaz_cb_text.fontSize = 20;
				ori_altaz_cb_text.top="77px";
				ori_altaz_cb_text.left="280px";
				ori_altaz_cb_text.height="30px";
				ori_altaz_cb_text.width = "70px";
				ori_altaz_cb_text.horizontalAlignment = al_left;
				ori_altaz_cb_text.verticalAlignment = al_top;				
				opt3_rect.addControl(ori_altaz_cb_text);


				///Texto de grs offset
				var grs_text = new BABYLON.GUI.TextBlock();
				grs_text.text = "GRS (0º)"
				grs_text.color = "white";
				grs_text.fontSize = 20;
				grs_text.top="115px";
				grs_text.left="00px";
				grs_text.height="30px";
				grs_text.width = "120px";
				grs_text.horizontalAlignment = al_left;
				grs_text.verticalAlignment = al_top;				
				opt3_rect.addControl(grs_text);


				//GRS offset angle
				var grs_slider = new BABYLON.GUI.Slider();
				grs_slider.minimum = -180;
				grs_slider.maximum = 180;
				grs_slider.value = grs_offset_angle;
				grs_slider.step=0.5;
				grs_slider.height = "20px";
				grs_slider.width = "250px";
				grs_slider.top="120px";
				grs_slider.left="150px";
				grs_slider.background = "yellow";
				grs_slider.horizontalAlignment = al_left;
				grs_slider.verticalAlignment = al_top;			
				grs_slider.onValueChangedObservable.add(function(value) {

					grs_offset_angle=grs_slider.value;
					actualiza=1;
					grs_text.text="GRS ("+(Math.round(grs_offset_angle)).toString()+"º)";
							
				});
				grs_slider.onPointerDownObservable.add(function() {sobre_control=1;});
				grs_slider.onPointerUpObservable.add(function() {sobre_control=0;});
				opt3_rect.addControl(grs_slider);
					

				//-------


				//-----
				//Apuntar a...

				//Cuadro de opciones de apuntar a...
				var point_to_rect = new BABYLON.GUI.Rectangle();
				point_to_rect.width = "400px";
				point_to_rect.height = "190px";
				point_to_rect.cornerRadius = 20;
				point_to_rect.color = "Orange";
				point_to_rect.thickness = 4;
				point_to_rect.background = "green";
				point_to_rect.top="0";
				point_to_rect.left="0";
				point_to_rect.horizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_CENTER;
				point_to_rect.verticalAlignment = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_BOTTOM;
				point_to_rect.alpha=0.35;
				point_to_rect.isVisible=0;		
				advancedTexture.addControl(point_to_rect); 
	

				//Boton de apertura y cierre de opciones de apuntar a...
				var point_to_button = BABYLON.GUI.Button.CreateSimpleButton("point_to_button"," None ");
				point_to_button.width = "160px";
				point_to_button.height = "50px";
				point_to_button.color = "white";
				point_to_button.background = "red";
				point_to_button.top="270px";
				point_to_button.left="20px";
				point_to_button.cornerRadius=10;
				point_to_button.horizontalAlignment = al_left;
				point_to_button.verticalAlignment =	al_top;
				point_to_button.textBlock.text="Point to:\n" + "None";						
				point_to_button.onPointerClickObservable.add (function() {

					selector_rect.isVisible=0;
					datetime_rect.isVisible=0;
					opts_rect.isVisible=0;
					dt_rect.isVisible=0;
					if (point_to_rect.isVisible==1) {point_to_rect.isVisible=0;} else {point_to_rect.isVisible=1;}
				});
				advancedTexture.addControl(point_to_button);


				//Texto del selector de planeta de apuntar a...
				var pnp_text = new BABYLON.GUI.TextBlock();
				pnp_text.text = "None";
				pnp_text.color = "white";
				pnp_text.fontSize = 24;
				pnp_text.top="20px";
				pnp_text.left="50px";
				pnp_text.height="60px";
				pnp_text.width = "180px";
				pnp_text.horizontalAlignment = al_left;
				pnp_text.verticalAlignment = al_top;				
				point_to_rect.addControl(pnp_text);


				//Texto del selector de satelite de apuntar a...
				var snp_text = new BABYLON.GUI.TextBlock();
				snp_text.text = "Center";
				snp_text.color = "white";
				snp_text.fontSize = 24;
				snp_text.top="80px";
				snp_text.left="55px";
				snp_text.height="60px";
				snp_text.width = "180px";
				snp_text.horizontalAlignment = al_left;
				snp_text.verticalAlignment = al_top;				
				point_to_rect.addControl(snp_text);


				//Boton de siguiente planeta de apuntar a...
				var ppp_button = BABYLON.GUI.Button.CreateSimpleButton("ppp_button"," > ");
				ppp_button.width = "60px";
				ppp_button.height = "40px";
				ppp_button.color = "white";
				ppp_button.background = "red";
				ppp_button.top="20px";
				ppp_button.left="220px";
				ppp_button.cornerRadius=10;
				ppp_button.horizontalAlignment = al_left;
				ppp_button.verticalAlignment = al_top;							
				ppp_button.onPointerClickObservable.add (function() {

					//if (planet_id==0) return;

					if (planet_point_id>=0) {

						var par=planet_parent[planet_point_id];
						if (par>0) {
							planet_point_id=par;
						}

					} else { }

					planet_point_id++;
					if (planet_point_id>planet_id_max-1) planet_point_id=planet_id_max-1;
					if (planet_point_id==4) planet_point_id=5;
					if (planet_point_id>10) planet_point_id=10;

					if (planet_point_id>=0) {
						pnp_text.text=planet_names[planet_point_id];
						point_to_button.textBlock.text="Point to:\n" + planet_names[planet_point_id];
					} else {
						pnp_text.text="None";
						point_to_button.textBlock.text="Point to:\n" + "None";
					}

					planet_point_sat_id=0;
					snp_text.text="Center";
					actualiza=1;
					change_focus=1;
				
				});
				point_to_rect.addControl(ppp_button); 


				//Boton de planeta anterior de apuntar a...
				var pmp_button = BABYLON.GUI.Button.CreateSimpleButton("pmp_button"," < ");
				pmp_button.width = "60px";
				pmp_button.height = "40px";
				pmp_button.color = "white";
				pmp_button.background = "red";
				pmp_button.top="20px";
				pmp_button.left="10px";
				pmp_button.cornerRadius=10;
				pmp_button.horizontalAlignment = al_left;
				pmp_button.verticalAlignment = al_top;							
				pmp_button.onPointerClickObservable.add (function() {

					//if (planet_id==0) return;

					if (planet_point_id>=0) {

						var par=planet_parent[planet_point_id];
						if (par>0) {
							planet_point_id=par;
						}

					} else { }

					planet_point_id--;
					if (planet_point_id<-1) planet_point_id=-1;
					if (planet_point_id==4) planet_point_id=3;
	
					if (planet_point_id>=0) {
						pnp_text.text=planet_names[planet_point_id];
						point_to_button.textBlock.text="Point to:\n" + planet_names[planet_point_id];
					} else {
						pnp_text.text="None";
						point_to_button.textBlock.text="Point to:\n" + "None";
					}

					planet_point_sat_id=0;
					snp_text.text="Center";
					actualiza=1;
					change_focus=1;

				
				});
				point_to_rect.addControl(pmp_button);


				//Boton de satelite siguiente de apuntar a...
				var spp_button = BABYLON.GUI.Button.CreateSimpleButton("ssp_button"," > ");
				spp_button.width = "60px";
				spp_button.height = "40px";
				spp_button.color = "black";
				spp_button.background = "white";
				spp_button.top="80px";
				spp_button.left="220px";
				spp_button.cornerRadius=10;
				spp_button.horizontalAlignment = al_left;
				spp_button.verticalAlignment = al_top;							
				spp_button.onPointerClickObservable.add (function() {

					if (planet_point_id==-1) return;
					//if (planet_id==0) return;

					var par=planet_parent[planet_point_id];
					if (par<=0) par=planet_point_id;
				
					planet_point_sat_id++;
					if (planet_point_sat_id>planet_sat_n[par]) planet_point_sat_id=planet_sat_n[par];

					planet_point_id=planet_sat[par][planet_point_sat_id];

					snp_text.text = planet_names[planet_point_id];
					point_to_button.textBlock.text = "Point to:\n" + planet_names[planet_point_id];
					if (planet_point_sat_id==0) {
						snp_text.text="Center";
						point_to_button.textBlock.text="Point to:\n" + planet_names[par];
					}
					actualiza=1;
					change_focus=1;
									
				});
				point_to_rect.addControl(spp_button); 


				//Boton de satelite anterior de apuntar a...
				var smp_button = BABYLON.GUI.Button.CreateSimpleButton("smp_button"," < ");
				smp_button.width = "60px";
				smp_button.height = "40px";
				smp_button.color = "black";
				smp_button.background = "white";
				smp_button.top="80px";
				smp_button.left="10px";
				smp_button.cornerRadius=10;
				smp_button.horizontalAlignment = al_left;
				smp_button.verticalAlignment = al_top;							
				smp_button.onPointerClickObservable.add (function() {

					if (planet_point_id==-1) return;
					//if (planet_id==0) return;

					var par=planet_parent[planet_point_id];
					if (par<=0) par=planet_point_id;
				
					planet_point_sat_id--;
					if (planet_point_sat_id<0) planet_point_sat_id=0;

					planet_point_id=planet_sat[par][planet_point_sat_id];

					snp_text.text = planet_names[planet_point_id];
					point_to_button.textBlock.text ="Point to:\n" +  planet_names[planet_point_id];
					if (planet_point_sat_id==0) {
						snp_text.text="Center";
						point_to_button.textBlock.text="Point to:\n" + planet_names[par];
					}
					actualiza=1;
					change_focus=1;


				});
				point_to_rect.addControl(smp_button);


				//Botón de cierre del menu apuntar a...
				var point_to_close_button = BABYLON.GUI.Button.CreateSimpleButton("point_to_close_button"," Close ");
				point_to_close_button.width = "370px";
				point_to_close_button.height = "30px";
				point_to_close_button.color = "black";
				point_to_close_button.background = "white";
				point_to_close_button.top="140px";
				point_to_close_button.left="10px";
				point_to_close_button.cornerRadius=10;
				point_to_close_button.horizontalAlignment = al_left;
				point_to_close_button.verticalAlignment =	al_top;						
				point_to_close_button.onPointerClickObservable.add (function() {

					point_to_rect.isVisible=0;

				});
				point_to_rect.addControl(point_to_close_button);


				//Botón de opción colocar la cámara sobre el planeta
				var over_button = BABYLON.GUI.Button.CreateSimpleButton("over_button","OVER");
				over_button.width = "70px";
				over_button.height = "100px";
				over_button.color = "black";
				over_button.background = "white";
				over_button.top="20px";
				over_button.left="310px";
				over_button.cornerRadius=10;
				over_button.horizontalAlignment = al_left;
				over_button.verticalAlignment =	al_top;						
				over_button.onPointerClickObservable.add (function() {

					//if (planet_id==0) return;

					actualiza=1;
					change_focus=1;

					if (over_planet==0) {over_planet=1;} else {over_planet=0;}

					if (over_planet==0) {

						over_button.color = "black";
						over_button.background = "white";

						planet_point_id=-1;
						planet_point_sat_id=0;
				
						pnp_text.text="None";
						snp_text.text="Center";
						point_to_button.textBlock.text="Point to:\n" + "None";

					} else {

						over_button.color = "white";
						over_button.background = "green";
					
						planet_point_id=planet_id;
						planet_point_sat_id=planet_sat_id;

						var par=planet_parent[planet_point_id];

						if (par==0 || par==-1) {

							pnp_text.text=planet_names[planet_point_id];
							snp_text.text="Center";
							point_to_button.textBlock.text="Point to:\n" + planet_names[planet_point_id];


						} else {

							pnp_text.text=planet_names[par];
							snp_text.text=planet_names[planet_sat[par][planet_point_sat_id]];
							point_to_button.textBlock.text="Point to:\n" + planet_names[planet_sat[par][planet_point_sat_id]];

						}
			
					}
					

				});
				point_to_rect.addControl(over_button);

				/*
				console.log(camera2.minZ,camera2.maxZ);
				camera2.minZ=0.1;
				camera2.maxZ=40;
				*/

				/*	
				var u_slider = new BABYLON.GUI.Slider();
				u_slider.minimum = 0.000001;
				u_slider.maximum = 0.000001*1000;
				u_slider.value = 0.000001;
				u_slider.step=0.000001;
				u_slider.height = "20px";
				u_slider.width = "250px";
				u_slider.top="400px";
				u_slider.left="10px";
				u_slider.background = "white";
				u_slider.horizontalAlignment = al_left;
				u_slider.verticalAlignment = al_top;			
				u_slider.onValueChangedObservable.add(function(value) {

					//sph1[11].material.diffuseTexture.uOffset=value;
					//control0=value;
					camera2.minZ=value;
					actualiza=1;
				
				});
				advancedTexture.addControl(u_slider);
				
				
				var v_slider = new BABYLON.GUI.Slider();
				v_slider.minimum = 1;
				v_slider.maximum = 100;
				v_slider.value = 1;
				v_slider.step=1;
				v_slider.height = "20px";
				v_slider.width = "250px";
				v_slider.top="440px";
				v_slider.left="10px";
				v_slider.background = "white";
				v_slider.horizontalAlignment = al_left;
				v_slider.verticalAlignment = al_top;			
				v_slider.onValueChangedObservable.add(function(value) {

					camera2.maxZ=value;
					actualiza=1;
				
				});
				advancedTexture.addControl(v_slider);
				*/
				

				//-----
				//END GUI


				//Acceso a los planetas mediante sprites seleccionables
				sprite_planet=[];
				sprite_planets = new BABYLON.SpriteManager("sprite_planets", "images/sprite_02.png", 11, 64);

				for (var ii=1;ii<=10;ii++) {
					if (ii==4) continue;
					sprite_planet[ii]=new BABYLON.Sprite(ii,sprite_planets);
					sprite_planet[ii].cellIndex = ii;

					var dpc=BABYLON.Vector3.Distance(planet_pos[ii],camera.position);

					var sf=Math.atan(0.1/dpc);

					sprite_planet[ii].position=planet_pos[ii];
					sprite_planet[ii].size=0.005/sf;
					sprite_planet[ii].isPickable=false;
					sprite_planet[ii].isVisible=false;
				}
				if (planet_id<=10 && planet_id!=4) {
					sprite_planet[planet_id].isVisible=false;
					sprite_planet[planet_id].isPickable=false;
					sprite_planet[planet_id].size=0;
				}
				
				sprite_planets.isPickable=true;
				//-----


				c_a=camera.alpha;
				c_b=camera.beta;
				c_r=camera.radius;
				cambia_botones_de_planeta=0;

				cnt2=0;
				cont3=0;
				c_target=camera.target;
				animacion_camara=0;

				ano_min=1900;
				ano_max=2100;

				//Función principal de actualización 
				scene.registerBeforeRender(function () {

					var render=0;
					cont++;
					if (cont%2!=0) {return;}
					cont3++;

					//Actualiza los cambios de fecha y hora
					if (change_date==1) {

						if (fecha[0]<0) fecha[0]=1;
						if (fecha[1]<0) fecha[1]=1;
						if (fecha[1]>12) fecha[1]=12;
						if (fecha[2]<ano_min) fecha[2]=ano_min;
						if (fecha[2]>ano_max) fecha[2]=ano_max;
						if (fecha[3]<0) fecha[3]=0;
						if (fecha[3]>23) fecha[3]=23;
						if (fecha[4]<0) fecha[4]=0;
						if (fecha[4]>59) fecha[4]=59;
						if (fecha[5]<0) fecha[5]=0;
						if (fecha[5]>59) fecha[5]=59;

						var meses=[31,28,31,30,31,30,31,31,30,31,30,31];
						if (fecha[2]%4==0) meses[1]=29;
						if (fecha[2]==2100) meses[1]=28;
						if (fecha[2]==1900) meses[1]=28;
						var dias_mes=fecha[1]-1;

						if (fecha[0]>meses[fecha[1]-1]) fecha[0]=meses[fecha[1]-1];


						datetime_text.text = fecha[0].toString().padStart(2,"0") + " " +
											fecha[1].toString().padStart(2,"0") + " " +
											fecha[2].toString() + "  " + "\n" +
											fecha[3].toString().padStart(2,"0") + ":" +
											fecha[4].toString().padStart(2,"0") + ":" +
											fecha[5].toString().padStart(2,"0");
						

						datetime_rect_text.text = fecha[0].toString().padStart(2,"0") + "  " +
											fecha[1].toString().padStart(2,"0") + "  " +
											fecha[2].toString() + "  " +
											fecha[3].toString().padStart(2,"0") + " : " +
											fecha[4].toString().padStart(2,"0") + " : " +
											fecha[5].toString().padStart(2,"0");


						jd=calc_jd(fecha);
						fecha_local=calc_fecha(jd+utc_zone/24.0);

						localtime_text.text = fecha_local[0].toString().padStart(2,"0") + " " +
												fecha_local[1].toString().padStart(2,"0") + " " +
												fecha_local[2].toString() + " " + 
												fecha_local[3].toString().padStart(2,"0") + ":" +
												fecha_local[4].toString().padStart(2,"0") + ":" +
												fecha_local[5].toString().padStart(2,"0");

						//Actualizacion de la fecha juliana ???---
						jd_text.text="JD  "+ (Math.floor(jd*100000)/100000).toString();
						actualiza=1;
						cambia_botones_de_planeta=1;
						change_date=0;

					}


					//Actualiza los cambios de fecha y hora seleccionados con el raton
					if (change_date_mw) {

						if (fecha[2]<ano_min) fecha[2]=ano_min;
						if (fecha[2]>ano_max) fecha[2]=ano_max;

						var meses=[31,28,31,30,31,30,31,31,30,31,30,31];
						if (fecha[2]%4==0) meses[1]=29;
						if (fecha[2]==2100) meses[1]=28;
						if (fecha[2]==1900) meses[1]=28;

						if (fecha[5]>59) {fecha[5]=0;fecha[4]++;}
						if (fecha[4]>59) {fecha[4]=0;fecha[3]++;}
						if (fecha[3]>23) {fecha[3]=0;fecha[0]++;}

						if (fecha[0]>meses[fecha[1]-1]) {fecha[0]=1;fecha[1]++;}
						if (fecha[1]>12 && fecha[2]<ano_min) {fecha[1]=1;fecha[2]++;}
						if (fecha[1]>12 && fecha[2]==ano_max) {fecha[1]=12;fecha[2]=ano_max;}


						if (fecha[5]<0) {fecha[5]=59;fecha[4]--;}
						if (fecha[4]<0) {fecha[4]=59;fecha[3]--;}
						if (fecha[3]<0) {fecha[3]=23;fecha[0]--;}

						if (fecha[0]<1 && fecha[1]>1) {fecha[1]--;fecha[0]=meses[fecha[1]-1];}
						if (fecha[0]<1 && fecha[1]==1) {fecha[1]=12;fecha[2]--;fecha[0]=meses[fecha[1]-1];} 

						if (fecha[1]<1 && fecha[2]>ano_min) {fecha[1]=12;fecha[2]--;}
						if (fecha[1]<1 && fecha[2]==ano_min) {fecha[1]=1;fecha[2]=ano_min;}

						if (fecha[1]>12 && fecha[2]>ano_min) {
							fecha[1]=1;
							fecha[2]++;
							

						}


						datetime_text.text = fecha[0].toString().padStart(2,"0") + " " +
											fecha[1].toString().padStart(2,"0") + " " +
											fecha[2].toString() + "  " + "\n" +
											fecha[3].toString().padStart(2,"0") + ":" +
											fecha[4].toString().padStart(2,"0") + ":" +
											fecha[5].toString().padStart(2,"0");
						

						datetime_rect_text.text = fecha[0].toString().padStart(2,"0") + "  " +
											fecha[1].toString().padStart(2,"0") + "  " +
											fecha[2].toString() + "  " +
											fecha[3].toString().padStart(2,"0") + " : " +
											fecha[4].toString().padStart(2,"0") + " : " +
											fecha[5].toString().padStart(2,"0");


						jd=calc_jd(fecha);
						fecha_local=calc_fecha(jd+utc_zone/24.0)

						localtime_text.text = fecha_local[0].toString().padStart(2,"0") + " " +
												fecha_local[1].toString().padStart(2,"0") + " " +
												fecha_local[2].toString() + " " + 
												fecha_local[3].toString().padStart(2,"0") + ":" +
												fecha_local[4].toString().padStart(2,"0") + ":" +
												fecha_local[5].toString().padStart(2,"0");

						//Actualizacion de la fecha juliana ???---
						jd_text.text="JD  "+ (Math.floor(jd*100000)/100000).toString();

						actualiza=1;
						cambia_botones_de_planeta=1;
						change_date_mw=0;

					}


					//Cambio del intervalo de animacion
					if (cambia_dt==1) {

						if (dtv[3]>59) dtv[3]=0;
						if (dtv[3]<0) dtv[3]=59;

						if (dtv[2]>59) dtv[2]=0;
						if (dtv[2]<0) dtv[2]=59;

						if (dtv[1]>23) dtv[1]=0;
						if (dtv[1]<0) dtv[1]=23;

						if (dtv[0]>999) dtv[0]=999;
						if (dtv[0]<0) dtv[0]=0;

						dt_rect_text.text =  dtv[0].toString().padStart(3,"0") + "  " +
												dtv[1].toString().padStart(2,"0") + " : " +
												dtv[2].toString().padStart(2,"0") + " : " +
												dtv[3].toString().padStart(2,"0");
					
						
						dt_multiplier=dtv[0]+dtv[1]/24.0+dtv[2]/1440.0+dtv[3]/86400.0;

						cambia_dt=0;
					}


					//Opcion general de actualizacion
					if (actualiza==1) {

						planet_rotation();
						calc_all_planets(jd);
						corrige_baricentro();
						calc_orbits();
						calc_lat_lon_pos()
						mueve_todo();
						//calcula_sombras();
						actualiza=0;
						render=1;
						cambia_botones_de_planeta=1;

						if (planet_point_id==-1) {
							scene.activeCamera=camera;
						} else {
							scene.activeCamera=camera2;
						}
						
					}
			    	

					//Opcion general de animacion
					if (animacion==1) {

						jd=jd+dt_multiplier*time_control;
						fecha=calc_fecha(jd);
						fecha_local=calc_fecha(jd+utc_zone/24.0)

						datetime_text.text = fecha[0].toString().padStart(2,"0") + " " +
											fecha[1].toString().padStart(2,"0") + " " +
											fecha[2].toString() + "  " + "\n" +
											fecha[3].toString().padStart(2,"0") + ":" +
											fecha[4].toString().padStart(2,"0") + ":" +
											fecha[5].toString().padStart(2,"0");
						

						datetime_rect_text.text = fecha[0].toString().padStart(2,"0") + "  " +
											fecha[1].toString().padStart(2,"0") + "  " +
											fecha[2].toString() + "  " +
											fecha[3].toString().padStart(2,"0") + " : " +
											fecha[4].toString().padStart(2,"0") + " : " +
											fecha[5].toString().padStart(2,"0");

						localtime_text.text = fecha_local[0].toString().padStart(2,"0") + " " +
												fecha_local[1].toString().padStart(2,"0") + " " +
												fecha_local[2].toString() + " " + 
												fecha_local[3].toString().padStart(2,"0") + ":" +
												fecha_local[4].toString().padStart(2,"0") + ":" +
												fecha_local[5].toString().padStart(2,"0");


						//Actualizacion de la fecha juliana ???---
						jd_text.text="JD  "+ (Math.floor(jd*100000)/100000).toString();
						

						planet_rotation();
						calc_all_planets(jd);
						corrige_baricentro();
						calc_orbits();
						calc_lat_lon_pos()
						mueve_todo();
						//calcula_sombras();
						render=1;
						cambia_botones_de_planeta=1;

						if (animacion_paso==1) {
							animacion=0;
							animacion_paso=0;
						}

						if (planet_point_id==-1) {
							scene.activeCamera=camera;
						} else {
							scene.activeCamera=camera2;
						}

					}

					//Opciones del zoom mediante la rueda del raton
					//if (camera.radius>10) camera.wheelDeltaPercentage=0.1;
					if (camera.radius<10) camera.wheelDeltaPercentage=0.03;
					if (camera.radius<1) camera.wheelDeltaPercentage=0.03;

					//if (camera.radius>10) camera.pinchDeltaPercentage=0.1;
					if (camera.radius<10) camera.pinchDeltaPercentage=0.03;
					if (camera.radius<1) camera.pinchDeltaPercentage=0.03;
					

					//Cambio de foco hacia otro planeta o satelite
					if (change_focus==1) {

						var sph2_scale=sph2.absoluteScaling;
						sph2.scaling=new BABYLON.Vector3(1.0/sph2_scale.x,1.0/sph2_scale.y,1.0/sph2_scale.z);					
						sph2.scaling=new BABYLON.Vector3(lat_lon_rad,lat_lon_rad,lat_lon_rad);

						if (planet_id>0) {
	
							var dr=planet_pos[planet_id].subtract(planet_pos[0]);
							dr.normalize();

							cam_alpha=Math.atan2(-dr.z,-dr.x)+(Math.random()*2-1)*Math.PI*0.25;

						} else {

							cam_alpha=(Math.random()*2-1)*2*Math.PI
						}

						camera.alpha=cam_alpha;

						if (planet_id==planet_point_id) {

							camera2.target=planet_pos[0];
							camera2.position=lat_lon_pos;
							if (planet_id==0) camera2.target=planet_pos[3];

							c2t=camera2.target;

							pro_z=BABYLON.Vector3.Dot(c2t,ouz);
							pro_e=BABYLON.Vector3.Dot(c2t,oue);
							pro_n=BABYLON.Vector3.Dot(c2t,oun);

							camera2.fov=0.8;
							//fov_slider.value=Math.pow(camera2.fov/0.8,1/3.0);
							fov_slider.value=Math.cbrt(camera2.fov/0.8);
							fov_text.text = "FOV: " + (Math.floor(((camera2.fov)*rtod)*1000)/1000).toString()+"º";

						} else { }

						if (planet_point_id==-1) {

							camera2.fov=0.8;
							camera.fov=0.8;
							//fov_slider.value=Math.pow(camera2.fov/0.8,1/3.0);
							fov_slider.value=Math.cbrt(camera2.fov/0.8);
							fov_text.text = "FOV: " + (Math.floor(((camera2.fov)*rtod)*1000)/1000).toString()+"º";

						}

						render=1;

						trastoca_luces();

					}

					//Camara apunta al centro de planeta
					if (render==0 && planet_point_id==-1) {

						cam_radius=camera.radius;
						cam_alpha=camera.alpha;
						cam_beta=camera.beta;
						scene.activeCamera=camera;

					}

					//Camara apunta al centro de satelite
					if (render==0 && planet_point_id>=0 && planet_id!=planet_point_id) {

						camera.position=lat_lon_pos;
						camera.target=planet_pos[planet_point_id];

						camera2.position=lat_lon_pos;
						camera2.target=planet_pos[planet_point_id];

					}

	
					//Camara sobre el planeta
					if (render==0 && planet_id==planet_point_id) {
					
						c2t=camera2.target;
						camera2.upVector.copyFrom(upv);

						pro_z=BABYLON.Vector3.Dot(c2t,ouz);
						pro_e=BABYLON.Vector3.Dot(c2t,oue);
						pro_n=BABYLON.Vector3.Dot(c2t,oun);

					}


					//Actuazliacion relacionadas con el movimiento de la camara
					if (c_a-camera.alpha!=0 || c_b-camera.beta!=0 || c_r-camera.radius!=0 || cambia_botones_de_planeta==1)  {

						
						//---------
						//Actualizacion del tamaño de la esfera de glow
						/*					
						var dx1=camera.position.x-sph1[0].position.x;
						var dy1=camera.position.y-sph1[0].position.y;
						var dz1=camera.position.z-sph1[0].position.z;
						var dd1=Math.sqrt(dx1*dx1+dy1*dy1+dz1*dz1);
						*/

						var dd1=BABYLON.Vector3.Distance(sph1[0].position,camera.position);


						var as=glow_sph.absoluteScaling;
						var ias=1.0/as.x;
						glow_sph.scaling=new BABYLON.Vector3(ias.x,ias.y,ias.z);
					
						var sc1=2*dd1;					
						glow_sph.scaling=new BABYLON.Vector3(sc1,sc1,sc1);
						//----------
					

						//Modo interactivo de seleccion de planetas y satelites
						if (modo_interactivo==true) {

							for (var ii=1;ii<=10;ii++) {

								if (ii==4) continue;
							
								var dpc=BABYLON.Vector3.Distance(planet_pos[ii],camera.position);

								var sf=Math.atan(0.1/dpc);

								sprite_planet[ii].position=planet_pos[ii];
								sprite_planet[ii].size=0.005/sf;
								sprite_planet[ii].isVisible=true;
								sprite_planet[ii].isPickable=true;
							}
					
							if (planet_id<=10 && planet_id!=4 && planet_id!=0) {
								sprite_planet[planet_id].isVisible=false;
								sprite_planet[planet_id].isPickable=false;
								var dpc=BABYLON.Vector3.Distance(planet_pos[planet_id],camera.position);
							   if (dpc>1) {sprite_planet[planet_id].isVisible=true;}

							}
							if (planet_id>10 || planet_id==4) {
								var par=planet_parent[planet_id];
								sprite_planet[par].isVisible=0;
								sprite_planet[par].isPickable=0;
								var dpc=BABYLON.Vector3.Distance(planet_pos[par],camera.position);
							   if (dpc>1) {sprite_planet[par].isVisible=true;}

							}

							
						}

						if (head_coordinates==1 && cont3%2==0) {

							var vcam=camera.target.subtract(camera.position);

							vcam.normalize();
					
							var cam_ecl_lon=Math.atan2(vcam.z,vcam.x);
							var cam_pl=Math.sqrt(vcam.x*vcam.x+vcam.z*vcam.z);
							var cam_ecl_lat=Math.atan(vcam.y/cam_pl);

							var sin_cam_ecl_lon=Math.sin(cam_ecl_lon);

							var cam_ra=Math.atan2((sin_cam_ecl_lon*cos_tilt-Math.tan(cam_ecl_lat)*sin_tilt),Math.cos(cam_ecl_lon));
							var cam_de=Math.asin(Math.sin(cam_ecl_lat)*cos_tilt+Math.cos(cam_ecl_lat)*sin_tilt*sin_cam_ecl_lon);

							cam_ra=cam_ra*rtoh;
							cam_de=cam_de*rtod;

							if (cam_ra<0) cam_ra+=24;

							cam_ra=Math.floor(cam_ra*100.0)/100;
							cam_de=Math.floor(cam_de*100.0)/100;

							head_text.text = "RA " + cam_ra.toString() + "  DEC " + cam_de.toString() + " | Alt " + "--.-" + " Az " + "--.-";
						}


						c_a=camera.alpha;
						c_b=camera.beta;
						c_r=camera.radius;
						cambia_botones_de_planeta=0;

					}


					if (render==1) {

						for (var ii=0;ii<n_objetos;ii++) {

							lines[ii].setVerticesData(BABYLON.VertexBuffer.PositionKind, s_o_1[ii]);
							//..//				
							/*
							lines[ii].dispose();
							lines[ii] =BABYLON.MeshBuilder.CreateLines ( "orbital_line", {updatable: true,points: seg_orbs[ii]},scene,true);  
							lines[ii].color = new BABYLON.Color3(1, 1, 1);
							lines[ii].alpha=orbits_alpha;
							lines[ii].freezeNormals();
							*/
							//..//

							sph1[ii].position=planet_pos[ii];

							sph1[ii].rotation=new BABYLON.Vector3(0, 0, 0);

							//Diurnal motion
							sph1[ii].rotate(BABYLON.Axis.Y, planet_w[ii], BABYLON.Space.WORLD);
							sph1[ii].rotate(BABYLON.Axis.X, 0.0, BABYLON.Space.WORLD);
							sph1[ii].rotate(BABYLON.Axis.Z, 0.0, BABYLON.Space.WORLD);

							//Axial Tilt
							sph1[ii].rotate(BABYLON.Axis.X, planet_ori1[ii], BABYLON.Space.WORLD);
							sph1[ii].rotate(BABYLON.Axis.Y, planet_ori2[ii], BABYLON.Space.WORLD);
							sph1[ii].rotate(BABYLON.Axis.Z, 0.0, BABYLON.Space.WORLD);
						
						}


						//---
						planet_line.dispose();
						if (planet_lineo_id==planet_lined_id) {
					
							planet_line_data[0]=planet_pos[planet_lineo_id];
							planet_line_data[1]=planet_pos[planet_lined_id];
	

						} else {

							if (planet_id!=planet_lineo_id) {

								var line_ini=planet_pos[planet_lineo_id];
								var line_end=planet_pos[planet_lined_id];

							} else {
					
								var line_ini=lat_lon_pos;
								var line_end=planet_pos[planet_lined_id];			

							}

							var uline=line_end.subtract(line_ini);
							uline.normalize();
							var dp=9000;

							planet_line_data[0]=line_ini;
							planet_line_data[1]=new BABYLON.Vector3(line_ini.x+dp*uline.x,line_ini.y+dp*uline.y,line_ini.z+dp*uline.z);

						}

						//..//planet_line=BABYLON.Mesh.CreateLines ( "planet_line", planet_line_data,scene); 
						planet_line=BABYLON.MeshBuilder.CreateLines( "planet_line",{points: planet_line_data},scene,true)
						planet_line.color = new BABYLON.Color3(1, 1, 1);
						planet_line.alpha=1;

						if (planet_lineo_id!=planet_lined_id) {

							planet_traj_data[planet_traj_n]=planet_line_data[1];

							var dtr=BABYLON.Vector3.Distance(planet_traj_data[planet_traj_n],planet_traj_data[planet_traj_n-1]);
							dtr*=1.0/9000.0*rtod;

							if (isNaN(dtr)==0 && dtr>5.0) {
								planet_traj_data[planet_traj_n]=new BABYLON.Vector3(NaN,NaN,NaN);
							}

							planet_traj_n++;


							if (planet_traj_n>1000) {

								planet_traj_data.splice(2,1);
								planet_traj_n=1000;

							}

							planet_traj.dispose();
							//..//planet_traj=BABYLON.Mesh.CreateLines ( "planet_line", planet_traj_data,scene,true); 
							planet_traj=BABYLON.MeshBuilder.CreateLines("planet_line",{points: planet_traj_data},scene);
							planet_traj.color=new BABYLON.Color3(1,0,0);
							planet_traj.alpha=1.0;

						}
						//---


						sph2.position=lat_lon_pos;
						glow_sph.position=sph1[0].position;
						fake_earth.position=planet_pos[3];
						fake_moon.position=planet_pos[4];


						//Sombras
						calcula_sombras();

						lines_umbra.dispose();
						//..//lines_umbra=BABYLON.Mesh.CreateLines ( "lines ", lines_umbra_pos,scene);
						lines_umbra=BABYLON.MeshBuilder.CreateLines ( "lines ", {points: lines_umbra_pos},scene);
						lines_umbra.color = new BABYLON.Color3(1, 0, 0);

						lines_penumbra.dispose();
						//..//lines_penumbra=BABYLON.Mesh.CreateLines ( "lines1 ", lines_penumbra_pos,scene); 
						lines_penumbra=BABYLON.MeshBuilder.CreateLines ( "lines1 ", {points: lines_penumbra_pos},scene); 
						lines_penumbra.color = new BABYLON.Color3(1, 1, 0);
											

						//Saturn ring update
						saturn_ring.position=planet_pos[7];
						saturn_ring.rotation=new BABYLON.Vector3(0,0,0);
						//Axial Tilt
						saturn_ring.rotate(BABYLON.Axis.X, planet_ori1[7], BABYLON.Space.WORLD);
						saturn_ring.rotate(BABYLON.Axis.Y, planet_ori2[7], BABYLON.Space.WORLD);
						saturn_ring.rotate(BABYLON.Axis.Z, 0.0, BABYLON.Space.WORLD);
						//


						//uranus ring update
						uranus_ring.position=planet_pos[8];
						uranus_ring.rotation=new BABYLON.Vector3(0,0,0);
						//Axial Tilt
						uranus_ring.rotate(BABYLON.Axis.X, planet_ori1[8], BABYLON.Space.WORLD);
						uranus_ring.rotate(BABYLON.Axis.Y, planet_ori2[8], BABYLON.Space.WORLD);
						uranus_ring.rotate(BABYLON.Axis.Z, 0.0, BABYLON.Space.WORLD);
						//

						
						//neptune ring update
						neptune_ring.position=planet_pos[9];
						neptune_ring.rotation=new BABYLON.Vector3(0,0,0);
						//Axial Tilt
						neptune_ring.rotate(BABYLON.Axis.X, planet_ori1[9], BABYLON.Space.WORLD);
						neptune_ring.rotate(BABYLON.Axis.Y, planet_ori2[9], BABYLON.Space.WORLD);
						neptune_ring.rotate(BABYLON.Axis.Z, 0.0, BABYLON.Space.WORLD);
						//

						//Camera update
						camera.target=planet_pos[planet_id];
						camera.radius=cam_radius;
						//camera.alpha=cam_alpha;
						//camera.beta=cam_beta;

						
						lines_local_horizon.dispose();
						//..//lines_local_horizon=BABYLON.Mesh.CreateLines ( "lines ", local_horizon,scene); 
						lines_local_horizon=BABYLON.MeshBuilder.CreateLines( "lines", {points: local_horizon},scene);
						lines_local_horizon.color = new BABYLON.Color3(0, 1, 0);
						lines_local_horizon.alpha=0.25;
						lines_local_horizon.isVisible=false;
						if (planet_id==planet_point_id) {
							lines_local_horizon.isVisible=true;
						}
						//lines_local_horizon.isVisible=true;


						for (var ii=0;ii<fake_sun_n;ii++) {
							
							var ii1=fake_sun_list[ii];

							//..//
							/*
							var lp=new BABYLON.Vector3(0,0,0);
							var dx,dy,dz,d;
							dx=planet_pos[0].x-planet_pos[ii1].x;
							dy=planet_pos[0].y-planet_pos[ii1].y;
							dz=planet_pos[0].z-planet_pos[ii1].z;
							d=Math.sqrt(dx*dx+dy*dy+dz*dz);
							dx/=d;dy/=d;dz/=d;

							lp.x=planet_pos[ii1].x+fake_sun_distance[ii]*dx;
							lp.y=planet_pos[ii1].y+fake_sun_distance[ii]*dy;
							lp.z=planet_pos[ii1].z+fake_sun_distance[ii]*dz;
							light[ii].position=lp;
							*/
							//..//

							var fsp0=planet_pos[0].subtract(planet_pos[ii1]);
							fsp0.normalize();

							fsp0.scaleInPlace(fake_sun_distance[ii]);
							light[ii].position=planet_pos[ii1].add(fsp0);
							
							var dire_sun=new BABYLON.Vector3(planet_pos[ii1].x-planet_pos[0].x,planet_pos[ii1].y-planet_pos[0].y,planet_pos[ii1].z-planet_pos[0].z);
							light[ii].direction=dire_sun;
							
						}
						//


						if (planet_point_id>=0 && planet_point_id!=planet_id) {

							//camera.position=lat_lon_pos;
							//camera.target=planet_pos[planet_point_id];

							camera2.position=lat_lon_pos;
							camera2.target=planet_pos[planet_point_id];

						}


						if (planet_point_id>=0 && planet_point_id==planet_id) {

							camera2.position=lat_lon_pos;
							
							if (alt_az_lock==1) {

								c2t.x=pro_z*ouz.x+pro_e*oue.x+pro_n*oun.x;
								c2t.y=pro_z*ouz.y+pro_e*oue.y+pro_n*oun.y;
								c2t.z=pro_z*ouz.z+pro_e*oue.z+pro_n*oun.z;

								camera2.target=c2t;
							}
							
							camera2.upVector.copyFrom(upv);
							
						}


						if (change_focus==1) {
							camera.radius=planet_rad[planet_id]*i_ua_km*7;
							camera.lowerRadiusLimit=planet_rad[planet_id]*i_ua_km*4;	
							change_focus=0;
						}


						if (modo_interactivo==true) {

							for (var ii=1;ii<=10;ii++) {

								if (ii==4) continue;
							
								var dpc=BABYLON.Vector3.Distance(planet_pos[ii],camera.position);

								var sf=Math.atan(0.1/dpc);

								sprite_planet[ii].position=planet_pos[ii];
								sprite_planet[ii].size=0.005/sf;
								sprite_planet[ii].isVisible=true;
								sprite_planet[ii].isPickable=true;
							}
					
							if (planet_id<=10 && planet_id!=4 && planet_id!=0) {
								sprite_planet[planet_id].isVisible=false;
								sprite_planet[planet_id].isPickable=false;
								var dpc=BABYLON.Vector3.Distance(planet_pos[planet_id],camera.position);
							   if (dpc>1) {sprite_planet[planet_id].isVisible=true;}

							}
							if (planet_id>10 || planet_id==4) {
								var par=planet_parent[planet_id];
								sprite_planet[par].isVisible=0;
								sprite_planet[par].isPickable=0;
								var dpc=BABYLON.Vector3.Distance(planet_pos[par],camera.position);
							   if (dpc>1) {sprite_planet[par].isVisible=true;}

							}
							
						}

						
						if (head_coordinates==1) {

							if (planet_point_id==-1) {
								
								var vcam=camera.target.subtract(camera.position);

								vcam.normalize();
					
								var cam_ecl_lon=Math.atan2(vcam.z,vcam.x);
								var cam_pl=Math.sqrt(vcam.x*vcam.x+vcam.z*vcam.z);
								var cam_ecl_lat=Math.atan(vcam.y/cam_pl);

								var sin_cam_ecl_lon=Math.sin(cam_ecl_lon);

								var cam_ra=Math.atan2((sin_cam_ecl_lon*cos_tilt-Math.tan(cam_ecl_lat)*sin_tilt),Math.cos(cam_ecl_lon));
								var cam_de=Math.asin(Math.sin(cam_ecl_lat)*cos_tilt+Math.cos(cam_ecl_lat)*sin_tilt*sin_cam_ecl_lon);

								cam_ra=cam_ra*rtoh;
								cam_de=cam_de*rtod;

								if (cam_ra<0) cam_ra+=24;

								cam_ra=Math.floor(cam_ra*100.0)/100;
								cam_de=Math.floor(cam_de*100.0)/100;

								head_text.text = "RA " + cam_ra.toString() + "  DEC " + cam_de.toString() + " | Alt " + "--.-" + " Az " + "--.-";
								
						
							} else {


								var vcam=camera2.target.subtract(camera2.position);

								vcam.normalize();
					
								var cam_ecl_lon=Math.atan2(vcam.z,vcam.x);
								var cam_pl=Math.sqrt(vcam.x*vcam.x+vcam.z*vcam.z);
								var cam_ecl_lat=Math.atan(vcam.y/cam_pl);

								var sin_cam_ecl_lon=Math.sin(cam_ecl_lon);

								var cam_ra=Math.atan2((sin_cam_ecl_lon*cos_tilt-Math.tan(cam_ecl_lat)*sin_tilt),Math.cos(cam_ecl_lon));
								var cam_de=Math.asin(Math.sin(cam_ecl_lat)*cos_tilt+Math.cos(cam_ecl_lat)*sin_tilt*sin_cam_ecl_lon);

								cam_ra=cam_ra*rtoh;
								cam_de=cam_de*rtod;

								if (cam_ra<0) cam_ra+=24;

								cam_ra=Math.floor(cam_ra*100.0)/100;
								cam_de=Math.floor(cam_de*100.0)/100;


								var cam_az=Math.atan2(pro_e,pro_n);
								cam_pl=Math.sqrt(pro_n*pro_n+pro_e*pro_e);
								var cam_alt=Math.atan(pro_z/cam_pl);

								cam_az=cam_az*rtod;
								cam_alt=cam_alt*rtod;

								if (cam_az<0) cam_az+=360;
								if (cam_az>360) cam_az-=360;

								cam_alt=Math.floor(cam_alt*10.0)/10;
								cam_az=Math.floor(cam_az*10.0)/10;


								head_text.text = "RA " + cam_ra.toString() + 
													  "  DEC " + cam_de.toString() + 
                                         " | Alt " + cam_alt.toString() + 
													  " Az " + cam_az.toString();

								if (ori_equat==1) {
									head_text.text = "RA " + cam_ra.toString() + "  DEC " + cam_de.toString() + " | Alt " + "--.-" + " Az " + "--.-";
								}

							}
						}
						

						trastoca_luces();

						render=0;

					}
					

				});

				
				atc01=0;
				atc02=0;
				c2tt=new BABYLON.Vector3(0,0,0);

				var getScreenPosition = function () {
        
        			return [scene.pointerX,scene.pointerY]

    			}


				scene.onPointerObservable.add((pointerInfo) => {

					//Si está modificando uno de los controles, ignora estas opciones					
					if (sobre_control==1) return;


					//Control del modo interactivo
					if (pointerInfo.event.buttons==1 && modo_interactivo==1 && planet_point_id==-1 && pointerInfo.event.button==0) {

						//console.log(pointerInfo.event.button);

						camera.minZ=0.001;

						var pickResult = scene.pickSprite(pointerInfo.event.x, pointerInfo.event.y);
					
						if (pickResult.hit && planet_id!=planet_point_id) {
						
							planet_id=parseInt(pickResult.pickedSprite.name);
							actualiza=1;
							change_focus=1;
							planet_point_id=-1;
							selector_button.textBlock.text="View:\n" + planet_names[planet_id]+":Center";
							planet_sat_id=0;
							pn_text.text = planet_names[planet_id];
							sn_text.text="Center";

						}

						camera.minZ=0.000001;

					}
					
					//Control de la posición sobre el planeta (esfera roja)
					switch (pointerInfo.type) {

						case BABYLON.PointerEventTypes.POINTERDOWN:

							if (pointerInfo.event.button==2 && pointerInfo.pickInfo.hit && pointerInfo.pickInfo.pickedMesh == sph2) {
								
								sp=getScreenPosition();
								atc02=1;

								setTimeout(function () {
									camera.detachControl(canvas);
								}, 0);

							}

						break;

						case BABYLON.PointerEventTypes.POINTERMOVE:

							if (atc02==1) {

								cp=getScreenPosition();

								lon+=0.01*(cp[0]-sp[0]);
								lat+=-0.01*(cp[1]-sp[1]);

								if (lat>Math.PI/2.0) lat=Math.PI/2.0;
								if (lat<-Math.PI/2.0) lat=-Math.PI/2.0;

								calc_lat_lon_pos();
								sph2.position=lat_lon_pos;
								
								sp=getScreenPosition();

								lon_slider.value = lon*180.0/Math.PI;
								lat_slider.value = lat*180.0/Math.PI;

								lat_text.text = "Lat: " + (Math.floor(lat_slider.value*1000)/1000).toFixed(1)+"º";
								lon_text.text = "Lon: " + (Math.floor(lon_slider.value*1000)/1000).toFixed(1)+"º";

							}

						break;

						case BABYLON.PointerEventTypes.POINTERWHEEL:

							if (atc02==1) {

								lat_lon_alt+=pointerInfo.event.wheelDelta*0.1;
								if (lat_lon_alt<=0) lat_lon_alt=0;

								calc_lat_lon_pos();
								sph2.position=lat_lon_pos;

								alt_slider.value = lat_lon_alt;
								alt_text.text = "Alt: " + alt_slider.value.toString()+" Km";

							}

						break;

						case BABYLON.PointerEventTypes.POINTERUP:

							if (pointerInfo.event.button==2 && atc02==1) {

								atc02=0;
								camera.attachControl(canvas, true);
							}

						break;

					}

					if (pointerInfo.event.wheelDelta != undefined && planet_point_id!=-1) {

						if (pointerInfo.event.wheelDelta>0) {

							camera2.fov*=0.9;
							if (camera2.fov<0.0001) camera2.fov=0.0001;

						} else {

							camera2.fov/=0.9;
							if (camera2.fov>0.8) camera2.fov=0.8;

						}

						if (camera2.fov<cam2_fov_limit) {

							camera2.minZ=0.1;
							camera2.maxZ=50;

						} else {

							camera2.minZ=0.000001;
							camera2.maxZ=10000;

						}


						if (planet_point_id!=-1) {
							//fov_slider.value=Math.pow(camera2.fov/0.8,1/3.0);
							fov_slider.value=Math.cbrt(camera2.fov/0.8);
							fov_text.text = "FOV: " + (Math.floor(((camera2.fov)/Math.PI*180.0)*1000)/1000).toString()+"º";
						}

						if (planet_point_id!=-1 && modo_interactivo==1) {

							if (camera2.fov<0.1) {

								for (var ii=1;ii<=10;ii++) {
									if (ii==4) continue;
									sprite_planet[ii].isVisible=false;
								}

							} else {
							
								for (var ii=1;ii<=10;ii++) {
									if (ii==4) continue;
									sprite_planet[ii].isVisible=true;
								}

							}


							if (planet_id<=10 && planet_id!=4 && planet_id!=0) {
								sprite_planet[planet_id].isVisible=false;
							}
							if (planet_id>10 || planet_id==4) {
								var par=planet_parent[planet_id];
								sprite_planet[par].isVisible=0;
							}


						}


					}
									


					if (pointerInfo.event.buttons==1 && planet_id==planet_point_id) {

						camera2.inputs.attached.mouse.detachControl();
						atc01=1;
						

						if (pointerInfo.event.movementX!=0 || pointerInfo.event.movementY!=0) {

							c2tt=camera2.target;							

							var pro_z1=c2tt.x*ouz.x+c2tt.y*ouz.y+c2tt.z*ouz.z;
							var pro_e1=c2tt.x*oue.x+c2tt.y*oue.y+c2tt.z*oue.z;
							var pro_n1=c2tt.x*oun.x+c2tt.y*oun.y+c2tt.z*oun.z;

							var ang_az=Math.atan2(pro_e1,pro_n1);
							var ang_al=Math.atan2(pro_z1,Math.sqrt(pro_e1*pro_e1+pro_n1*pro_n1));


							var sfactor=1.0;
							var sensi=0.0025*sfactor-((0.8-camera2.fov)/0.8)*0.0025*sfactor; 

							ang_az+=sensi*pointerInfo.event.movementX;
							ang_al-=sensi*pointerInfo.event.movementY;


							var alt_limit=Math.PI/2.0-0.001;
							if (ang_al>alt_limit) ang_al=alt_limit;
							if (ang_al<-alt_limit) ang_al=-alt_limit;

							var cos_ang_al=Math.cos(ang_al);

							pro_n1=cos_ang_al*Math.cos(ang_az);
							pro_e1=cos_ang_al*Math.sin(ang_az);
							pro_z1=Math.sin(ang_al); 

							c2tt.x=pro_z1*ouz.x+pro_e1*oue.x+pro_n1*oun.x;
							c2tt.y=pro_z1*ouz.y+pro_e1*oue.y+pro_n1*oun.y;
							c2tt.z=pro_z1*ouz.z+pro_e1*oue.z+pro_n1*oun.z;

							camera2.target=c2tt;
							camera2.speed=0;
							

							if (head_coordinates==1) {
								var vcam=camera2.target.subtract(camera2.position);

								vcam.normalize();
					
								var cam_ecl_lon=Math.atan2(vcam.z,vcam.x);
								var cam_pl=Math.sqrt(vcam.x*vcam.x+vcam.z*vcam.z);
								var cam_ecl_lat=Math.atan(vcam.y/cam_pl);

								var sin_cam_ecl_lon=Math.sin(cam_ecl_lon);

								var cam_ra=Math.atan2((sin_cam_ecl_lon*cos_tilt-Math.tan(cam_ecl_lat)*sin_tilt),Math.cos(cam_ecl_lon));
								var cam_de=Math.asin(Math.sin(cam_ecl_lat)*cos_tilt+Math.cos(cam_ecl_lat)*sin_tilt*sin_cam_ecl_lon);

								cam_ra=cam_ra*rtoh;
								cam_de=cam_de*rtod;

								if (cam_ra<0) cam_ra+=24;

								cam_ra=Math.floor(cam_ra*100.0)/100;
								cam_de=Math.floor(cam_de*100.0)/100;


								var cam_az=Math.atan2(pro_e1,pro_n1);
								cam_pl=Math.sqrt(pro_n1*pro_n1+pro_e1*pro_e1);
								var cam_alt=Math.atan(pro_z1/cam_pl);

								cam_az=cam_az*rtod;
								cam_alt=cam_alt*rtod;

								if (cam_az<0) cam_az+=360;
								if (cam_az>360) cam_az-=360;

								cam_alt=Math.floor(cam_alt*10.0)/10;
								cam_az=Math.floor(cam_az*10.0)/10;


								head_text.text = "RA " + cam_ra.toString() + 
													  "  DEC " + cam_de.toString() + 
                                         " | Alt " + cam_alt.toString() + 
													  " Az " + cam_az.toString();

								if (ori_equat==1) {
									head_text.text = "RA " + cam_ra.toString() + "  DEC " + cam_de.toString() + " | Alt " + "--.-" + " Az " + "--.-";
								}
							}
							

						}


					}

					if (pointerInfo.event.buttons==0 && planet_id==planet_point_id && atc01==1) {

						camera2.inputs.attachInput(camera2.inputs.attached.mouse);
						atc01=0;

					}

					
				});


            return scene;

        };

		  //Call the createScene function
        const scene = createScene(); 

			
        // Register a render loop to repeatedly render the scene
        engine.runRenderLoop(function () {
                scene.render();
        });


        // Watch for browser/canvas resize events
        window.addEventListener("resize", function () {
                engine.resize();
        });

			
		function corrige_baricentro() {

			 return;

			//Earth-Moon
			var Me=5.972e24;
			var Mm=7.347e22;
			var Mt=Me+Mm;
			var iMt=1.0/Mt;


			var cmx=(planet_pos[3].x*Me + planet_pos[4].x*Mm)*iMt;
			var cmy=(planet_pos[3].y*Me + planet_pos[4].y*Mm)*iMt;
			var cmz=(planet_pos[3].z*Me + planet_pos[4].z*Mm)*iMt;

			var dx=planet_pos[3].x-cmx;
			var dy=planet_pos[3].y-cmy;
			var dz=planet_pos[3].z-cmz;

			var p3= new BABYLON.Vector3(planet_pos[3].x-dx,planet_pos[3].y-dy,planet_pos[3].z-dz);
			var p41= new BABYLON.Vector3(planet_pos[4].x+dx,planet_pos[4].y+dy,planet_pos[4].z+dz);

			//planet_pos[3]=p3;
			planet_pos[4]=p41;

			//Pluto-Charon
			var Mp=1.303e22;
			var Mc=1.586e21;
			var Mt=Mp+Mc;
		    var iMt=1.0/Mt;

			var cmx=(planet_pos[10].x*Mp + planet_pos[35].x*Mc)*iMt;
			var cmy=(planet_pos[10].y*Mp + planet_pos[35].y*Mc)*iMt;
			var cmz=(planet_pos[10].z*Mp + planet_pos[35].z*Mc)*iMt;

			var dx=planet_pos[10].x-cmx;
			var dy=planet_pos[10].y-cmy;
			var dz=planet_pos[10].z-cmz;

			var p10= new BABYLON.Vector3(planet_pos[10].x+dx,planet_pos[10].y+dy,planet_pos[10].z+dz);
			var p35= new BABYLON.Vector3(planet_pos[35].x+dx,planet_pos[35].y+dy,planet_pos[35].z+dz);

			planet_pos[10]=p10;
			planet_pos[35]=p35;


		}


		function calcula_sombras() {

			var metodo_rayo=0;

			var cnt=0;
			lines_umbra_pos=[];
			lines_umbra_pos.length=0;
			lines_umbra_pos[cnt]=new BABYLON.Vector3(NaN,NaN,NaN);
			cnt++;
			lines_umbra_pos[cnt]=new BABYLON.Vector3(NaN,NaN,NaN);
			cnt++;

			var cnt1=0;
			lines_penumbra_pos=[];
			lines_penumbra_pos.length=0;
			lines_penumbra_pos[cnt1]=new BABYLON.Vector3(NaN,NaN,NaN);
			cnt1++;
			lines_penumbra_pos[cnt1]=new BABYLON.Vector3(NaN,NaN,NaN);
			cnt1++;

			if (calculame_las_sombras==0) return;

			var dx1,dy1,dz1,d1;
			var dx2,dy2,dz2,d2;
			var ux1,uy1,uz1,u1;
			var ux2,uy2,uz2,u2;
			var rx1,ry1,rz1;
			var rsx,rsy,rsz,rs;
			
			var pox,poy,poz;
			var pix,piy,pyz,pp;
			var vix,viy,vyz,vv;
			var ang1,cos_ang1,sin_ang1,pr;

			var origen1=new BABYLON.Vector3(0,0,0);
			var vector1=new BABYLON.Vector3(0,0,0);

			var h_sombra=1.001;

			rx1=0;ry1=0;rz1=1;

			for (var i=0;i<11;i++) {

				if (i==4) continue;
				//if (i==5) continue;
				if (planet_sat[i].length==1) continue;

				
				if (planet_id!=4) {
					if (planet_id<11) {

						if (i!=planet_id ) continue;
					
					} else {

						var par=planet_parent[planet_id];
						if (i!=par) continue;

					}

				} else {

					if (i!=3) continue;

				}
				

				//console.log(i,planet_sat[i].length);


				lines_umbra_pos[cnt]=new BABYLON.Vector3(NaN,NaN,NaN);
				cnt++;
				lines_penumbra_pos[cnt1]=new BABYLON.Vector3(NaN,NaN,NaN);
				cnt1++;
				

				for (var ii=0;ii<planet_sat[i].length;ii++) {

					var oi=planet_sat[i][ii];

					dx1=planet_pos[oi].x-planet_pos[0].x;
					dy1=planet_pos[oi].z-planet_pos[0].z;
					dz1=planet_pos[oi].y-planet_pos[0].y;
					d1=Math.sqrt(dx1*dx1+dy1*dy1+dz1*dz1);
					dx1/=d1;dy1/=d1;dz1/=d1;

					ux1=(dy1*rz1-ry1*dz1);
					uy1=-(dx1*rz1-rx1*dz1);
					uz1=(dx1*ry1-rx1*dy1);

					ux2=(dy1*uz1-uy1*dz1);
					uy2=-(dx1*uz1-ux1*dz1);
					uz2=(dx1*uy1-ux1*dy1);

					lines_umbra_pos[cnt]=new BABYLON.Vector3(NaN,NaN,NaN);
					cnt++;
					lines_penumbra_pos[cnt1]=new BABYLON.Vector3(NaN,NaN,NaN);
					cnt1++;
					

					for (jj=0;jj<planet_sat[i].length;jj++) {

						var oj=planet_sat[i][jj];

						if (oi==oj) continue;

						dx2=planet_pos[oj].x-planet_pos[0].x;
						dy2=planet_pos[oj].z-planet_pos[0].z;
						dz2=planet_pos[oj].y-planet_pos[0].y;
						d2=Math.sqrt(dx2*dx2+dy2*dy2+dz2*dz2);

						if (d2<d1) continue;

						//console.log(oi,oj);

						nn=10;
						h_sombra=1.02*0+1.01;
						if (oi==4 && oj==3) nn=200.0;
						if (oi==3 && oj==4) nn=200.0;
						if (oj==4) h_sombra=1.01;


						lines_umbra_pos[cnt]=new BABYLON.Vector3(NaN,NaN,NaN);
						cnt++;
						lines_penumbra_pos[cnt1]=new BABYLON.Vector3(NaN,NaN,NaN);
						cnt1++;

						for (var kk=0;kk<nn;kk++) {

							ang1=2*Math.PI*kk/(nn-1);
							cos_ang1=Math.cos(ang1);
							sin_ang1=Math.sin(ang1);
							pr=planet_rad[0]*i_ua_km;
							pox=planet_pos[0].x+pr*(ux1*cos_ang1+ux2*sin_ang1);
							poy=planet_pos[0].z+pr*(uy1*cos_ang1+uy2*sin_ang1);
							poz=planet_pos[0].y+pr*(uz1*cos_ang1+uz2*sin_ang1);

							//ang1=2*Math.PI*kk/(nn-1)+Math.PI;
							//cos_ang1=Math.cos(ang1);
							//sin_ang1=Math.sin(ang1);
							cos_ang1*=-1;
							sin_ang1*=-1;
							pr=planet_rad[oi]*i_ua_km;
							pix=planet_pos[oi].x+pr*(ux1*cos_ang1+ux2*sin_ang1);
							piy=planet_pos[oi].z+pr*(uy1*cos_ang1+uy2*sin_ang1);
							piz=planet_pos[oi].y+pr*(uz1*cos_ang1+uz2*sin_ang1);

							vix=pix-pox;
							viy=piy-poy;
							viz=piz-poz;
							vv=Math.sqrt(vix*vix+viy*viy+viz*viz);
							vix/=vv;viy/=vv;viz/=vv;


							if (metodo_rayo==0) {

								var ocx=pix-planet_pos[oj].x;
								var ocy=piy-planet_pos[oj].z;
								var ocz=piz-planet_pos[oj].y;
								var ocm=ocx*ocx+ocy*ocy+ocz*ocz;

								var uoc=vix*ocx+viy*ocy+viz*ocz;

								var pr=h_sombra*planet_rad[oj]*i_ua_km;
								var in_root=4*uoc*uoc-4*(ocm-pr*pr);

								if (in_root<=0) {

									lines_umbra_pos[cnt]=new BABYLON.Vector3(NaN,NaN,NaN);
									cnt++;

								} else {

									var d0=Math.sqrt(in_root)/2.0;
									var d1=-uoc+d0;
									var d2=-uoc-d0;

									if (d1<d2) {var df=d1;} else {var df=d2;}

									lines_umbra_pos[cnt]=new BABYLON.Vector3(pix+df*vix,piz+df*viz,piy+df*viy);
									cnt++;

								}

							}


							if (metodo_rayo==1) {

								origen1=new BABYLON.Vector3(pix,piz,piy);
								vector1=new BABYLON.Vector3(vix,viz,viy);

								var ray=new BABYLON.Ray(origen1,vector1,0.1);

								var disparo=ray.intersectsMesh(sph1[oj])
							
								if (disparo.hit) {
								
									rsx=disparo.pickedPoint.x-planet_pos[oj].x;
									rsy=disparo.pickedPoint.y-planet_pos[oj].y;
									rsz=disparo.pickedPoint.z-planet_pos[oj].z;
									rr=Math.sqrt(rsx*rsx+rsy*rsy+rsz*rsz);
									rsx/=rr;rsy/=rr;rsz/=rr;
							
									pr=planet_rad[oj]*i_ua_km*h_sombra;
									rsx=planet_pos[oj].x+rsx*pr;
									rsy=planet_pos[oj].y+rsy*pr;
									rsz=planet_pos[oj].z+rsz*pr;
									//console.log(oi,oj,rsx,rsy,rsz,cnt);

					
									lines_umbra_pos[cnt]=new BABYLON.Vector3(rsx,rsy,rsz);
									cnt++;
							
								} else {

									lines_umbra_pos[cnt]=new BABYLON.Vector3(NaN,NaN,NaN);
									cnt++;
								

								} //  if disparo

							}


							//------

							ang1=2*Math.PI*kk/(nn-1);
							cos_ang1=Math.cos(ang1);
							sin_ang1=Math.sin(ang1);
							pr=planet_rad[0]*i_ua_km;
							pox=planet_pos[0].x+pr*(ux1*cos_ang1+ux2*sin_ang1);
							poy=planet_pos[0].z+pr*(uy1*cos_ang1+uy2*sin_ang1);
							poz=planet_pos[0].y+pr*(uz1*cos_ang1+uz2*sin_ang1);

							//ang1=2*Math.PI*kk/(nn-1);
							//cos_ang1=Math.cos(ang1);
							//sin_ang1=Math.sin(ang1);
							pr=planet_rad[oi]*i_ua_km;
							pix=planet_pos[oi].x+pr*(ux1*cos_ang1+ux2*sin_ang1);
							piy=planet_pos[oi].z+pr*(uy1*cos_ang1+uy2*sin_ang1);
							piz=planet_pos[oi].y+pr*(uz1*cos_ang1+uz2*sin_ang1);

							
							vix=pix-pox;
							viy=piy-poy;
							viz=piz-poz;
							vv=Math.sqrt(vix*vix+viy*viy+viz*viz);
							vix/=vv;viy/=vv;viz/=vv;

							if (metodo_rayo==0) {

								var ocx=pix-planet_pos[oj].x;
								var ocy=piy-planet_pos[oj].z;
								var ocz=piz-planet_pos[oj].y;
								var ocm=ocx*ocx+ocy*ocy+ocz*ocz;

								var uoc=vix*ocx+viy*ocy+viz*ocz;

								var pr=h_sombra*planet_rad[oj]*i_ua_km;
								var in_root=4*uoc*uoc-4*(ocm-pr*pr);

								if (in_root<=0) {

									lines_penumbra_pos[cnt1]=new BABYLON.Vector3(NaN,NaN,NaN);
									cnt1++;

								} else {

									var d0=Math.sqrt(in_root)/2.0;
									var d1=-uoc+d0;
									var d2=-uoc-d0;

									if (d1<d2) {var df=d1;} else {var df=d2;}

									lines_penumbra_pos[cnt1]=new BABYLON.Vector3(pix+df*vix,piz+df*viz,piy+df*viy);
									cnt1++;

								}


							}


							if (metodo_rayo==1) {

								origen1=new BABYLON.Vector3(pix,piz,piy);
								vector1=new BABYLON.Vector3(vix,viz,viy);

								var ray=new BABYLON.Ray(origen1,vector1,0.1);

								var disparo=ray.intersectsMesh(sph1[oj])
							

								if (disparo.hit) {
								
									rsx=disparo.pickedPoint.x-planet_pos[oj].x;
									rsy=disparo.pickedPoint.y-planet_pos[oj].y;
									rsz=disparo.pickedPoint.z-planet_pos[oj].z;
									rr=Math.sqrt(rsx*rsx+rsy*rsy+rsz*rsz);
									rsx/=rr;rsy/=rr;rsz/=rr;
							
									pr=planet_rad[oj]*i_ua_km*h_sombra;
									rsx=planet_pos[oj].x+rsx*pr;
									rsy=planet_pos[oj].y+rsy*pr;
									rsz=planet_pos[oj].z+rsz*pr;
									//console.log(oi,oj,rsx,rsy,rsz,cnt);
					
									lines_penumbra_pos[cnt1]=new BABYLON.Vector3(rsx,rsy,rsz);
									cnt1++;
							
								} else {

									lines_penumbra_pos[cnt1]=new BABYLON.Vector3(NaN,NaN,NaN);
									cnt1++;
								

								} //  if disparo

							}



						} // kk


					} // jj
					

				} // if ii


			} // if i

		}  // end function



		function calc_lat_lon_pos() {

			var pid=planet_id;
			var w=planet_w[pid];
			var radio1=planet_rad[pid]*i_ua_km;
			var radio2=radio1*(1-planet_flat[pid]);
			
			radio1+=(lat_lon_alt+2)*i_ua_km;
			radio2+=(lat_lon_alt+2)*i_ua_km;

			var ang;
			var x1,y1,z1;
			var x2,y2,z2;
			var x3,y3,z3;
			var x4,y4,z4;

			var uzx,uzy,uzz;
			var uex,uey,uez;
			var unx,uny,unz;

			var cos_lat=Math.cos(lat);

			x1 = radio1*cos_lat*Math.cos(lon);
			y1 = radio1*cos_lat*Math.sin(lon);
			z1 = radio2*Math.sin(lat);

			ang=-(planet_w[pid]+Math.PI);
			cos_ang=Math.cos(ang);
			sin_ang=Math.sin(ang);
			x2=x1*cos_ang-y1*sin_ang;
			y2=x1*sin_ang+y1*cos_ang;
			z2=z1;
			
			ang=-planet_ori1[pid];
			cos_ang=Math.cos(ang);
			sin_ang=Math.sin(ang);
			x3=x2;
			y3=y2*cos_ang-z2*sin_ang;
			z3=y2*sin_ang+z2*cos_ang;
			
			ang=-planet_ori2[pid];
			cos_ang=Math.cos(ang);
			sin_ang=Math.sin(ang);
			x4=x3*cos_ang-y3*sin_ang;
			y4=x3*sin_ang+y3*cos_ang;
			z4=z3;

			lat_lon_rad=planet_rad[pid]*i_ua_km/20.0;
			lat_lon_pos=new BABYLON.Vector3(planet_pos[pid].x+x4,planet_pos[pid].y+z4,planet_pos[pid].z+y4);

			var d4=Math.sqrt(x4*x4+y4*y4+z4*z4);
			x4/=d4;y4/=d4;z4/=d4;
			upv=new BABYLON.Vector3(x4,z4,y4);
			//upv2=upv.multiplyByFloats(1,1,1);
			upv.normalize();
						
			uzx=x4*1;uzy=y4*1;uzz=z4*1;

			
			x1 = -radio1*cos_lat*Math.sin(lon);
			y1 = radio1*cos_lat*Math.cos(lon);
			//z1 = radio2*Math.sin(lat)*0;
			z1=0.0;

			ang=-(planet_w[pid]+Math.PI);
			cos_ang=Math.cos(ang);
			sin_ang=Math.sin(ang);
			x2=x1*cos_ang-y1*sin_ang;
			y2=x1*sin_ang+y1*cos_ang;
			z2=z1;
			
			ang=-planet_ori1[pid];
			cos_ang=Math.cos(ang);
			sin_ang=Math.sin(ang);
			x3=x2;
			y3=y2*cos_ang-z2*sin_ang;
			z3=y2*sin_ang+z2*cos_ang;
			
			ang=-planet_ori2[pid];
			cos_ang=Math.cos(ang);
			sin_ang=Math.sin(ang);
			x4=x3*cos_ang-y3*sin_ang;
			y4=x3*sin_ang+y3*cos_ang;
			z4=z3;

			d4=Math.sqrt(x4*x4+y4*y4+z4*z4);
			x4/=d4;y4/=d4;z4/=d4;				

			uex=x4*1;uey=y4*1;;uez=z4*1;

			unx=(uzy*uez-uey*uzz);
			uny=-(uzx*uez-uex*uzz);
			unz=(uzx*uey-uex*uzy);

			ouz.x=uzx;
			ouz.y=uzz;
			ouz.z=uzy;

			oue.x=uex;
			oue.y=uez;
			oue.z=uey;
		
			oun.x=unx;
			oun.y=unz;
			oun.z=uny;


			if (ori_equat==1) {

				x1=0;y1=0;z1=1;

				ang=-(planet_w[pid]+Math.PI);
				cos_ang=Math.cos(ang);
				sin_ang=Math.sin(ang);
				x2=x1*cos_ang-y1*sin_ang;
				y2=x1*sin_ang+y1*cos_ang;
				z2=z1;
			
				ang=-planet_ori1[pid];
				cos_ang=Math.cos(ang);
				sin_ang=Math.sin(ang);
				x3=x2;
				y3=y2*cos_ang-z2*sin_ang;
				z3=y2*sin_ang+z2*cos_ang;
			
				ang=-planet_ori2[pid];
				cos_ang=Math.cos(ang);
				sin_ang=Math.sin(ang);
				x4=x3*cos_ang-y3*sin_ang;
				y4=x3*sin_ang+y3*cos_ang;
				z4=z3;

				
				var d4=Math.sqrt(x4*x4+y4*y4+z4*z4);
				x4/=d4;y4/=d4;z4/=d4;
				upv=new BABYLON.Vector3(x4,z4,y4);

				upv.normalize();
						
				uzx=x4*1;uzy=y4*1;uzz=z4*1;


				x1=1.0;y1=0;z1=0;

				ang=-(planet_w[pid]+Math.PI);
				cos_ang=Math.cos(ang);
				sin_ang=Math.sin(ang);
				x2=x1*cos_ang-y1*sin_ang;
				y2=x1*sin_ang+y1*cos_ang;
				z2=z1;
			
				ang=-planet_ori1[pid];
				cos_ang=Math.cos(ang);
				sin_ang=Math.sin(ang);
				x3=x2;
				y3=y2*cos_ang-z2*sin_ang;
				z3=y2*sin_ang+z2*cos_ang;
			
				ang=-planet_ori2[pid];
				cos_ang=Math.cos(ang);
				sin_ang=Math.sin(ang);
				x4=x3*cos_ang-y3*sin_ang;
				y4=x3*sin_ang+y3*cos_ang;
				z4=z3;

				d4=Math.sqrt(x4*x4+y4*y4+z4*z4);
				x4/=d4;y4/=d4;z4/=d4;				

				uex=x4*1;uey=y4*1;;uez=z4*1;


				unx=(uzy*uez-uey*uzz);
				uny=-(uzx*uez-uex*uzz);
				unz=(uzx*uey-uex*uzy);

				ouz.x=uzx;
				ouz.y=uzz;
				ouz.z=uzy;

				oue.x=uex;
				oue.y=uez;
				oue.z=uey;
		
				oun.x=unx;
				oun.y=unz;
				oun.z=uny;

			}


			var lhc=0;
			var pr01=planet_rad[pid]*i_ua_km*2;
			for (var i=0;i<local_horizon_n;i++) {

				ang=2*Math.PI*i/((local_horizon_n-1)*1.0)+Math.PI/2.0;

				cos_ang=Math.cos(ang);
				sin_ang=Math.sin(ang);

				x1=pr01*(oue.x*cos_ang+oun.x*sin_ang);
				y1=pr01*(oue.y*cos_ang+oun.y*sin_ang);
				z1=pr01*(oue.z*cos_ang+oun.z*sin_ang);

				x1+=lat_lon_pos.x;
				y1+=lat_lon_pos.y;
				z1+=lat_lon_pos.z;

				local_horizon[i]=new BABYLON.Vector3(x1,y1,z1);

				lhc++;

			}

			
			local_horizon[lhc]=new BABYLON.Vector3(NaN,NaN,NaN);
			lhc++;

			zr=new BABYLON.Vector3(0,0,0);
			for (var i=0;i<local_horizon_n;i++) {

				local_horizon[lhc]=local_horizon[i].add(zr);
				lhc++;

				
				var hup=pr01*0.05/4.0;
				if (i%6==0) hup=pr01*0.05/2.0;

				var uvh=ouz.multiplyByFloats(hup,hup,hup);
				local_horizon[lhc]=local_horizon[i].add(uvh);
				lhc++;

				if (i==0) {

					var ln=local_horizon[lhc-1].add(zr);

					local_horizon[lhc]=new BABYLON.Vector3(NaN,NaN,NaN);
					lhc++;

					local_horizon[lhc]=ln.add(zr);
					lhc++;

					var uvh=oue.multiplyByFloats(hup,hup,hup);
					local_horizon[lhc]=ln.add(uvh);
					lhc++;

					local_horizon[lhc]=new BABYLON.Vector3(NaN,NaN,NaN);
					lhc++;

					local_horizon[lhc]=ln.add(zr);
					lhc++;

					var uvh=oue.multiplyByFloats(-hup,-hup,-hup);
					local_horizon[lhc]=ln.add(uvh);
					lhc++;

				}

				local_horizon[lhc]=new BABYLON.Vector3(NaN,NaN,NaN);
				lhc++;

			}

			

		}


		function mueve_todo() {

			//return;


			var vref=planet_pos[planet_id].multiplyByFloats(1,1,1);

			for (var ii=0;ii<n_objetos;ii++) {

				planet_pos[ii].subtractInPlace(vref);

				for (var jj=0;jj<n_seg_orbs;jj++) {

					seg_orbs[ii][jj].x-=vref.x;
					seg_orbs[ii][jj].y-=vref.y;
					seg_orbs[ii][jj].z-=vref.z;
			
				}
		
				var lo=s_o_1[ii].length;
				for (var jj=0;jj<lo;jj=jj+3) {

					s_o_1[ii][jj]-=vref.x;
					s_o_1[ii][jj+1]-=vref.y;
					s_o_1[ii][jj+2]-=vref.z;

				}

				seg_orbs[ii][n_seg_orbs-1]=seg_orbs[ii][0];

				s_o_1[ii][lo-3]=s_o_1[ii][0];
				s_o_1[ii][lo-2]=s_o_1[ii][1];
				s_o_1[ii][lo-1]=s_o_1[ii][2];

			}


			lat_lon_pos.subtractInPlace(vref);

			for (var i=0;i<local_horizon.length;i++) {

				local_horizon[i].subtractInPlace(vref);

			}

		}

			
		function trastoca_luces() {

			light0.position=planet_pos[0];

			for (var ii=0;ii<fake_sun_n;ii++) {

				ii1=fake_sun_list[ii];

				if (ii1==7) shadowGenerator[ii].addShadowCaster(saturn_ring, true);
				if (ii1==8) shadowGenerator[ii].addShadowCaster(uranus_ring, true);
				if (ii1==9) shadowGenerator[ii].addShadowCaster(neptune_ring, true);
				if (ii1==7) saturn_ring.layerMask=3;
				if (ii1==8) uranus_ring.layerMask=3;
				if (ii1==9) neptune_ring.layerMask=3;

				sph1[ii1].layerMask=3; 

				for (var jj=0;jj<planet_sat_n[ii1]+1;jj++) {

					jj1=planet_sat[ii1][jj];

					shadowGenerator[ii].addShadowCaster(sph1[jj1], true);

					if (jj>0) {

						var u1=planet_pos[ii1].subtract(light[ii].position);
						var u2=planet_pos[jj1].subtract(light[ii].position);
						u1.normalize();
						u2.normalize();
						
						var ang_ps=Math.acos(BABYLON.Vector3.Dot(u1,u2));

						if (ang_ps<fake_sun_cone_angle[ii]/2.0) {

							sph1[jj1].layerMask=3;
							shadowGenerator[ii].addShadowCaster(sph1[jj1], true);

						} else {
				
							sph1[jj1].layerMask=4;
							shadowGenerator[ii].removeShadowCaster(sph1[jj1], true);

						}


					}

				}


			}


			//Actualiza lo proyectores de sombra para La Luna y La Tierra
			//que seran dos esferas en la misma posicion de ambos cuerpos
			//pero con un tamaño menor, para que las sombras proyectadas
			//se ajusten a la realidad. Al estar dentro de los cuerpos 
			//principales, por ser más pequeños, no seran visibles.
			shadowGenerator[0].removeShadowCaster(sph1[3],true);
			shadowGenerator[0].removeShadowCaster(sph1[4],true);
			shadowGenerator[0].addShadowCaster(fake_moon, true);
			shadowGenerator[0].addShadowCaster(fake_earth, true);


			shadowGenerator[0].removeShadowCaster(sph1[4],true);

			//light0.includeOnlyWithLayerMask=4;
			light0.excludeWithLayerMask=3;

		}


		//Creacion correcta de matrices 2D	
		function fill2DimensionsArray(arr, rows, columns){

			for (var i = 0; i < rows; i++) {
				arr.push([0])
				for (var j = 0; j < columns; j++) {
					arr[i][j] = 0;
				}
			}

		}


		//Obiene la fecha actual ^^	
		function obtiene_fecha_actual() {

			var d=new Date();
			var fecha = new Array(6);
	
			fecha[0]=d.getUTCDate();
			fecha[1]=d.getUTCMonth()+1;
			fecha[2]=d.getUTCFullYear();
			fecha[3]=d.getUTCHours();
			fecha[4]=d.getUTCMinutes();
			fecha[5]=d.getUTCSeconds();

			return fecha;

		}


		function calc_dynamic_time(year) {

			var t,u,y,DT;

			y=year;

			if (y<=-500) {
				u = (year-1820)/100.0;
				DT = -20 + 32 * u*u;
			}

			if (y>=-500 && y<=500) {
				u = y/100;
				DT = 10583.6 - 1014.41 * u + 33.78311 * u*u - 5.952053 * u*u*u
					- 0.1798452 * u*u*u*u + 0.022174192 * u*u*u*u*u + 0.0090316521 * u*u*u*u*u*u;
			}

			if (y>=500 && y<=1600) {
				u = (y-1000)/100;
				DT = 1574.2 - 556.01 * u + 71.23472 * u*u + 0.319781 * u*u*u
					- 0.8503463 * u*u*u*u - 0.005050998 * u*u*u*u*u + 0.0083572073 * u*u*u*u*u*u;
			}

			if (y>=1600 && y<=1700) {
				t = y - 1600;
				DT = 120 - 0.9808 * t - 0.01532 * t*t + t*t*t / 7129.0;
			}

			if (y>=1700 && y<=1800) {
				t = y - 1700;
				DT = 8.83 + 0.1603 * t - 0.0059285 * t*t + 0.00013336 * t*t*t - t*t*t*t / 1174000.0;
			}

			if (y>=1800 && y<=1860) {
				t = y - 1800;
				DT = 13.72 - 0.332447 * t + 0.0068612 * t*t + 0.0041116 * t*t*t - 0.00037436 * t*t*t*t
					+ 0.0000121272 * t*t*t*t*t - 0.0000001699 * t*t*t*t*t*t + 0.000000000875 * t*t*t*t*t*t*t;
			}

			if (y>=1860 && y<=1900) {
				t = y - 1860;
				DT = 7.62 + 0.5737 * t - 0.251754 * t*t + 0.01680668 * t*t*t
					-0.0004473624 * t*t*t*t + t*t*t*t*t / 233174.0;
			}

			if (y>=1900 && y<=1920) {
				t = y - 1900;
				DT = -2.79 + 1.494119 * t - 0.0598939 * t*t + 0.0061966 * t*t*t - 0.000197 * t*t*t*t;
			}

			if (y>=1920 && y<=1941) {
				t = y - 1920;
				DT = 21.20 + 0.84493*t - 0.076100 * t*t + 0.0020936 * t*t*t;
			}

			if (y>=1941 && y<=1961) {
				t = y - 1950;
				DT = 29.07 + 0.407*t - t*t/233.0 + t*t*t / 2547.0;
			}

			if (y>=1961 && y<=1986) {
				t = y - 1975;
				DT = 45.45 + 1.067*t - t*t/260.0 - t*t*t / 718.0;
			}

			if (y>=1986 && y<=2005) {
				t = y - 2000;
				DT = 63.86 + 0.3345 * t - 0.060374 * t*t + 0.0017275 * t*t*t + 0.000651814 * t*t*t*t;
					+ 0.00002373599 * t*t*t*t*t;
			}

			if (y>=2005 && y<=2050) {
				t = y - 2000;
				DT = 62.92 + 0.32217 * t + 0.005589 * t*t;
			}

			if (y>=2050 && y<=2150) {
				DT = -20 + 32 * ((y-1820.0)/100.0)*((y-1820.0)/100.0) - 0.5628 * (2150 - y);
			}

			if (y>=2150) {
				u = (year-1820)/100.0;
				DT = -20 + 32 * u*u;
			}


			//DT=0; 
			//console.log(DT);

			return DT;

		}



		//Obtiene el dia juliano (de efemerides)
		//a partir de la fecha y la hora		
		function calc_jd(fecha) {

			var dia=fecha[0];
			var mes=fecha[1];
			var ano=fecha[2];
			var hora=fecha[3];
			var minuto=fecha[4];
			var segundo=fecha[5];

			var ano1=ano;
			if (mes==1 || mes==2) {
				mes=mes+12;
				ano=ano-1;
			}
			
			var a=Math.floor(ano1/100.0);
			var b=2-a+Math.floor(a/4.0);
			var dia1=dia+hora/24.0+(minuto + segundo/60.0)/1440.0;
			var jd=Math.floor(365.25*(ano+4716))+Math.floor(30.6001*(mes+1))+dia1+b-1524.5;


			var DT=calc_dynamic_time(ano+mes/12);

			jd=jd+DT/86400.0;

			return jd;

		};

		//Obtiene la fecha y la hora
		//partiendo del dia juliano 
		function calc_fecha(jd) {

			var jd1=0.5+jd;
			var z=Math.floor(jd1);
			var f=jd1-z;
			var alfa=Math.floor((z-1867216.25)/36524.25);
			var a=z+1+alfa-Math.floor(alfa/4.0);
			var b=a+1524;
			var c=Math.floor((b-122.1)/365.25);
			var d=Math.floor(365.25*c);
			var e=Math.floor((b-d)/30.6001);

			var dia=b-d-Math.floor(30.6001*e)+f;
			var mes=0;
			var ano=0;

			if (e<14) {
				mes=e-1;
			} else {
				mes=e-13;
			}

			if (mes>2) {
				ano=c-4716;
			} else {
				ano=c-4715;
			}

			var DT=calc_dynamic_time(ano+mes/12);


			jd1=0.5+jd-DT/86400.0;
			z=Math.floor(jd1);
			f=jd1-z;
			alfa=Math.floor((z-1867216.25)/36524.25);
			a=z+1+alfa-Math.floor(alfa/4.0);
			b=a+1524;
			c=Math.floor((b-122.1)/365.25);
			d=Math.floor(365.25*c);
			e=Math.floor((b-d)/30.6001);

			dia=b-d-Math.floor(30.6001*e)+f;
			mes=0;
			ano=0;

			if (e<14) {
				mes=e-1;
			} else {
				mes=e-13;
			}

			if (mes>2) {
				ano=c-4716;
			} else {
				ano=c-4715;
			}

			var hora=(dia-Math.floor(dia))*24;
			var minuto=(hora-Math.floor(hora))*60;
			var segundo=(minuto-Math.floor(minuto))*60;

			dia=Math.floor(dia);
			hora=Math.floor(hora);
			minuto=Math.floor(minuto);
			segundo=Math.floor(segundo);

			var fecha1=[];

			fecha1[0]=dia;
			fecha1[1]=mes;
			fecha1[2]=ano;
			fecha1[3]=hora;
			fecha1[4]=minuto;
			fecha1[5]=segundo;

			return fecha1;

		}


		//Calcula la posicion de todos los planetas y satelites
		function calc_all_planets(jd) {

			better_moon=1;

			if (speed_light_correction==1) {var pos_earth=calc_planets(jd,3);}				

			for (var i=0;i<n_objetos;i++) {

					planet_pos[i]=calc_planets(jd,i);

					if (speed_light_correction==1) {

						var dpe=BABYLON.Vector3.Distance(planet_pos[i],pos_earth);
						var tpe=(dpe*ua_km/299792.458)/86400.0;

						planet_pos[i]=calc_planets(jd-tpe,i);

					}
		
			}

			better_moon=0;

		}


		//Calcula las orbitas keplerianas de todos los planetas y satelites
		//Usando el movimiento medio como referencia y paso temporal
		function calc_orbits() {

			var i_n_seg_orbsm1=1.0/(n_seg_orbs*1.0-1.0);

			for (var i=0;i<n_objetos;i++) {

				var jd0=jd;
				var dtt=1;
				var xx=[];

				if (i==0) {dtt=1;}

				if (i==1) {dtt=360/4.0923344368*i_n_seg_orbsm1;}
				if (i==2) {dtt=360/1.6021302244*i_n_seg_orbsm1;}
				if (i==3) {dtt=360/0.9856002585*i_n_seg_orbsm1;}
				if (i==4) {dtt=360/13.0649929509*i_n_seg_orbsm1;}
				if (i==5) {dtt=360/0.5240207766*i_n_seg_orbsm1;}
				if (i==6) {dtt=360/0.0830853001*i_n_seg_orbsm1;}
				
				if (i==7) {dtt=360/0.0334442282*i_n_seg_orbsm1;}
				if (i==8) {dtt=360/0.011725806*i_n_seg_orbsm1;}
				if (i==9) {dtt=360/0.005995147*i_n_seg_orbsm1;}

				if (i==10) {dtt=360/0.0039648669*i_n_seg_orbsm1;}

				if (i==11) {dtt=360/1128.8447569*i_n_seg_orbsm1;}
				if (i==12) {dtt=360/285.1618790*i_n_seg_orbsm1;}


				if (i==13) {dtt=360/203.4889583*i_n_seg_orbsm1;}
				if (i==14) {dtt=360/101.3747242*i_n_seg_orbsm1;}
				if (i==15) {dtt=360/50.3176072*i_n_seg_orbsm1;}
				if (i==16) {dtt=360/21.5710728*i_n_seg_orbsm1;}

				if (i==17) {dtt=360/381.9944948*i_n_seg_orbsm1;}
				if (i==18) {dtt=360/262.7318978*i_n_seg_orbsm1;}
				if (i==19) {dtt=360/190.6979109*i_n_seg_orbsm1;}
				if (i==20) {dtt=360/131.5349307*i_n_seg_orbsm1;}
				if (i==21) {dtt=360/79.69004590*i_n_seg_orbsm1;}
				if (i==22) {dtt=360/22.57697560*i_n_seg_orbsm1;}
				if (i==23) {dtt=360/16.91995030*i_n_seg_orbsm1;}
				if (i==24) {dtt=360/4.537941600*i_n_seg_orbsm1;}
				if (i==25) {dtt=360/0.656911400*i_n_seg_orbsm1;}
				if (i==26) {dtt=360/518.3431513*i_n_seg_orbsm1;}

				if (i==27) {dtt=360/142.8356579*i_n_seg_orbsm1;}
				if (i==28) {dtt=360/86.86888790*i_n_seg_orbsm1;}
				if (i==29) {dtt=360/41.35142460*i_n_seg_orbsm1;}
				if (i==30) {dtt=360/26.73948880*i_n_seg_orbsm1;}
				if (i==31) {dtt=360/254.6906576*i_n_seg_orbsm1;}

				if (i==32) {dtt=360/61.25726380*i_n_seg_orbsm1;}
				if (i==33) {dtt=360/0.999627600*i_n_seg_orbsm1;}
				if (i==34) {dtt=360/320.7656245*i_n_seg_orbsm1;}
				if (i==35) {dtt=360/56.36252250*i_n_seg_orbsm1;}

				var cn=0;
				for (var j=0;j<n_seg_orbs;j++) {

					jd0=jd+j*dtt
					xx=calc_planets(jd0,i);

					seg_orbs[i][j]=xx;
					s_o_1[i][cn]=xx.x;cn++;
					s_o_1[i][cn]=xx.y;cn++;
					s_o_1[i][cn]=xx.z;cn++;

				}

				//Union del finald e cada orbirta con el principio
				//para que siempre parezcan cerradas
				seg_orbs[i][n_seg_orbs-1]=seg_orbs[i][0]*1.0

			}

		}


		//Calculo de la posicion ecliptica de los planetas y satelites
		//mediante sus parametros orbitales keplerianos
		//(en algunos casos) variables en el tiempo.
		//Posiciones respecto a la epoca.

		//Datos y parametros orbitales extraidos de:

		//Planetas y Luna en funcion de d2k
		//https://stjarnhimlen.se/comp/ppcomp.html

		//Mejora de planetas
		//Astromical Algorithms, Jean Meeus, pag. 209

		//Satelites
		//JPL Horizons y Astronomical Algorithms, pag. 301 (modificado por el autor)

		function calc_planets(jd0,id) {

			var better_planets=0;

			var d2k=(jd0-2451543.5);

			var ecl=ecl = 23.4393 - 3.563E-7 * d2k;
			var rtod=180/Math.PI;

			var xx=new BABYLON.Vector3(0,0,0);

			//Sol
			if (id==0) {
				xx=new BABYLON.Vector3(0,0,0);
				return xx;
			}

			var T0=(jd0-2451545.0)/36525.0;
			var T02=T0*T0;
			var T03=T02*T0;

			//Tierra
			if (id==3) {

				
				/*if (better_planets==1) {

					var N_s1=0;
					var L=100.466457 + 36000.7698278*T0 + 0.00030322*T02 + 0.000000020*T03;
					var a_s1=1.000001018;
					var e_s1=0.01670863 - 0.000042037*T0 - 0.0000001267*T02 + 0.00000000014*T03;
					var i_s1=0;
					var pis=102.937348 + 1.7195366*T0 + 0.00045688*T02 - 0.000000018*T03;
					
					var M_s1=L-pis;
					var w_s1=pis-N_s1;

				} else {*/

					var N_s1=0;
					var i_s1=0;
					var w_s1=180+282.9404 + 4.70935E-5 * d2k;
					var a_s1=1.0;
					var e_s1=0.016709 - 1.151E-9 * d2k;
					var M_s1= 356.0470 + 0.9856002585 * d2k;

				//}

				/*
				var N_s1=0;
				var L=100.466457 + 36000.7698278*T0 + 0.00030322*T02 + 0.000000020*T03;
				var a_s1=1.000001018;
				var e_s1=0.01670863 - 0.000042037*T0 - 0.0000001267*T02 + 0.00000000014*T03;
				var i_s1=0;
				var pis=102.937348 + 1.7195366*T0 + 0.00045688*T02 - 0.000000018*T03;
				
				var M_s1=L-pis;
				var w_s1=pis-N_s1;
				*/

				N_s1=N_s1*dtor;
				i_s1=i_s1*dtor;
				w_s1=w_s1*dtor;
				M_s1=M_s1*dtor;

				var E_s1=M_s1+e_s1*Math.sin(M_s1)*(1+e_s1*Math.cos(M_s1));

				var xv_s1=a_s1*(Math.cos(E_s1)-e_s1);
				var yv_s1=a_s1*(Math.sqrt(1-e_s1*e_s1)*Math.sin(E_s1));

				v_s1=Math.atan2(yv_s1,xv_s1);
				r_s1=Math.sqrt(xv_s1*xv_s1+yv_s1*yv_s1);
				
				var lonsun1=v_s1+w_s1;
				
				var xs_s1=r_s1*Math.cos(lonsun1)*1;
				var ys_s1=r_s1*Math.sin(lonsun1)*1;
				var zs_s1=0*1;
				
				xx=new BABYLON.Vector3(xs_s1,zs_s1,ys_s1);
				return xx;

			}

			//Luna
			if (id==4) {

				/*if (better_planets==1) {

					var N_s=0;
					var L=100.466457 + 36000.7698278*T0 + 0.00030322*T02 + 0.000000020*T03;
					var a_s=1.000001018;
					var e_s=0.01670863 - 0.000042037*T0 - 0.0000001267*T02 + 0.00000000014*T03;
					var i_s=0;
					var pis=102.937348 + 1.7195366*T0 + 0.00045688*T02 - 0.000000018*T03;
					
					var M_s=L-pis;
					var w_s=pis-N_s;

				} else {*/

					var N_s=0;
					var i_s=0;
					var w_s=180+282.9404 + 4.70935E-5 * d2k;
					var a_s=1.0;
					var e_s=0.016709 - 1.151E-9 * d2k;
					var M_s= 356.0470 + 0.9856002585 * d2k;

				//}


				var N_s=N_s*dtor;
				var i_s=i_s*dtor;
				var w_s=w_s*dtor;
				var M_s=M_s*dtor;

				
				var xs1=planet_pos[planet_parent[id]].x;
				var ys1=planet_pos[planet_parent[id]].z;


				var N_p=125.1228 - 0.0529538083 * d2k;
				var i_p=5.1454;
				var w_p=318.0634 + 0.1643573223 * d2k;
				var a_p=60.2666;
				var e_p=0.054900;
				var M_p=115.3654 + 13.0649929509 * d2k;

				N_p=N_p*dtor;
				i_p=i_p*dtor;
				w_p=w_p*dtor;
				M_p=M_p*dtor;

				var E_p=M_p+e_p*Math.sin(M_p)*(1+e_p*Math.cos(M_p));

				for (var k=1;k<10;k++) {
					E_p=E_p-(E_p-e_p*Math.sin(E_p)-M_p)/(1-e_p*Math.cos(E_p));
				}

				var xv_p=a_p*(Math.cos(E_p)-e_p);
				var yv_p=a_p*(Math.sqrt(1.0-e_p*e_p)*Math.sin(E_p));

				var v_p=Math.atan2(yv_p,xv_p);
				var r_p=Math.sqrt(xv_p*xv_p+yv_p*yv_p);

				/*
				var xh_p=r_p*(Math.cos(N_p)*Math.cos(v_p+w_p)-Math.sin(N_p)*Math.sin(v_p+w_p)*Math.cos(i_p));
				var yh_p=r_p*(Math.sin(N_p)*Math.cos(v_p+w_p)+Math.cos(N_p)*Math.sin(v_p+w_p)*Math.cos(i_p));
				var zh_p=r_p*(Math.sin(v_p+w_p)*Math.sin(i_p));
				*/

				var cos_N_pe=Math.cos(N_p);
				var sin_N_pe=Math.sin(N_p);
				var cos_v_w_pe=Math.cos(v_p+w_p);
				var sin_v_w_pe=Math.sin(v_p+w_p);
				var cos_i_pe=Math.cos(i_p);
				var sin_i_pe=Math.sin(i_p);
			
				var xh_p = r_p * ( cos_N_pe * cos_v_w_pe - sin_N_pe * sin_v_w_pe * cos_i_pe );
				var yh_p = r_p * ( sin_N_pe * cos_v_w_pe + cos_N_pe * sin_v_w_pe * cos_i_pe );
				var zh_p = r_p * ( sin_v_w_pe * sin_i_pe );


				var lonecl_p=Math.atan2(yh_p,xh_p);
				var latecl_p=Math.atan2(zh_p,Math.sqrt(xh_p*xh_p+yh_p*yh_p));

				var Mm=M_p;
				var Ms=M_s;
				var ws=w_s;
				var wm=w_p;
				var Nm=N_p;

				var Ls=Ms+ws;
				var Lm=Mm+wm+Nm;
				var D=Lm-Ls;
				var D2=2*D;
				var F=Lm-Nm;

				var lon_m_corr=0;
				lon_m_corr=lon_m_corr-1.274 * Math.sin(Mm - D2);
				lon_m_corr=lon_m_corr+0.658 * Math.sin(D2);
				lon_m_corr=lon_m_corr-0.186 * Math.sin(Ms);
				lon_m_corr=lon_m_corr-0.059 * Math.sin(2*Mm - D2);
				lon_m_corr=lon_m_corr-0.057 * Math.sin(Mm - D2 + Ms);
				lon_m_corr=lon_m_corr+0.053 * Math.sin(Mm + D2);
				lon_m_corr=lon_m_corr+0.046 * Math.sin(D2 - Ms);
				lon_m_corr=lon_m_corr+0.041 * Math.sin(Mm - Ms);
				lon_m_corr=lon_m_corr-0.035 * Math.sin(D);
				lon_m_corr=lon_m_corr-0.031 * Math.sin(Mm + Ms);
				lon_m_corr=lon_m_corr-0.015 * Math.sin(2*F - D2);
				lon_m_corr=lon_m_corr+0.011 * Math.sin(Mm - 4*D);

				var lat_m_corr=0;
				lat_m_corr=lat_m_corr-0.173 * Math.sin(F - D2);
				lat_m_corr=lat_m_corr-0.055 * Math.sin(Mm - F - D2);
				lat_m_corr=lat_m_corr-0.046 * Math.sin(Mm + F - D2);
				lat_m_corr=lat_m_corr+0.033 * Math.sin(F + D2);
				lat_m_corr=lat_m_corr+0.017 * Math.sin(2*Mm + F);

				var r_m_corr=0;
				r_m_corr=r_m_corr-0.58 * Math.cos(Mm - D2);
				r_m_corr=r_m_corr-0.46 * Math.cos(D2);

				lonecl_p=lonecl_p+lon_m_corr*dtor;
				latecl_p=latecl_p+lat_m_corr*dtor;
				r_p=r_p+r_m_corr;


				var ss=6371/149597870.691;

				if (better_moon==1) {

					var nvals2=60;
					var t = (jd0 - 2451545.0)/36525.0;
					var t2=t*t;
					var t3=t2*t;
					var t4=t3*t;

					var d_lng = [0,2,2,0,0,0,2,2,2,2,0,1,0,2,0,0,4,0,4,2,2,1,1,2,2,4,2,0,2,2,1,2,0,0,2,2,2,4,0,3,2,4,0,2,2,2,4,0,4,1,2,0,1,3,4,2,0,1,2,2];
					var m_lng = [0,0,0,0,1,0,0,-1,0,-1,1,0,1,0,0,0,0,0,0,1,1,0,1,-1,0,0,0,1,0,-1,0,-2,1,2,-2,0,0,-1,0,0,1,-1,2,2,1,-1,0,0,-1,0,1,0,1,0,0,-1,2,1,0,0];
					var mp_lng = [1,-1,0,2,0,0,-2,-1,1,0,-1,0,1,0,1,1,-1,3,-2,-1,0,-1,0,1,2,0,-3,-2,-1,-2,1,0,2,0,-1,1,0,-1,2,-1,1,-2,-1,-1,-2,0,1,4,0,-2,0,2,1,-2,-3,2,1,-1,3,-1];
					var f_lng = [0,0,0,0,0,2,0,0,0,0,0,0,0,-2,2,-2,0,0,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,-2,2,0,2,0,0,0,0,0,0,-2,0,0,0,0,-2,-2,0,0,0,0,0,0,0,-2];


					var sin_lng = [6288774,1274027,658314,213618,-185116,-114332,58793,57066,53322,
					45758,-40923,-34720,-30383,15327,-12528,10980,10675,10034,8548,-7888,-6766,
					-5163,4987,4036,3994,3861,3665,-2689,-2602,2390,-2348,2236,-2120,-2069,2048,
					-1773,-1595,1215,-1110,-892,-810,759,-713,-700,691,596,549,537,520,-487,
					-399,-381,351,-340,330,327,-323,299,294,0.0];

					var cos_lng = [-20905355,-3699111,-2955968,-569925,48888,-3149,246158,-152138,
					-170733,-204586,-129620,108743,104755,10321,0,79661,-34782,-23210,-21636,
					24208,30824,-8379,-16675,-12831,-10445,-11650,14403,-7003,0,10056,6322,
					-9884,5751,0,-4950,4130,0,-3958,0,3258,2616,-1897,-2117,2354,0,0,-1423,
					-1117,-1571,-1739,0,-4421,0,0,0,0,1165,0,0,8752.0];


					var d_lat = [0,0,0,2,2,2,2,0,2,0,2,2,2,2,2,2,2,0,4,0,0,0,1,0,0,0,1,0,4,4,0,4,2,2,2,2,0,2,2,2,2,4,2,2,0,2,1,1,0,2,1,2,0,4,4,1,4,1,4,2];
					var m_lat = [0,0,0,0,0,0,0,0,0,0,-1,0,0,1,-1,-1,-1,1,0,1,0,1,0,1,1,1,0,0,0,0,0,0,0,0,-1,0,0,0,0,1,1,0,-1,-2,0,1,1,1,1,1,0,-1,1,0,-1,0,0,0,-1,-2];
					var mp_lat =[0,1,1,0,-1,-1,0,2,1,2,0,-2,1,0,-1,0,-1,-1,-1,0,0,-1,0,1,1,0,0,3,0,-1,1, -2,0,2,1,-2,3,2,-3,-1,0,0,1,0,1,1,0,0,-2,-1,1,-2,2,-2,-1,1,1,-1,0,0];
					var f_lat = [1,1,-1,-1,1,-1,1,1,-1,-1,-1,-1,1,-1,1,1,-1,-1,-1,1,3,1,1,1,-1,-1,-1,1,-1,1,-3,1,-3,-1,-1,1,-1,1,-1,1,1,1,1,-1,3,-1,-1,1,-1,-1,1,-1,1,-1,-1,-1,-1,-1,-1,1];

					var sin_lat = [5128122,280602,277693,173237,55413,46271,32573,17198,9266,8822,
					8216,4324,4200,-3359,2463,2211,2065,-1870,1828,-1794,-1749,-1565,-1491,
					-1475,-1410,-1344,-1335,1107,1021,833,777,671,607,596,491,-451,439,422,
					421,-366,-351,331,315,302,-283,-229,223,223,-220,-220,-185,181,-177,176,
					166,-164,132,-119,115,107.0];


					var Lprime =218.3164477 + t*481267.88123421 - t2*0.0015786 + t3*1.0/538841.0 - t4*1.0/(6.5194e7);Lprime=Lprime*dtor;
					var D= 297.8501921 + t*445267.1114034 - t2*0.0018819 + t3*1.0/545868.0 - t4*1.0/(1.13065e8);D=D*dtor;
					var M = 357.5291092 + t*35999.0502909 - t2*0.0001536 + t3*1.0/(2.449e7);M = M*dtor;
					var Mprime = 134.9633964 + t*477198.8675055 + t*t*0.0087414 + t*t*t*1.0/(6.9699e4) - t4*1.0/(1.4712e7);Mprime = Mprime*dtor;
					var F = 93.2720950 + t*483202.0175233 - t2*0.0036539 - t3*1.0/(3.526e7*0+3526000) + t4*1.0/(8.6331e8);F = F*dtor;
					

					var E = 1.0 - 0.002516*t - 7.4e-6*t2;
					var E2 = E*E;


					var A1 = (119.75 + 131.849*t) * dtor;
					var A2 = (53.09 + 479264.290*t) * dtor;
					var A3 = (313.45 + 481266.484*t) * dtor;
					var suml_add = 3958*Math.sin(A1) + 1962*Math.sin(Lprime - F) + 318*Math.sin(A2);
					var sumb_add =  -2235*Math.sin(Lprime) + 382*Math.sin(A3) + 175*Math.sin(A1-F) + 175*Math.sin(A1 + F) + 127*Math.sin(Lprime - Mprime) -115*Math.sin(Lprime + Mprime);


					var dlon=0;
					var drad=0;
					var dlat=0;
					var argumento;
					var corr;

					for (var i=0;i<nvals2;i++) {

						corr=1;
						if (m_lng[i]==1) corr=E;
						if (m_lng[i]==-1) corr=E;
						if (m_lng[i]==2) corr=E2;
						if (m_lng[i]==-2) corr=E2;
	

						argumento=D*d_lng[i]+M*m_lng[i]+Mprime*mp_lng[i]+F*f_lng[i];
						dlon+=corr*sin_lng[i]*Math.sin(argumento);
						drad+=corr*cos_lng[i]*Math.cos(argumento);

						corr=1;
						if (m_lat[i]==1) corr=E;
						if (m_lat[i]==-1) corr=E;
						if (m_lat[i]==2) corr=E2;
						if (m_lat[i]==-2) corr=E2;
	
						argumento=D*d_lat[i]+M*m_lat[i]+Mprime*mp_lat[i]+F*f_lat[i];
						dlat+=corr*sin_lat[i]*Math.sin(argumento);

					}


					dlon+=suml_add;
					dlat+=sumb_add;

					lonecl_p=Lprime+(dlon/(1e6))*dtor;
					latecl_p=(dlat/(1e6))*dtor;
					r_p=(385000.56+drad/(1e3))/149597870.691;


					var nut_L=(280.4665+36000.7698*t)*dtor;
					var nut_Lp=(218.3165+481267.8813*t)*dtor;
					var nut_omega=(125.04452-1934.136261*t+0.0020708*t*t+t*t*t/450000)*dtor;
					var nut_delta_phi=(-17.20*Math.sin(nut_omega)-1.32*Math.sin(2*nut_L)
											-0.23*Math.sin(nut_Lp)+0.21*Math.sin(2*nut_omega))/3600.0*dtor;
					/*var nut_delta_ecl=(9.2*Math.cos(nut_omega)+0.57*Math.cos(2*nut_L)
											+0.1*Math.cos(2*nut_Lp)-0.09*Math.cos(2*nut_omega))/3600.0*dtor;*/


					lonecl_p=lonecl_p-nut_delta_phi;
					ss=1;


				}


				var cos_lonecl_p=Math.cos(lonecl_p);
				var sin_lonecl_p=Math.sin(lonecl_p);
				var cos_latecl_p=Math.cos(latecl_p);
				var sin_latecl_p=Math.sin(latecl_p);


				xh_p = r_p * cos_lonecl_p * cos_latecl_p*ss+xs1;
				yh_p = r_p * sin_lonecl_p * cos_latecl_p*ss+ys1;
				zh_p = r_p * sin_latecl_p * 1*ss;


				//xh_p=0;yh_p=0;zh_p=0;
				xx=new BABYLON.Vector3(xh_p,zh_p,yh_p);
				return xx;
				

			}


			//Mercuio
			if (id==1) {

				
				/*if (better_planets==1) {

					var L = 252.250906 + 149474.0722491*T0 + 0.00030350*T02 + 0.000000018*T03;
					var a_pe = 0.387098310;
					var e_pe = 0.20563175 + 0.000020407*T0 - 0.0000000283*T02 - 0.00000000018*T03;
					var i_pe = 7.004986 + 0.0018215*T0 - 0.00001810*T02 + 0.000000056*T03;
					var N_pe = 48.330893 + 1.1861883*T0 + 0.00017542*T02 + 0.000000215*T03;
					var pis = 77.456119 + 1.5564776*T0 + 0.00029544*T02 + 0.000000009*T03; 

					var M_pe=L-pis;
					var w_pe=pis-N_pe;

				} else {*/

					var N_pe =  48.3313 + 3.24587E-5 * d2k;
					var i_pe = 7.0047 + 5.00E-8 * d2k;
					var w_pe =  29.1241 + 1.01444E-5 * d2k;
					var a_pe = 0.387098  ;
					var e_pe = 0.205635 + 5.59E-10 * d2k;
					var M_pe = 168.6562 + 4.0923344368 * d2k;

				//}


			}


			//Venus
			if (id==2) {

				
				/*if (better_planets==1) {

					var L = 181.979801 + 58519.2130302*T0 + 0.00031014*T02 + 0.000000015*T03;
					var a_pe = 0.723329820;
					var e_pe = 0.00677192 - 0.000047765*T0 + 0.0000000981*T02 + 0.00000000046*T03;
					var i_pe = 3.394662 + 0.0010037*T0 - 0.00000088*T02 - 0.000000007*T03;
					var N_pe = 76.679920 + 0.9011206*T0 + 0.00040618*T02 - 0.000000093*T03;
					var pis = 131.563703 + 1.4022288*T0 - 0.00107618*T02 - 0.000005678*T03;
					
					var M_pe=L-pis;
					var w_pe=pis-N_pe;

				} else {*/

					var N_pe =  76.6799 + 2.46590E-5 * d2k;
					var i_pe = 3.3946 + 2.75E-8 * d2k;
					var w_pe =  54.8910 + 1.38374E-5 * d2k;
					var a_pe = 0.723330  ;
					var e_pe = 0.006773 - 1.302E-9 * d2k;
					var M_pe =  48.0052 + 1.6021302244 * d2k;

				//}


			}


			//Marte
			if (id==5) {
				
				
				/*if (better_planets==1) {

					var L = 355.433000 + 19141.6964471*T0 + 0.00031052*T02 + 0.000000016*T03;
					var a_pe = 1.523679342;
					var e_pe = 0.09340065 + 0.000090484*T0 - 0.0000000806*T02 - 0.00000000025*T03;
					var i_pe = 1.849726 - 0.0006011*T0 + 0.00001276*T02 - 0.00000000025*T03;
					var N_pe = 49.558093 + 0.7720959*T0 + 0.00001557*T02 + 0.000002267*T03;
					var pis = 336.060234 + 1.8410449*T0 + 0.00013477*T02 + 0.000000536*T03;						

					var M_pe=L-pis;
					var w_pe=pis-N_pe;

				} else {*/

					var N_pe =  49.5574 + 2.11081E-5 * d2k;
					var i_pe = 1.8497 - 1.78E-8 * d2k;
					var w_pe = 286.5016 + 2.92961E-5 * d2k;
					var a_pe = 1.523688  ;
					var e_pe = 0.093405 + 2.516E-9 * d2k;
					var M_pe =  18.6021 + 0.5240207766 * d2k;

				//}


			}


			//Jupiter
			if (id==6) {

				
				/*if (better_planets==1) {

					var L = 34.351519 + 3036.3027748*T0 + 0.00022330*T02 + 0.000000037*T03;
					var a_pe = 5.202603209 + 0.0000001913*T0;
					var e_pe = 0.04849793 + 0.000163225*T0 - 0.0000004714*T02 - 0.00000000201*T03;
					var i_pe = 1.303267 - 0.0054965*T0 + 0.00000466*T02 - 0.000000002*T03;
					var N_pe = 100.464407 + 1.0209774*T0 + 0.00040315*T02 + 0.000000404*T03;
					var pis = 14.331207 + 1.6126352*T0 + 0.00103042*T02 - 0.000004464*T03;						

					var M_pe=L-pis;
					var w_pe=pis-N_pe;

				} else {*/

					var N_pe = 100.4542 + 2.76854E-5 * d2k;
					var i_pe = 1.3030 - 1.557E-7 * d2k;
					var w_pe = 273.8777 + 1.64505E-5 * d2k;
					var a_pe = 5.20256  ;
					var e_pe = 0.048498 + 4.469E-9 * d2k;
					var M_pe =  19.8950 + 0.0830853001 * d2k;

				//}


			}


			//Saturno
			if (id==7) {


				/*if (better_planets==1) {

					var L = 50.077444 + 1223.5110686*T0 + 0.00051908*T02 - 0.000000030*T03;
					var a_pe = 9.554909192 - 0.0000021390*T0 +0.000000004*T02;
					var e_pe = 0.00554814 - 0.000346641*T0 - 0.0000006436*T02 + 0.00000000340*T03;
					var i_pe = 2.488879 - 0.0037362*T0 - 0.00001519*T02 + 0.000000087*T03;
					var N_pe = 113.665503 + 0.8770880*T0 - 0.00012176*T02 - 0.000002249*T03;
					var pis = 93.057237 + 1.9637613*T0 + 0.00083753*T02 + 0.000004928*T03;						

					var M_pe=L-pis;
					var w_pe=pis-N_pe;

				} else {*/

					var N_pe = 113.6634 + 2.38980E-5 * d2k;
					var i_pe = 2.4886 - 1.081E-7 * d2k;
					var w_pe = 339.3939 + 2.97661E-5 * d2k;
					var a_pe = 9.55475  ;
					var e_pe = 0.055546 - 9.499E-9 * d2k;
					var M_pe = 316.9670 + 0.0334442282 * d2k;

				//}


			}


			//Urano
			if (id==8) {


				/*if (better_planets==1) {

					var L = 314.055005+429.8640561*T0 + 0.0030390*T02 + 0.000000026*T03;
					var a_pe = 19.218446062 - 0.0000000372*T0 + 0.00000000098*T02;
					var e_pe = 0.04638122 - 0.000027293*T0 + 0.0000000789*T02 + 0.00000000024*T03;
					var i_pe = 0.773197 + 0.0007744*T0 + 0.00003749*T02 - 0.000000092*T03;
					var N_pe = 74.005957 + 0.5211278*T0 + 0.00133947*T02 + 0.000018484*T03;
					var pis = 173.005291 + 1.4863790*T0 + 0.00021406*T02 + 0.000000434*T03;						

					var M_pe=L-pis;
					var w_pe=pis-N_pe;

				} else {*/
					
					var N_pe =  74.0005 + 1.3978E-5 * d2k;
					var i_pe = 0.7733 + 1.9E-8 * d2k;
					var w_pe =  96.6612 + 3.0565E-5 * d2k;
					var a_pe = 19.18171 - 1.55E-8 * d2k;
					var e_pe = 0.047318 + 7.45E-9 * d2k;
					var M_pe = 142.5905 + 0.011725806 * d2k;

				//}

			}


			//Neptuno
			if (id==9) {


				/*if (better_planets==1) {

					var L = 304.348665 + 219.8833092*T0 + 0.00030882*T02 + 0.000000018*T03;
					var a_pe = 30.110386869 - 0.0000001663*T0 + 0.00000000069*T02;
					var e_pe = 0.00945575 + 0.000006033*T0 + 0.000000000*T02 - 0.00000000005*T03;
					var i_pe = 1.769953 - 0.0093082*T0 - 0.00000708*T02 + 0.000000027*T03;
					var N_pe = 131.784057 + 1.1022039*T0 + 0.00025952*T02 - 0.000000637*T03;
					var pis = 48.120276 + 1.4262957*T0 + 0.00038434*T02 + 0.000000020*T03;

					var M_pe=L-pis;
					var w_pe=pis-N_pe;

				} else {*/

					var N_pe = 131.7806 + 3.0173E-5 * d2k;
					var i_pe = 1.7700 - 2.55E-7 * d2k;
					var w_pe = 272.8461 - 6.027E-6 * d2k;
					var a_pe = 30.05826 + 3.313E-8 * d2k;
					var e_pe = 0.008606 + 2.15E-9 * d2k;
					var M_pe = 260.2471 + 0.005995147 * d2k;

				//}


			}


			//Pluto
			if (id==10) {

				//Empty
				var N_pe = 110.299;
				var i_pe = 17.1600;
				var w_pe = 113.834;
				var a_pe = 39.4820;
				var e_pe = 0.24880;
				var M_pe = 14.5300 +  3.9753e-03 * d2k;

			}

			var d2k2=jd0-2451544.5;


			//Mars
			//Phobos
			if (id==11) {

				N_pe = 8.481060425430211E+01;
				i_pe = 2.605134469886070E+01;
				w_pe = 3.423765910100809E+02;
				a_pe = 6.268997359349237E-05;
				e_pe = 1.541576010324554E-02;
				M_pe = 3.458103339550481E+02 + 1128.8447569*d2k2;

			}

			//Deimos
			if (id==12) {

				N_pe = 8.366378701785975E+01;
				i_pe = 2.757017394957633E+01;
				w_pe = 1.902389390980262E+02;
				a_pe = 1.568129796127602E-04;
				e_pe = 2.419652870165075E-04;
				M_pe = 2.441619442347549E+02 + 285.1618790*d2k2;

			}


			//Jupiter
			//Io
			if (id==13) {

				var N_pe = 3.368501231726219E+02;
				var i_pe = 2.212609179741271E+00;
				var w_pe = 6.218469675691234E+01;
				var a_pe = 2.821786546733507E-03;
				var e_pe = 3.654784965339888E-03;
				var M_pe = 2.373891296290639E+02+203.4889583*d2k2;

			}


			//Europa
			if (id==14) {
		
				var N_pe = 3.326257958798038E+02;
				var i_pe = 1.790857714257787E+00;
				var w_pe = 2.557899602714836E+02;
				var a_pe = 4.484929379399280E-03;
				var e_pe = 9.470425146083724E-03;
				var M_pe = 2.935888371825263E+02+101.3747242*d2k2;

			}


			//Ganimedes
			if (id==15) {

				var N_pe = 3.431712649776430E+02;
				var i_pe = 2.214135822185767E+00;
				var w_pe = 3.167413036642092E+02;
				var a_pe = 7.156339844320714E-03;
				var e_pe = 1.318103012416448E-03;
				var M_pe = 2.549526340828426E+02+50.3176072*d2k2;

			}

			
			//Calixto
			if (id==16) {

				N_pe = 3.379421848030697E+02;
				i_pe = 2.016903900389733E+00;
				w_pe = 1.632112921781330E+01;
				a_pe = 1.258560648085115E-02;
				e_pe = 7.432943295907821E-03;
				M_pe = 7.414059442296413E+01+21.5710728*d2k2;

			}



			//Saturn
			//Mimas
			if (id==17) {

				N_pe = 1.720395274722895E+02;
				i_pe = 2.699220990012681E+01;
				w_pe = 1.022315286269462E+02;
				a_pe = 1.238980323863982E-03;
				e_pe = 1.931732199953316E-02;
				M_pe = 2.129053862732353E+02+381.9944948*d2k2;

				
			}


			//Enceladus
			if (id==18) {

				N_pe = 1.695071484839896E+02;
				i_pe = 2.805205056500874E+01;
				w_pe = 1.353498832095572E+02;
				a_pe = 1.590514291862022E-03;
				e_pe = 3.800205898425867E-03;
				M_pe = 2.356731393892689E+02+262.7318978*d2k2;

			}


			//Thetys
			if (id==19) {

				N_pe = 1.679913915983169E+02;
				i_pe = 2.722263076953313E+01;
				w_pe = 3.560838041558478E+02;
				a_pe = 1.971429702792761E-03;
				e_pe = 1.164517420921776E-03;
				M_pe = 5.697268166959598E+01+190.6979109*d2k2;

			}


			//Dione
			if (id==20) {

				N_pe = 1.694703277999466E+02;
				i_pe = 2.804136080194010E+01;
				w_pe = 1.507973659955503E+02;
				a_pe = 2.525457947691101E-03;
				e_pe = 1.736045468638893E-03;
				M_pe = 2.803956993515679E+02+131.5349307*d2k2;

			}


			//Rhea
			if (id==21) {

				N_pe = 1.689841761320379E+02;
				i_pe = 2.824158507526129E+01;
				w_pe = 1.666057394300591E+02;
				a_pe = 3.518765656270237E-03;
				e_pe = 1.780625383856148E-03;
				M_pe = 1.662338530915569E+02+79.6900459*d2k2;

			}


			//Titan
			if (id==22) {

				N_pe = 1.692390641054142E+02;
				i_pe = 2.771834210593259E+01;
				w_pe = 1.644183779722556E+02;
				a_pe = 8.166129280477890E-03;
				e_pe = 2.860979548429745E-02;
				M_pe = 1.521382513926225E+02+22.5769756*d2k2;

			}


			//Hyperion
			if (id==23) {

				N_pe = 1.683048627944878E+02;
				i_pe = 2.720899210390892E+01;
				w_pe = 1.884128260988440E+02;
				a_pe = 9.919653233908438E-03;
				e_pe = 1.266091225163045E-01;
				M_pe = 6.244152630925898E+01+16.9199503*d2k2;

			}


			//Japetus
			if (id==24) {

				N_pe = 1.396828095621823E+02;
				i_pe = 1.723871141910870E+01;
				w_pe = 2.294677454226293E+02;
				a_pe = 2.380499201420705E-02;
				e_pe = 2.834795908725012E-02;
				M_pe = 2.059889149249030E+02+4.5379416*d2k2;

			}


			//Phoebe
			if (id==25) {

				N_pe = 2.633087394964585E+02;
				i_pe = 1.732628430120298E+02;
				w_pe = 3.540532970705850E+02;
				a_pe = 8.654935137962398E-02;
				e_pe = 1.649261004952202E-01;
				M_pe = 5.818010827278169E+01+0.6569114*d2k2;

			}


			//Janus
			if (id==26) {

				N_pe = 1.698473601984617E+02;
				i_pe = 2.798098926862632E+01;
				w_pe = 1.234359436241147E+02;
				a_pe = 1.012230735662596E-03;
				e_pe = 4.906353370657049E-03;
				M_pe = 2.209929623175199E+02+518.3431513*d2k2;

			}

			//Uranus				

			//Ariel
			if (id==27) {

				N_pe = 1.676167914139716E+02;
				i_pe = 9.772134760425961E+01;
				w_pe = 4.973262455511961E+01;
				a_pe = 1.276692508123405E-03;
				e_pe = 1.630875487416978E-03;
				M_pe = 7.697066616582393E+01+142.8356579*d2k2;

			}


			//Umbriel			
			if (id==28) {
			
				N_pe = 1.676370925030037E+02;
				i_pe = 9.767931479523560E+01;
				w_pe = 3.355722494352460E+02;
				a_pe = 1.777934440646662E-03;
				e_pe = 4.244349021728350E-03;
				M_pe = 2.271760895583297E+02+86.8688879*d2k2;

			}


			//Titania
			if (id==29) {

				N_pe = 1.676132208706535E+02;
				i_pe = 9.782120140909615E+01;
				w_pe = 2.015624202837313E+02;
				a_pe = 2.915906576974097E-03;
				e_pe = 2.442003729739862E-03;
				M_pe = 5.431281239747835E+01+41.3514246*d2k2;

			}


			//Oberon
			if (id==30) {

				N_pe = 1.677563134362464E+02;
				i_pe = 9.787785138747165E+01;
				w_pe = 2.463445837749053E+02;
				a_pe = 3.900427464221857E-03;
				e_pe = 5.271058116251261E-04;
				M_pe = 8.780553944718648E+01+26.7394888*d2k2;

			}

			
			//Miranda
			if (id==31) {

				N_pe = 1.720652210524491E+02;
				i_pe = 9.726671274222224E+01;
				w_pe = 2.552348930165850E+02;
				a_pe = 8.680587982647246E-04;
				e_pe = 1.623369579841628E-03;
				M_pe = 3.004895617262656E+02+254.6906576*d2k2;

			}


			//Neptuno
			//Triton
			if (id==32) {

				N_pe = 2.158457802871240E+02;
				i_pe = 1.302570776450929E+02;
				w_pe = 1.782690820081133E+01;
				a_pe = 2.370976310514992E-03;
				e_pe = 2.632350027425206E-05;
				M_pe = 2.617064555840457E+01+61.2572638*d2k2;

			}


			//Nereid
			if (id==33) {

				N_pe = 3.194568853449903E+02;
				i_pe = 5.068595104328435E+00;
				w_pe = 2.970798086635425E+02;
				a_pe = 3.686029046482631E-02;
				e_pe = 7.501342561743685E-01;
				M_pe = 2.152748117679954E+02+0.9996276*d2k2;

			}


			//Proteus
			if (id==34) {

				N_pe = 4.828031783066957E+01;
				i_pe = 2.898546270460038E+01;
				w_pe = 2.753336419093413E+02;
				a_pe = 7.858189236349865E-04;
				e_pe = 3.362495897270810E-04;
				M_pe = 1.747354279210575E+02+320.7656245*d2k2;

			}


			//Plutp
			//Charon
			if (id==35) {

				N_pe = 2.274081682421894E+02;
				i_pe = 1.128748115496647E+02;
				w_pe = 1.417528725501745E+02+0*52.47888312207943*d2k2;
				a_pe = 1.309796554176127E-04;
				e_pe = 1.074904394264132E-04;
				M_pe = 1.513300210260559E+02+56.36252249216913*d2k2;

			}



			var Mj=(19.8950 + 0.0830853001 * d2k)*dtor;
			var Ms=(316.9670 + 0.0334442282 * d2k)*dtor;
			var Mu=(142.5905 + 0.011725806 * d2k)*dtor;


			N_pe=N_pe*dtor;
			i_pe=i_pe*dtor;
			w_pe=w_pe*dtor;
			M_pe=M_pe*dtor;

			var E_pe=M_pe+e_pe*Math.sin(M_pe)*(1+e_pe*Math.cos(M_pe));

			for (var k=0; k<10;k++) {
				E_pe=E_pe-(E_pe-e_pe*Math.sin(E_pe)-M_pe)/(1-e_pe*Math.cos(E_pe));
			}

			var xv_pe=a_pe*(Math.cos(E_pe)-e_pe);
			var yv_pe=a_pe*(Math.sqrt(1-e_pe*e_pe)*Math.sin(E_pe));

			var v_pe=Math.atan2(yv_pe,xv_pe);
			var r_pe=Math.sqrt(xv_pe*xv_pe+yv_pe*yv_pe);


			var cos_N_pe=Math.cos(N_pe);
			var sin_N_pe=Math.sin(N_pe);
			var cos_v_w_pe=Math.cos(v_pe+w_pe);
			var sin_v_w_pe=Math.sin(v_pe+w_pe);
			var cos_i_pe=Math.cos(i_pe);
			var sin_i_pe=Math.sin(i_pe);
			
			var xh_pe = r_pe * ( cos_N_pe * cos_v_w_pe - sin_N_pe * sin_v_w_pe * cos_i_pe );
			var yh_pe = r_pe * ( sin_N_pe * cos_v_w_pe + cos_N_pe * sin_v_w_pe * cos_i_pe );
			var zh_pe = r_pe * ( sin_v_w_pe * sin_i_pe );


			var lonecl_pe=Math.atan2(yh_pe,xh_pe);
			var latecl_pe=Math.atan2(zh_pe,Math.sqrt(xh_pe*xh_pe+yh_pe*yh_pe));

			var lat_m_corr=0;
			var lon_m_corr=0;

			if (id==6) {

				lon_m_corr=
					-0.332 * Math.sin(2*Mj - 5*Ms - 67.6*dtor)
					-0.056 * Math.sin(2*Mj - 2*Ms + 21*dtor)
					+0.042 * Math.sin(3*Mj - 5*Ms + 21*dtor)
					-0.036 * Math.sin(Mj - 2*Ms)
					+0.022 * Math.cos(Mj - Ms)
					+0.023 * Math.sin(2*Mj - 3*Ms + 52*dtor)
					-0.016 * Math.sin(Mj - 5*Ms - 69*dtor);

				lat_m_corr=0;

			}

			if (id==7) {

				lon_m_corr=
					+0.812 * Math.sin(2*Mj - 5*Ms - 67.6*dtor)
					-0.229 * Math.cos(2*Mj - 4*Ms - 2*dtor)
					+0.119 * Math.sin(Mj - 2*Ms - 3*dtor)
					+0.046 * Math.sin(2*Mj - 6*Ms - 69*dtor)
					+0.014 * Math.sin(Mj - 3*Ms + 32*dtor);
				
					lat_m_corr=
					-0.020 * Math.cos(2*Mj - 4*Ms - 2*dtor)
					+0.018 * Math.sin(2*Mj - 6*Ms - 49*dtor);

			}

			
			if (id==8) {

				lon_m_corr=
					+0.040 * Math.sin(Ms - 2*Mu + 6*dtor)
					+0.035 * Math.sin(Ms - 3*Mu + 33*dtor)
					-0.015 * Math.sin(Mj - Mu + 20*dtor);

					lat_m_corr=0;

			}


			if (id==-10) {

				var S  =   50.03  +  0.033459652 * d2k;
				var P  =  238.95  +  0.003968789 * d2k;
	
				S=S*dtor;
				P=P*dtor;

				lonecl_pe = 238.9508  +  0.00400703 * d2k;
				- 19.799 * Math.sin(P)     + 19.848 * Math.cos(P)
				+ 0.897 * Math.sin(2*P)    - 4.956 * Math.cos(2*P)
				+ 0.610 * Math.sin(3*P)    + 1.211 * Math.cos(3*P)
				- 0.341 * Math.sin(4*P)    - 0.190 * Math.cos(4*P)
				+ 0.128 * Math.sin(5*P)    - 0.034 * Math.cos(5*P)
				- 0.038 * Math.sin(6*P)    + 0.031 * Math.cos(6*P)
				+ 0.020 * Math.sin(S-P)    - 0.010 * Math.cos(S-P);

				latecl_pe =  -3.9082
				- 5.453 * Math.sin(P)     - 14.975 * Math.cos(P)
				+ 3.527 * Math.sin(2*P)    + 1.673 * Math.cos(2*P)
				- 1.051 * Math.sin(3*P)    + 0.328 * Math.cos(3*P)
				+ 0.179 * Math.sin(4*P)    - 0.292 * Math.cos(4*P)
				+ 0.019 * Math.sin(5*P)    + 0.100 * Math.cos(5*P)
				- 0.031 * Math.sin(6*P)    - 0.026 * Math.cos(6*P)
											+ 0.011 * Math.cos(S-P);

				r_pe     =  40.72
				+ 6.68 * Math.sin(P)       + 6.90 * Math.cos(P)
				- 1.18 * Math.sin(2*P)     - 0.03 * Math.cos(2*P)
				+ 0.15 * Math.sin(3*P)     - 0.14 * Math.cos(3*P);

				lonecl_pe*=dtor;
				latecl_pe*=dtor;


			}

			var xs1=planet_pos[planet_parent[id]].x;
			var ys1=planet_pos[planet_parent[id]].z;
			var zs1=planet_pos[planet_parent[id]].y;


			lonecl_pe=lonecl_pe+lon_m_corr*dtor;
			latecl_pe=latecl_pe+lat_m_corr*dtor;


			var cos_lonecl_pe=Math.cos(lonecl_pe);
			var sin_lonecl_pe=Math.sin(lonecl_pe);
			var cos_latecl_pe=Math.cos(latecl_pe);
			var sin_latecl_pe=Math.sin(latecl_pe);				

			xh_pe = r_pe * cos_lonecl_pe * cos_latecl_pe + xs1;
			yh_pe = r_pe * sin_lonecl_pe * cos_latecl_pe + ys1;
			zh_pe = r_pe * sin_latecl_pe + zs1;


			xx=new BABYLON.Vector3(xh_pe,zh_pe,yh_pe);


			if ((id==14 || id==15 || id==16 || id==13) && true) {

				var ur=new BABYLON.Vector3(0,0,1);
				var ud0=new BABYLON.Vector3(0,0,0);
				var u3=new BABYLON.Vector3(0,0,0);

				var nn=6;

				var ang=-planet_ori1[nn];
				var cos_ang=Math.cos(ang);
				var sin_ang=Math.sin(ang);
				ud0.x=ur.x;
				ud0.y=ur.y*cos_ang-ur.z*sin_ang;
				ud0.z=ur.y*sin_ang+ur.z*cos_ang;

				ang=-planet_ori2[nn];
				cos_ang=Math.cos(ang);
				sin_ang=Math.sin(ang);
				u3.x=ud0.x*cos_ang-ud0.y*sin_ang;
				u3.y=ud0.x*sin_ang+ud0.y*cos_ang;
				u3.z=ud0.z;

				var u1=new BABYLON.Vector3(0,0,0);
				var u2=new BABYLON.Vector3(0,0,0);

				var re=new BABYLON.Vector3(0,0,0);

				
				re.x=planet_pos[6].x-planet_pos[3].x;
				re.y=planet_pos[6].z-planet_pos[3].z;
				re.z=planet_pos[6].y-planet_pos[3].y;
				re.normalize();
				

				u1.x=-(u3.y*re.z-re.y*u3.z);
				u1.y=+(u3.x*re.z-re.x*u3.z);
				u1.z=-(u3.x*re.y-re.x*u3.y);
				u1.normalize();

				u2.x=-(u1.y*u3.z-u3.y*u1.z);
				u2.y=+(u1.x*u3.z-u3.x*u1.z);
				u2.z=-(u1.x*u3.y-u3.x*u1.y);
				u2.normalize();

				var tt4=jd0-2451545.0;

				var V=172.74+0.00111588*tt4;
				var sinV=Math.sin(V*dtor);
				var M=357.529+0.9856003*tt4;
				var N=20.020+0.0830853*tt4+0.329*sinV;
				var J=66.115+0.9025179*tt4-0.329*sinV;
				var M_dtor=M*dtor;
				var N_dtor=N*dtor;
				var A=1.915*Math.sin(M_dtor)+0.020*Math.sin(2*M_dtor);
				var B=5.555*Math.sin(N_dtor)+0.168*Math.sin(2*N_dtor);
				
				var R=1.0014-0.01671*Math.cos(M_dtor)-0.00014*Math.cos(2*M_dtor);
				var r=5.20872-0.25208*Math.cos(N_dtor)-0.00611*Math.cos(2*N_dtor);

				var K=J+A-B;
				var delta=Math.sqrt(r*r+R*R-2*r*R*Math.cos(K*dtor));
				var PSI=Math.asin(R/delta*Math.sin(K*dtor))/dtor;
				
				//speed light correction
				delta=delta/173.0;
				var tt4_delta=tt4-delta*0;

				var PSI_B=PSI-B;
				var ua1=163.8069+203.4058646*(tt4_delta)+PSI_B;
				var ua2=358.4140+101.2916335*(tt4_delta)+PSI_B;
				var ua3=5.7176+50.2345180*(tt4_delta)+PSI_B;
				var ua4=224.8092+21.4879800*(tt4_delta)+PSI_B;

				var G=331.18+50.310482*(tt4_delta);
				var H=87.45+21.569231*(tt4_delta);
				
				ua1=ua1*dtor;
				ua2=ua2*dtor;
				ua3=ua3*dtor;
				ua4=ua4*dtor;

				if (id==13) {

					var arg=2*ua1-2*ua2;
					var u=ua1+0.473*Math.sin(arg)*dtor;
					var rad=planet_rad[6]*i_ua_km*(5.9057-0.0244*Math.cos(arg));
					var cosu=Math.cos(u);
					var sinu=Math.sin(u);
					var px=rad*(u1.x*sinu-u2.x*cosu);
					var py=rad*(u1.y*sinu-u2.y*cosu);
					var pz=rad*(u1.z*sinu-u2.z*cosu);
			
					xx=new BABYLON.Vector3(planet_pos[6].x+px,planet_pos[6].y+pz,planet_pos[6].z+py);

				}

				if (id==14) {

					var arg=2*ua2-2*ua3;
					var u=ua2+1.065*Math.sin(arg)*dtor;
					var rad=planet_rad[6]*i_ua_km*(9.3966-0.0882*Math.cos(arg));
					var cosu=Math.cos(u);
					var sinu=Math.sin(u);
					var px=rad*(u1.x*sinu-u2.x*cosu);
					var py=rad*(u1.y*sinu-u2.y*cosu);
					var pz=rad*(u1.z*sinu-u2.z*cosu);

					xx=new BABYLON.Vector3(planet_pos[6].x+px,planet_pos[6].y+pz,planet_pos[6].z+py);

				}

				if (id==15) {

					var arg=G*dtor;
					var u=ua3+0.165*Math.sin(arg)*dtor;
					var rad=planet_rad[6]*i_ua_km*(14.9883-0.0216*Math.cos(arg));
					var cosu=Math.cos(u);
					var sinu=Math.sin(u);
					var px=rad*(u1.x*sinu-u2.x*cosu);
					var py=rad*(u1.y*sinu-u2.y*cosu);
					var pz=rad*(u1.z*sinu-u2.z*cosu);

					xx=new BABYLON.Vector3(planet_pos[6].x+px,planet_pos[6].y+pz,planet_pos[6].z+py);

				}

				if (id==16) {

					var arg=H*dtor;
					var u=ua4+0.843*Math.sin(arg)*dtor;
					var rad=planet_rad[6]*i_ua_km*(26.3627-0.1939*Math.cos(arg));
					var cosu=Math.cos(u);
					var sinu=Math.sin(u);
					var px=rad*(u1.x*sinu-u2.x*cosu);
					var py=rad*(u1.y*sinu-u2.y*cosu);
					var pz=rad*(u1.z*sinu-u2.z*cosu);

					xx=new BABYLON.Vector3(planet_pos[6].x+px,planet_pos[6].y+pz,planet_pos[6].z+py);

				}


			}


			//Corrección de Encelado a Titan
			if ((id==18 || id==19 || id==20 || id==21 || id==22) && false) {

				var ur=new BABYLON.Vector3(0,0,1);
				var ud0=new BABYLON.Vector3(0,0,0);
				var u3=new BABYLON.Vector3(0,0,0);

				var nn=7;

				var ang=-planet_ori1[nn];
				var cos_ang=Math.cos(ang);
				var sin_ang=Math.sin(ang);
				ud0.x=ur.x;
				ud0.y=ur.y*cos_ang-ur.z*sin_ang;
				ud0.z=ur.y*sin_ang+ur.z*cos_ang;

				ang=-planet_ori2[nn];
				cos_ang=Math.cos(ang);
				sin_ang=Math.sin(ang);
				u3.x=ud0.x*cos_ang-ud0.y*sin_ang;
				u3.y=ud0.x*sin_ang+ud0.y*cos_ang;
				u3.z=ud0.z;

				var u1=new BABYLON.Vector3(0,0,0);
				var u2=new BABYLON.Vector3(0,0,0);

				var re=new BABYLON.Vector3(0,0,0);

				re.x=planet_pos[7].x-planet_pos[3].x;
				re.y=planet_pos[7].z-planet_pos[3].z;
				re.z=planet_pos[7].y-planet_pos[3].y;
				//var red=Math.sqrt(re.x*re.x+re.y*re.y+re.z*re.z);
				//re.x/=red;re.y/=red;re.z/=red;
				re.normalize();

				u1.x=-(u3.y*re.z-re.y*u3.z);
				u1.y=+(u3.x*re.z-re.x*u3.z);
				u1.z=-(u3.x*re.y-re.x*u3.y);
				//var u1m=Math.sqrt(u1.x*u1.x+u1.y*u1.y+u1.z*u1.z);
				//u1.x/=u1m;u1.y/=u1m;u1.z/=u1m;
				u1.normalize();

				u2.x=-(u1.y*u3.z-u3.y*u1.z);
				u2.y=+(u1.x*u3.z-u3.x*u1.z);
				u2.z=-(u1.x*u3.y-u3.x*u1.y);
				//var u2m=Math.sqrt(u2.x*u2.x+u2.y*u2.y+u2.z*u2.z);
				//u2.x/=u2m;u2.y/=u2m;u2.z/=u2m;
				u2.normalize();

				
				var RAD = 180 / Math.PI;


				var T = (jd0 - 2415020.0) / 36525;
				var T1 = T - Math.floor(T);

				var E0 = 0.01675;
				var M0 = (358.47583 + 36000 * T1 - 0.95025 * T) / RAD;
				var C0 = 2 * E0 * Math.sin(M0) + 1.25 * E0 * E0 * Math.sin(2 * M0);
				var L0 = (99.697 + 36000 * T1 + 0.76892 * T) / RAD + C0;
				var E8 = (23.452294 - 0.0130125 * T) / RAD;
	
				var sin_E8=Math.sin(E8);
				var cos_E8=Math.cos(E8);				

				var E6 = 0.05589;
				var M6 = (175.46622 + 1080 * T1 + 141.55147 * T) / RAD;
				var C6 = 2 * E6 * Math.sin(M6) + 1.25 * E6 * E6 * Math.sin(2 * M6);
				var L6 = (266.564 + 1080 * T1 + 143.509884 * T) / RAD + C6;
				var A6 = 9.554747;
				var B6 = 2.49 / RAD * Math.sin(L6 - (112.79 + 0.87 * T) / RAD);


				var K = L0 - L6;
				var D1 = Math.sqrt(A6 * A6 + 1 - 2 * A6 * Math.cos(K));
				var P2 = Math.sin(K) / D1;
				var P2 = Math.atan(P2 / Math.sqrt(1 - P2 * P2));
				var L3 = L6 - P2;

				var sin_L3=Math.sin(L3);

				var B3 = B6 * A6 / D1;

				var sin_B3=Math.sin(B3);
				var cos_B3=Math.cos(B3);

				var Q1 = sin_L3 * cos_E8 - sin_B3 * sin_E8 / cos_B3;
				var Q2 = Math.cos(L3);
				var A4 = Math.atan2(Q1,Q2);
				var D4 = sin_B3 * cos_E8 + cos_B3 * sin_E8 * sin_L3;
				var D4 = Math.atan(D4 / Math.sqrt(1 - D4 * D4));

				var sin_D4=Math.sin(D4);
				var cos_D4=Math.cos(D4);

				//speed-light correction
				var LT = D1 / (173 * 36525)*0; 


				var I6 = 28.08 / RAD;

				var cos_I6=Math.cos(I6);
				var sin_I6=Math.sin(I6);

				var N6 = (168.12 + 1.4 * T) / RAD;

				var cos_N6=Math.cos(N6);
				var sin_N6=Math.sin(N6);

				var J6 = cos_I6 * cos_E8 - sin_I6 * sin_E8 * cos_N6;
				J6 = Math.atan(Math.sqrt(1 - J6 * J6) / J6);

				var sin_J6=Math.sin(J6);
				var cos_J6=Math.cos(J6);

				var D7 = cos_I6 * sin_E8 + sin_I6 * cos_E8 * cos_N6;
				var N7 = Math.atan(sin_I6 * sin_N6 / D7) + Math.PI;
				D7 = sin_I6 * cos_E8 + cos_I6 * sin_E8 * cos_N6;

				var W6 = Math.atan(sin_E8 * sin_N6 / D7);
				var B6 = sin_J6 * cos_D4 * Math.sin(A4 - N7) - cos_J6 * sin_D4;
				B6 = Math.atan(B6 / Math.sqrt(1 - B6 * B6));
				var U6 = cos_J6 * cos_D4 * Math.sin(A4 - N7) + sin_J6 * sin_D4;
				var U7 = cos_D4 * Math.cos(A4 - N7);
				U6 = Math.atan2(U6,U7);
				//var X1 = 2.35;

				//var X0 = 1.56;

				//var de = B6 * RAD;
				//var rings = Math.abs(de);

				var TA = T1 - LT;
				var TB = T - LT;
				var O2 = (187.76 + 9596160 * TA + 124.126763 * TB) / RAD;
				var O3 = (355.32 + 6964920 * TA + 322.62375 * TB) / RAD;
				var O4 = (191.71 + 4804200 * TA + 114.885173 * TB) / RAD;
				var O5 = (101.37 + 2910600 * TA + 80.467853 * TB) / RAD;
				var O6 = (271.66 + 824400 * TA + 225.475797 * TB) / RAD;


				O2 = O2 - N6 + W6+Math.PI;
				O3 = O3 - N6 + W6+Math.PI;
				O4 = O4 - N6 + W6+Math.PI;
				O5 = O5 - N6 + W6+Math.PI;
				O6 = O6 - N6 + W6+Math.PI;


				if (id==18) {

					var u=O2-U6;
					var rad=planet_rad[7]*i_ua_km*4.1;
					var cosu=Math.cos(u);
					var sinu=Math.sin(u);
					var px=rad*(u1.x*sinu-u2.x*cosu);
					var py=rad*(u1.y*sinu-u2.y*cosu);
					var pz=rad*(u1.z*sinu-u2.z*cosu);
			
					xx=new BABYLON.Vector3(planet_pos[7].x+px,planet_pos[7].y+pz,planet_pos[7].z+py);

				}

				if (id==19) {

					var u=O3-U6;
					var rad=planet_rad[7]*i_ua_km*5.08;
					var cosu=Math.cos(u);
					var sinu=Math.sin(u);
					var px=rad*(u1.x*sinu-u2.x*cosu);
					var py=rad*(u1.y*sinu-u2.y*cosu);
					var pz=rad*(u1.z*sinu-u2.z*cosu);
			
					xx=new BABYLON.Vector3(planet_pos[7].x+px,planet_pos[7].y+pz,planet_pos[7].z+py);

				}

				if (id==20) {

					var u=O4-U6;
					var rad=planet_rad[7]*i_ua_km*6.51;
					var cosu=Math.cos(u);
					var sinu=Math.sin(u);
					var px=rad*(u1.x*sinu-u2.x*cosu);
					var py=rad*(u1.y*sinu-u2.y*cosu);
					var pz=rad*(u1.z*sinu-u2.z*cosu);
			
					xx=new BABYLON.Vector3(planet_pos[7].x+px,planet_pos[7].y+pz,planet_pos[7].z+py);

				}

				if (id==21) {

					var u=O5-U6;
					var rad=planet_rad[7]*i_ua_km*9.09;
					var cosu=Math.cos(u);
					var sinu=Math.sin(u);
					var px=rad*(u1.x*sinu-u2.x*cosu);
					var py=rad*(u1.y*sinu-u2.y*cosu);
					var pz=rad*(u1.z*sinu-u2.z*cosu);
			
					xx=new BABYLON.Vector3(planet_pos[7].x+px,planet_pos[7].y+pz,planet_pos[7].z+py);

				}

				if (id==22) {

					var u=O6-U6;
					var rad=planet_rad[7]*i_ua_km*21.1*0.95;
					var cosu=Math.cos(u);
					var sinu=Math.sin(u);
					var px=rad*(u1.x*sinu-u2.x*cosu);
					var py=rad*(u1.y*sinu-u2.y*cosu);
					var pz=rad*(u1.z*sinu-u2.z*cosu);
			
					xx=new BABYLON.Vector3(planet_pos[7].x+px,planet_pos[7].y+pz,planet_pos[7].z+py);

				}

				

			}



			//Correccion de la posicion de Mimas
			if (id==17) {

				var sx=planet_pos[7].x;
				var sy=planet_pos[7].z;
				var sz=planet_pos[7].y;

				var slambda0=Math.atan2(sy,sx);
				var sbeta0=Math.atan(sz/Math.sqrt(sx*sx+sy*sy));

				var st1=jd0-2411093.0;
				var st2=st1/365.25;
				var st3=(jd0-2433282.423)/365.25+1950.0;

				var sW0=5.095*(st3-1866.39);sW0*=dtor;

				var s1=Math.sin(28.0817*dtor-0.5*sbeta0);
				var c1=Math.cos(28.0817*dtor-0.5*sbeta0);
				var s2=Math.sin((168.8112+slambda0/dtor+269)*dtor);
				var c2=Math.cos((168.8112+slambda0/dtor+269)*dtor);

				
				var sL=127.64+381.994497*st1-43.57*Math.sin(sW0)-0.720*Math.sin(3*sW0)-0.02144*Math.sin(5*sW0); sL*=dtor;
				var sp=106.1+365.549*st2;sp*=dtor;
				var sM=sL-sp;
				var sC=2.18287*Math.sin(sM)+0.025988*Math.sin(2*sM)+0.00043*Math.sin(3*sM);sC*=dtor;

				var slambda=sL+sC;

				var sr=(planet_rad[7]*i_ua_km)*3.06879/(1+0.01905*Math.cos(sM+sC));
				var sgamma=1.563*dtor;
				var sOMEGA=54.5-365.072*st2;sOMEGA*=dtor;

				
				var su=slambda-sOMEGA;
				var sw=sOMEGA-(168.8112)*dtor;

				
				var sx1=sr*(Math.cos(su)*Math.cos(sw)-Math.sin(su)*Math.cos(sgamma)*Math.sin(sw));
				var sy1=sr*(Math.sin(su)*Math.cos(sw)*Math.cos(sgamma)+Math.cos(su)*Math.sin(sw));
				var sz1=sr*Math.sin(su)*Math.sin(sgamma);


				var sA1=sx1;
				var sB1=c1*sy1-s1*sz1;
				var sC1=s1*sy1+c1*sz1;

				var sA2=c2*sA1-s2*sB1;
				var sB2=s2*sA1+c2*sB1;
				var sC2=sC1;

				
				var sA3=sA2*Math.sin(slambda0)-sB2*Math.cos(slambda0);
				var sB3=sA2*Math.cos(slambda0)+sB2*Math.sin(slambda0);
				var sC3=sC2;

				var sA4=sA3;
				var sB4=sB3*Math.cos(sbeta0)+sC3*Math.sin(sbeta0);
				var sC4=sC3*Math.cos(sbeta0)-sB3*Math.sin(sbeta0);


				xx=new BABYLON.Vector3(planet_pos[7].x+sA4,planet_pos[7].y+sC4,planet_pos[7].z+sB4);

				
			}



			return xx;

		}





		//Carga las texturas de planetas y satelites			
		function texture_list() {
			
			planet_text[0]="images/sun_01.jpg";
			planet_text[1]="images/mercury_01.jpg";
			planet_text[2]="images/venus_01.jpg";

			planet_text[3]="images/earth_01.jpg";
			//planet_text[3]="images/earth_02.jpg";
			//planet_text[3]="images/earth_ecl_03.jpg";				
			planet_text[4]="images/moon_01.jpg";	

			planet_text[5]="images/mars_02.jpg";
			planet_text[6]="images/jupiter_01.jpg";
			planet_text[7]="images/saturn_01.jpg";
			planet_text[8]="images/uranus_01.jpg";
			planet_text[9]="images/neptune_01.jpg";
			
			planet_text[10]="images/pluto_02.jpg";

			planet_text[11]="images/phobos_02.jpg";
			planet_text[12]="images/deimos_01.jpg";
			
			planet_text[13]="images/io_01.jpg";
			planet_text[14]="images/europa_01.jpg";
			planet_text[15]="images/ganymede_01.jpg";
			planet_text[16]="images/calixto_01.jpg";
			
			planet_text[17]="images/mimas_02.jpg";
			planet_text[18]="images/enceladus_01.jpg";
			planet_text[19]="images/tethys_01.jpg";
			planet_text[20]="images/dione_01.jpg";
			planet_text[21]="images/rhea_01.jpg";
			planet_text[22]="images/titan_01.jpg";
			planet_text[23]="images/hyperion_01.jpg";
			planet_text[24]="images/iapetus_01.jpg";
			planet_text[25]="images/phoebe_01.jpg";
			planet_text[26]="images/janus_02.jpg";
			
			planet_text[27]="images/ariel_01.jpg";
			planet_text[28]="images/umbriel_01.jpg";
			planet_text[29]="images/titania_01.jpg";
			planet_text[30]="images/oberon_01.jpg";
			planet_text[31]="images/miranda_01.jpg";
			
			planet_text[32]="images/triton_02.jpg";
			planet_text[33]="images/nereid_01.jpg";
			planet_text[34]="images/proteus_01.jpg";

			planet_text[35]="images/charon_01.jpg";


			//bump
			planet_text_bump[1]="images/mercury_bump_02.jpg"; //corregido
			planet_text_bump[4]="images/moon_bumpmap_04.jpg"; //corregido
			planet_text_bump[5]="images/mars_bump_04.jpg"; //corregido
			planet_text_bump[11]="images/phobos_bump_01.jpg"; //corregido

			planet_text_bump[13]="images/io_bump_02.jpg";
			planet_text_bump[15]="images/ganymede_bump_02.jpg";

			planet_text_bump[17]="images/mimas_bump_04.jpg"; //corregido


			//displace
			planet_text_height[11]="images/phobos_heightmap_01.jpg";
			//planet_text_height[11]="/images/phobos_mod_02.jpg";
			planet_text_height[12]="images/deimos_height_01.jpg";
			planet_text_height[23]="images/hyperion_height_03.jpg";
			planet_text_height[25]="images/phoebe_heightmap.jpg";
			planet_text_height[26]="images/janus4_height_04.jpg";
			planet_text_height[34]="images/proteus_heightmap.jpg";

			
		}	


		//Calcula la orientacion  del polo en coordenadas eclipticas
		//y la posicion del primer meridiano de planetas y satelites

		//Report of the IAU Working Group on Cartographic Coordinates
		//and Rotational Elements (2009 & 2015)
		function planet_rotation() {

			var j1=jd;
			var t1 = (j1 -2451545.0)/36525.0; 
			var d=(j1-2451545.0);

			var fecha1=fecha.slice();
			fecha1[3]=0;fecha1[4]=0;fecha1[5]=0;

			var j0=calc_jd(fecha1);
			var j = (j0 - 2451545)/36525.0;
			var g0=100.46061837 + 36000.770053608*j + 0.000387933*j*j - j*j*j/38710000.0;     

			if (g0>360) {
				g0=g0+Math.floor(g0/360.0)*360.0;     
			} else {
				g0 = g0 - (Math.floor(g0/360.0) - 1.0)*360.0;
			}

			var ut=fecha[3]+fecha[4]/60.0+fecha[5]/3600.0;
			var gst = g0 + 360.98564724*ut/24.0;

			var ecl = 23.4393 - 3.563E-7 * d;
			ecl=ecl*dtor;
			var sinecl=Math.sin(ecl);
			var cosecl=Math.cos(ecl); 

			var ra0=[];
			var dec0=[];
			var w0=[];
			var ra,dec,elon,elat;

			ra0[0]=285.96;dec0[0]=63.96;w0[0]=84.11+14.1844000*d;
			ra0[1]=281.02-0.033*t1;dec0[1]=61.45-0.005*t1;w0[1]=329.71+6.1385025*d;
			w0[1]+=48.3313 + 3.24587E-5 * d;

			ra0[2]=272.78;dec0[2]=67.21;w0[2]=159.91-1.4814205*d;

			ra0[3]=0-0.641*t1;dec0[3]=90.0-0.557*t1;w0[3]=190.147-360.9856235*d;w0[3]=gst;
			if (dec0[3]>90) dec0[3]=90+(90-dec0[3]);

			//Luna - Errores de libración corregidos - 01/07/2023
			ra0[4]=0;dec0[4]=0;w0[4]=0;

			var E1,E2,E3,E4,E5,E6,E7,E8,E9,E10;
			var E11,E12,E13;

			dn=d*1;
			E1 = 125.045- 0.0529921*dn;E1=E1*dtor;
			E2 = 250.089- 0.1059842*dn;E2=E2*dtor;
			E3 = 260.008+ 13.0120009*dn;E3=E3*dtor;
			E4 = 176.625+ 13.3407154*dn;E4=E4*dtor;
			E5 = 357.529+ 0.9856003*dn;E5=E5*dtor;
			E6 = 311.589+ 26.4057084*dn;E6=E6*dtor;
			E7 = 134.963+ 13.0649930*dn;E7=E7*dtor;
			E8 = 276.617+ 0.3287146*dn;E8=E8*dtor;
			E9 = 34.226+ 1.7484877*dn;E9=E9*dtor;
			E10= 15.134- 0.1589763*dn;E10=E10*dtor;
			E11= 119.743+ 0.0036096*dn;E11=E11*dtor;
			E12= 239.961+ 0.1643573*dn;E12=E12*dtor;
			E13= 25.053+ 12.9590088*dn;E13=E13*dtor;

			var sin_E1=Math.sin(E1);
			var sin_E2=Math.sin(E2);
			var sin_E3=Math.sin(E3);
			var sin_E4=Math.sin(E4);
			var sin_E6=Math.sin(E6);
			var sin_E10=Math.sin(E10);
			var sin_E13=Math.sin(E13);


			ra0[4] = 269.9949+0.0031*t1-3.8787*sin_E1 -0.1204*sin_E2
			+0.0700*sin_E3 -0.0172*sin_E4 +0.0072*sin_E6
			-0.0052*sin_E10+0.0043*sin_E13;

			dec0[4] = 66.5392+0.0130*t1+1.5419*Math.cos(E1) +0.0239*Math.cos(E2)
			-0.0278*Math.cos(E3) +0.0068*Math.cos(E4) -0.0029*Math.cos(E6)
			+0.0009*Math.cos(E7) +0.0008*Math.cos(E10)-0.0009*Math.cos(E13);

			w0[4]= 38.3213+13.17635815*d -1.4e-12*d*d +1*(3.5610*sin_E1
			+0.1208*sin_E2 -0.0642*sin_E3 +0.0158*sin_E4
			+0.0252*Math.sin(E5) -0.0066*sin_E6 -0.0047*Math.sin(E7)
			-0.0046*Math.sin(E8) +0.0028*Math.sin(E9) +0.0052*sin_E10
			+0.0040*Math.sin(E11)+0.0019*Math.sin(E12)-0.0044*sin_E13);


			//b[4].w0+= 0.00014410*d*360.0+0.0012320*d-125;

			w0[4]+=-(125.1228 - 0.0529538083 * d); //precesion nodal de la luna
			
			//


			ra0[5]=317.681-0.108*t1;dec0[5]=52.886-0.061*t1;w0[5]=176.655+350.8919830*d+180.0*0;
			w0[5]+=-(49.5574 + 2.11081E-5 * d);

			ra0[6]=268.05-0.009*t1;dec0[6]=64.49+0.003*t1;w0[6]=43.3+870.270*d;
			w0[6]=284.95+870.5360000*d+180*0;
			w0[6]+=-(100.4542 + 2.76854E-5 * d)+160+grs_offset_angle+237.5;


			
			var jup_mean = (jd - 2455636.938) * 360 / 4332.89709;
			var eqn_center = 5.55 * Math.sin( jup_mean*dtor);
			var jangle = (jd - 2451870.628) * 360 / 398.884 - eqn_center;
			var w06_corr = 11 * Math.sin( jangle*dtor)
							+ 5 * Math.cos( jangle*dtor)
						- 1.25 * Math.cos( jup_mean*dtor) - eqn_center;


			w0[6]=181.62 + 870.1869147 * jd + w06_corr;
			w0[6]+=-(100.4542 + 2.76854E-5 * d)*0+grs_offset_angle; 



			ra0[7]=40.66-0.036*t1;dec0[7]=83.52-0.004*t1;w0[7]=227.2037+844.300*d;
			ra0[8]=257.43;dec0[8]=-15.10;w0[8]=261.62-554.913*d;
			ra0[9]=295.33;dec0[9]=40.65;w0[9]=107.21+468.75*d;

			ra0[10]=132.993;dec0[10]=-6.163;w0[10]=302.695+56.3625225*d;


			var M1,M2,M3;
			M1=169.51-0.4357640*d;M1*=dtor;
			M2=192.93+1128.4096700*d+8.864*t1*t1;M2*=dtor;
			M3=53.47-0.0181510*d;M3*=dtor;

			var sin_M1=Math.sin(M1);
			var sin_M3=Math.sin(M3);
			var cos_M3=Math.cos(M3);

			//Phobos
			ra0[11]=317.68-0.108*t1+1.79*sin_M1;
			dec0[11]=52.90-0.061*t1-1.08*Math.cos(M1);
			w0[11]=35.06+1128.8445850*d+8.864*t1*t1-1.42*sin_M1-0.78*Math.sin(M2);

			//Deimos
			ra0[12]=316.65-0.108*t1+2.98*sin_M3;
			dec0[12]=53.52-0.061*t1-1.78*cos_M3;
			w0[12]=79.41+285.1618970*d-0.520*t1*t1-2.58*sin_M3+0.19*cos_M3;

			
			var J1,J2,J3,J4,J5,J6,J7,J8;
			//J1 = 73.32 + 91472.9*t1;J1*=dtor;
			//J2 = 24.62 + 45137.2*t1;J2*=dtor; 
			J3 = 283.90 + 4850.7*t1;J3*=dtor;
			J4 = 355.80 + 1191.3*t1;J4*=dtor;
			J5 = 119.90 + 262.10*t1;J5*=dtor; 
			J6 = 229.80 + 64.300*t1;J6*=dtor;
			J7 = 352.25 + 2382.6*t1;J7*=dtor;
			J8 = 113.35 + 6070.0*t1;J8*=dtor;


			var sin_J3=Math.sin(J3);
			var cos_J3=Math.cos(J3);
			var sin_J4=Math.sin(J4);
			var cos_J4=Math.cos(J4);
			var sin_J5=Math.sin(J5);
			var cos_J5=Math.cos(J5);
			var sin_J6=Math.sin(J6);
			var cos_J6=Math.cos(J6);
			var sin_J7=Math.sin(J7);
			var cos_J7=Math.cos(J7);
			var sin_J8=Math.sin(J8);
			var cos_J8=Math.cos(J8);

			//Io
			ra0[13] = 268.05 - 0.009*t1 + 0.094*sin_J3 + 0.024*sin_J4;
			dec0[13] = 64.50 + 0.003*t1 + 0.040*cos_J3 + 0.011*cos_J4;
			w0[13] = 200.39 + 203.4889538*d - 0.085*sin_J3 - 0.022*sin_J4;

			//Europa
			ra0[14] = 268.08 - 0.009*t1 + 1.086*sin_J4 + 0.060*sin_J5 + 0.015*sin_J6 + 0.009*sin_J7;
			dec0[14] = 64.51 + 0.003*t1 + 0.468*cos_J4 + 0.026*cos_J5 + 0.007*cos_J6 + 0.002*cos_J7;
			w0[14] = 36.022 + 101.3747235*d - 0.980*sin_J4 - 0.054*sin_J5- 0.014*sin_J6 - 0.008*sin_J7;

			//Ganymede
			ra0[15] = 268.20 - 0.009*t1 - 0.037*sin_J4 + 0.431*sin_J5+ 0.091*sin_J6;
			dec0[15] = 64.57 + 0.003*t1 - 0.016*cos_J4 + 0.186*cos_J5+ 0.039*cos_J6;
			w0[15] = 44.064 + 50.3176081*d + 0.033*sin_J4 - 0.389*sin_J5- 0.082*sin_J6;

			//Calixto
			ra0[16] = 268.72 - 0.009*t1 - 0.068*sin_J5 + 0.590*sin_J6+0.010*sin_J8;
			dec0[16] = 64.83 + 0.003*t1 - 0.029*cos_J5 + 0.254*cos_J6- 0.004*cos_J8;
			w0[16] = 259.51 + 21.5710715*d + 0.061*sin_J5 - 0.533*sin_J6;



			var  S1,S2,S3,S4,S5,S6;
			//S1=353.32 + 75706.7*t1;S1*=dtor;
			S2=28.72 + 75706.7*t1;S2*=dtor;
			S3=177.40 - 36505.5*t1;S3*=dtor;
			S4=300.00 -  7225.9*t1;S4*=dtor;
			S5=316.45 +   506.2*t1;S5*=dtor;
			S6=345.20 -  1016.3*t1;S6*=dtor;

			var sin_S2=Math.sin(S2);
			var sin_2S2=Math.sin(2*S2);
			var sin_S3=Math.sin(S3);
			var sin_S4=Math.sin(S4);
			var sin_S5=Math.sin(S5);
			var sin_S6=Math.sin(S6);


			//Mimas
			ra0[17] =40.66-0.036*t1 +13.56*sin_S3;
			dec0[17] =83.52-0.004*t1 -1.53*Math.cos(S3);
			w0[17]=333.46+381.9945550*d-13.48*sin_S3-44.85*sin_S5;

			//Encelado
			ra0[18] =40.66-0.036*t1;
			dec0[18] =83.52-0.004*t1;
			w0[18]=6.32+262.7318996*d;

			//Tetis
			ra0[19] =40.66-0.036*t1 +9.66*sin_S4;
			dec0[19] =83.52-0.004*t1 -1.09*Math.cos(S4);
			w0[19] =8.95+190.6979085*d-9.60*sin_S4+2.23*sin_S5;

			//Dione
			ra0[20] =40.66-0.036*t1;
			dec0[20] =83.52-0.004*t1;
			w0[20] =357.6+131.5349316*d;

			//Rhea
			ra0[21] =40.38-0.036*t1 +3.10*sin_S6;
			dec0[21] =83.55-0.004*t1 -0.35*Math.cos(S6);
			w0[21] =235.16+79.6900478*d-3.08*sin_S6;

			//Titan
			ra0[22] =39.4827;
			dec0[22] = 83.4279;
			w0[22]=186.5855+22.5769768*d;

			//Hyperion no esta
			ra0[23] =39.4827;
			dec0[23] = 83.4279;
			w0[23]=186.5855+22.5769768*d;

			//Japeto
			ra0[24] =318.16-3.949*t1;
			dec0[24] =75.03-1.143*t1;
			w0[24] =355.2+4.5379572*d;

			//Febe
			ra0[25] =356.90;
			dec0[25] =77.80;
			w0[25]=178.58+931.639*d;

			//Jano
			ra0[26] =40.58-0.036*t1 -1.623*sin_S2+0.023*sin_2S2;
			dec0[26] =83.52-0.004*t1 -0.183*Math.cos(S2)+0.001*Math.cos(2*S2);
			w0[26]=58.83+518.2359876*d+1.613*sin_S2-0.023*sin_2S2;


			var U11,U12,U13,U14,U15,U16;
			U11 = 102.23 - 2024.22*t1;U11*=dtor;
			U12 = 316.41 + 2863.96*t1;U12*=dtor; 
			U13 = 304.01 - 51.9400*t1;U13*=dtor; 
			U14 = 308.71 - 93.1700*t1;U14*=dtor; 
			U15 = 340.82 - 75.3200*t1;U15*=dtor;
			U16 = 259.14 - 504.810*t1;U16*=dtor;

			var sin_U11=Math.sin(U11);
			var sin_2U11=Math.sin(2*U11);				
			var sin_U12=Math.sin(U12);
			var sin_U13=Math.sin(U13);
			var sin_U14=Math.sin(U14);
			var sin_U15=Math.sin(U15);
			var sin_U16=Math.sin(U16);


			//Ariel
			ra0[27] = 257.43 + 0.29*sin_U13;
			dec0[27] = -15.10 + 0.28*Math.cos(U13)
			w0[27] = 156.22 - 142.8356681*d + 0.05*sin_U12 + 0.08*sin_U13;

			//Umbriel 
			ra0[28] = 257.43 + 0.21*sin_U14;
			dec0[28] = -15.10 + 0.20*Math.cos(U14);
			w0[28] = 108.05 - 86.8688923*d - 0.09*sin_U12 + 0.06*sin_U14;

			//Titania 
			ra0[29] = 257.43 + 0.29*sin_U15;
			dec0[29] = -15.10 + 0.28*Math.cos(U15);
			w0[29] = 77.74 - 41.3514316*d + 0.08*sin_U15;

			//Oberon 
			ra0[30] = 257.43 + 0.16*sin_U16;
			dec0[30] = -15.10 + 0.16*Math.cos(U16);
			w0[30] = 6.77 - 26.7394932*d + 0.04*sin_U16;

			//Miranda 
			ra0[31] = 257.43 + 4.41*sin_U11 - 0.04*sin_2U11;
			dec0[31] = -15.08 + 4.25*Math.cos(U11) - 0.02*Math.cos(2*U11);
			w0[31] = 30.70 - 254.6906892*d - 1.27*sin_U12 + 0.15*Math.sin(2*U12) + 1.15*sin_U11 - 0.09*sin_2U11;


			var N0,N6,N7;

			N0=357.85+52.316*t1;N0*=dtor;
			N6=142.61+2824.6*t1;N6*=dtor;
			N7=177.85+52.316*t1;N7*=dtor;
			var sin_N0=Math.sin(N0);
			var sin_N6=Math.sin(N6);


			//Triton
			ra0[32]=299.36-32.35*Math.sin(N7)-6.28*Math.sin(2*N7)-2.08*Math.sin(3*N7);
			dec0[32]=41.17+22.55*Math.cos(N7)+2.10*Math.cos(2*N7)+0.55*Math.cos(3*N7);
			w0[32]=296.53-61.2572637*d+22.25*Math.sin(N7)+6.73*Math.sin(2*N7)
						+2.05*Math.sin(3*N7)+0.74*Math.sin(4*N7)+0.28*Math.sin(5*N7)
						+0.11*Math.sin(6*N7)+0.05*Math.sin(7*N7)+0.02*Math.sin(8*N7)
						+0.01*Math.sin(9*N7);

			//Nereid
			ra0[33]=0;
			dec0[33]=0;
			w0[33]=0;

			//Proteus
			ra0[34]=299.27+0.70*sin_N0-0.05*sin_N6;
			dec0[34]=42.91-0.51*Math.cos(N0)-0.04*Math.cos(N6);
			w0[34]=93.38+320.7654228*d-0.48*sin_N0+0.04*sin_N6;



			//Charon
			ra0[35]=132.993;dec0[35]=-6.163;w0[35]=122.695+56.3625225*d;


			//Corrección de nutación para La Tierra

			
			var nut_L=(280.4665+36000.7698*t1)*dtor;
			var nut_Lp=(218.3165+481267.8813*t1)*dtor;
			var nut_omega=(125.04452-1934.136261*t1+0.0020708*t1*t1+t1*t1*t1/450000)*dtor;
			var nut_delta_phi=(-17.20*Math.sin(nut_omega)-1.32*Math.sin(2*nut_L)
									-0.23*Math.sin(nut_Lp)+0.21*Math.sin(2*nut_omega))/3600.0*dtor;
			var nut_delta_ecl=(9.2*Math.cos(nut_omega)+0.57*Math.cos(2*nut_L)
									+0.1*Math.cos(2*nut_Lp)-0.09*Math.cos(2*nut_omega))/3600.0*dtor;
			


			var ra,dec,elon,elat,sin_ra;

			for (var i=0;i<n_objetos;i++) {
	
				ra=ra0[i]*dtor;
				dec=dec0[i]*dtor;
				sin_ra=Math.sin(ra);
				elon=Math.atan2(sin_ra*cosecl+Math.tan(dec)*sinecl,Math.cos(ra));
				elat=Math.asin(Math.sin(dec)*cosecl-Math.cos(dec)*sinecl*sin_ra);

				

				if (i==3) {
					elon=elon+nut_delta_phi;
					elat=elat+nut_delta_ecl;
				}
				

				planet_ori1[i]=(90.0-elat/dtor)*dtor;
				planet_ori2[i]=-(elon/dtor+270.0)*dtor;

				planet_w[i]=-(w0[i]+180)*dtor;

			}

		}


    </script>

   </body>

</html>
